# ===============================================================================
# PRAHO PLATFORM - SERVICES ARCHITECTURE MAKEFILE üèóÔ∏è
# ===============================================================================
# Enhanced for Platform/Portal separation with scoped PYTHONPATH security

.PHONY: help install dev dev-platform dev-portal dev-all test test-platform test-portal test-integration test-e2e test-security build-css migrate fixtures clean lint lint-platform lint-portal type-check pre-commit

# ===============================================================================
# SCOPED PYTHON ENVIRONMENTS üîí
# ===============================================================================

# Platform-specific Python with scoped PYTHONPATH (database access)
PYTHON_PLATFORM = cd services/platform && PYTHONPATH=$(PWD)/services/platform $(PWD)/.venv/bin/python
PYTHON_PLATFORM_MANAGE = $(PYTHON_PLATFORM) manage.py

# Portal-specific Python (NO PYTHONPATH - cannot import platform code)
PYTHON_PORTAL = cd services/portal && $(PWD)/.venv/bin/python
PYTHON_PORTAL_MANAGE = $(PYTHON_PORTAL) manage.py

# Shared Python for workspace-level tasks
PYTHON_SHARED = .venv/bin/python

# ===============================================================================
# HELP & SETUP üìñ
# ===============================================================================

help:
	@echo "üöÄ PRAHO Platform - Services Architecture"
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@echo "üèóÔ∏è  DEVELOPMENT SERVICES:"
	@echo "  make dev             - Run all services (platform + portal)"
	@echo "  make dev-platform    - Run platform service only (:8700)"
	@echo "  make dev-portal      - Run portal service only (:8701)"
	@echo ""
	@echo "üß™ TESTING (SERVICE-ISOLATED):"
	@echo "  make test            - Test all services (Django test runner)"
	@echo "  make test-platform   - Test platform service with DB access (Django)"
	@echo "  make test-platform-pytest - Test platform service with pytest"
	@echo "  make test-portal     - Test portal service (NO DB access)"
	@echo "  make test-integration - Test platform‚Üíportal API communication"
	@echo "  make test-e2e        - End-to-end tests across services"
	@echo "  make test-security   - Validate service isolation"
	@echo ""
	@echo "üîß DATABASE & ASSETS:"
	@echo "  make migrate         - Run platform database migrations"
	@echo "  make fixtures        - Load sample data (platform only)"
	@echo "  make build-css       - Build Tailwind CSS assets"
	@echo ""
	@echo "üßπ CODE QUALITY:"
	@echo "  make lint            - Lint all services"
	@echo "  make lint-platform   - Lint platform service only"
	@echo "  make lint-portal     - Lint portal service only"
	@echo "  make type-check      - Type check all services"
	@echo "  make pre-commit      - Run pre-commit hooks"
	@echo ""
	@echo "üîí SECURITY:"
	@echo "  make test-security   - Validate service isolation"
	@echo "  make lint-credentials - Check for hardcoded credentials"
	@echo ""
	@echo "üê≥ DOCKER DEPLOYMENT:"
	@echo "  make docker-build    - Build platform + portal Docker images"
	@echo "  make docker-dev      - Start development services with hot reload"
	@echo "  make docker-prod     - Start production services with nginx"
	@echo "  make docker-stop     - Stop all Docker services"
	@echo "  make docker-test     - Test Docker services health"
	@echo "  make docker-clean    - Clean up Docker containers and images"
	@echo ""
	@echo "‚öôÔ∏è  SETUP & MAINTENANCE:"
	@echo "  make install         - Set up development environment"
	@echo "  make clean           - Clean build artifacts"

# ===============================================================================
# DEVELOPMENT ENVIRONMENT SETUP üîß
# ===============================================================================

install:
	@echo "üîß Setting up PRAHO services development environment..."
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@echo "üì¶ Creating virtual environment..."
	python3 -m venv .venv
	.venv/bin/pip install --upgrade pip
	@echo ""
	@echo "üìã Installing platform dependencies (with database drivers)..."
	.venv/bin/pip install -r services/platform/requirements/dev.txt
	@echo ""
	@echo "üìã Installing portal dependencies (NO database drivers)..."
	.venv/bin/pip install -r services/portal/requirements.txt
	@echo ""
	@echo "‚úÖ Environment ready! Services isolated with scoped PYTHONPATH"
	@echo "üîí Security: Portal cannot import platform code"

# ===============================================================================
# DEVELOPMENT SERVERS üöÄ
# ===============================================================================

dev-platform:
	@echo "üèóÔ∏è [Platform] Starting admin platform service..."
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@echo "üìç PYTHONPATH: services/platform (scoped)"
	@echo "üóÑÔ∏è Running migrations..."
	@$(PYTHON_PLATFORM_MANAGE) migrate --settings=config.settings.dev
	@echo "üîß Setting up test data..."
	@$(PYTHON_PLATFORM) scripts/setup_test_data.py || echo "‚ö†Ô∏è Test data setup skipped"
	@echo "‚öôÔ∏è Setting up scheduled tasks..."
	@$(PYTHON_PLATFORM_MANAGE) setup_scheduled_tasks --settings=config.settings.dev || echo "‚ö†Ô∏è Scheduled tasks setup skipped"
	@echo "üöÄ Starting Django-Q2 workers in background..."
	@$(PYTHON_PLATFORM_MANAGE) qcluster --settings=config.settings.dev > django_q.log 2>&1 & 
	@QCLUSTER_PID=$$!; \
	echo "üìä Django-Q2 workers started (PID: $$QCLUSTER_PID)"; \
	echo "üåê Starting platform server on :8700..."; \
	trap 'echo "üõë Stopping Django-Q2 workers..."; kill $$QCLUSTER_PID 2>/dev/null || true' EXIT; \
	$(PYTHON_PLATFORM_MANAGE) runserver 0.0.0.0:8700 --settings=config.settings.dev

dev-portal:
	@echo "üåê [Portal] Starting customer portal service..."
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@echo "üîí NO PYTHONPATH - portal cannot import platform code"
	@echo "üîç Validating portal configuration..."
	@$(PYTHON_PORTAL_MANAGE) check
	@echo "‚úÖ Portal configuration valid"
	@echo "üåê Starting portal server on :8701..."
	@$(PYTHON_PORTAL_MANAGE) runserver 0.0.0.0:8701

dev-all:
	@echo "üöÄ [All Services] Starting platform + portal..."
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@$(MAKE) -j2 dev-platform dev-portal

dev:
	@$(MAKE) dev-all

# ===============================================================================
# TESTING WITH SERVICE ISOLATION üß™
# ===============================================================================

test-platform:
	@echo "üß™ [Platform] Testing with database cache (no Redis)..."
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@$(PYTHON_PLATFORM_MANAGE) test tests --settings=config.settings.test --verbosity=2 --parallel --keepdb
	@echo "‚úÖ Platform tests completed successfully!"

test-platform-pytest:
	@echo "üß™ [Platform] Testing with pytest (database cache)..."
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@cd services/platform && PYTHONPATH=$(PWD)/services/platform $(PWD)/.venv/bin/python -m pytest -v
	@echo "‚úÖ Platform pytest tests completed successfully!"

test-portal:
	@echo "üß™ [Portal] Testing without database access (strict isolation)..."
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@cd services/portal && env -u PYTHONPATH $(PWD)/.venv/bin/python -m pytest -v
	@echo "‚úÖ Portal tests completed - database access properly blocked!"

test-integration:
	@echo "üîÑ [Integration] Testing services communication and cache functionality..."
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@echo "üß™ Running integration tests..."
	@$(PWD)/.venv/bin/python -m pytest tests/integration/ -v
	@echo "‚úÖ Integration tests completed!"

test-cache:
	@echo "üíæ [Cache] Testing database cache functionality (post Redis removal)..."
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@$(PWD)/.venv/bin/python -m pytest tests/integration/test_database_cache.py -v -m cache
	@echo "‚úÖ Database cache tests passed!"

test-security:
	@echo "üîí [Security] Validating service isolation (no Redis dependencies)..."
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@echo "üß™ Testing portal cannot import platform code..."
	@cd services/portal && \
		if env -u PYTHONPATH $(PWD)/.venv/bin/python -c "import apps" 2>/dev/null; then \
			echo "‚ùå SECURITY BREACH: Portal can import platform!"; \
			exit 1; \
		else \
			echo "‚úÖ Portal properly isolated from platform"; \
		fi
	@echo "üß™ Testing platform uses database cache (base settings, not dev override)..."
	@cd services/platform && PYTHONPATH=$(PWD)/services/platform $(PWD)/.venv/bin/python -c "import os; os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings.base'); import django; django.setup(); from django.conf import settings; cache_backend = settings.CACHES['default']['BACKEND']; assert 'DatabaseCache' in cache_backend, f'Should use database cache, got: {cache_backend}'; print('‚úÖ Platform base settings use database cache')"
	@echo "üß™ Testing portal has NO database access..."
	@cd services/portal && env -u PYTHONPATH $(PWD)/.venv/bin/python -c "import os; os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings'); import django; django.setup(); from django.conf import settings; print('‚úÖ Portal isolated from DB:', not bool(getattr(settings, 'DATABASES', {})))"
	@echo "üß™ Running portal database access prevention test..."
	@cd services/portal && env -u PYTHONPATH $(PWD)/.venv/bin/python -m pytest conftest.py::test_db_access_blocked -v || echo "‚úÖ Database access properly blocked"
	@echo "üéâ All security isolation tests passed!"

test:
	@echo "üîÑ [All Tests] Running comprehensive test suite (post Redis removal)..."
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@echo "üìã Phase 1: Platform service tests (database cache)"
	@$(MAKE) test-platform
	@echo "üìã Phase 2: Portal service tests (database access blocked)"
	@$(MAKE) test-portal
	@echo "üìã Phase 3: Integration tests (services communication)"
	@$(MAKE) test-integration
	@echo "üìã Phase 4: Database cache functionality"
	@$(MAKE) test-cache
	@echo "üìã Phase 5: Security validation (service isolation)"
	@$(MAKE) test-security
	@echo "üéâ All test phases completed successfully!"

# ===============================================================================
# DATABASE & ASSETS üóÑÔ∏è
# ===============================================================================

migrate:
	@echo "üóÑÔ∏è [Platform] Running database migrations..."
	@$(PYTHON_PLATFORM_MANAGE) makemigrations --settings=config.settings.dev
	@$(PYTHON_PLATFORM_MANAGE) migrate --settings=config.settings.dev

fixtures:
	@echo "üìä [Platform] Loading sample data..."
	@$(PYTHON_PLATFORM_MANAGE) generate_sample_data --settings=config.settings.dev

# ===============================================================================
# CODE QUALITY üßπ
# ===============================================================================

lint-platform:
	@echo "üèóÔ∏è [Platform] Comprehensive code quality check..."
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@echo "üîç 1/3: Performance & Security Analysis (Ruff)..."
	@cd services/platform && $(PWD)/.venv/bin/ruff check . --statistics || echo "‚ö†Ô∏è Ruff check skipped"
	@echo ""
	@echo "üè∑Ô∏è  2/3: Type Safety Check (MyPy)..."
	@cd services/platform && PYTHONPATH=$(PWD)/services/platform $(PWD)/.venv/bin/mypy apps/ --config-file=../../pyproject.toml 2>/dev/null || echo "‚ö†Ô∏è MyPy check skipped"
	@echo ""
	@echo "üìä 3/3: Django Check..."
	@$(PYTHON_PLATFORM_MANAGE) check --deploy --settings=config.settings.dev
	@echo "‚úÖ Platform linting complete!"

lint-portal:
	@echo "üåê [Portal] Code quality check (NO database access)..."
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@echo "üîç 1/2: Performance & Security Analysis (Ruff)..."
	@cd services/portal && $(PWD)/.venv/bin/ruff check . --statistics || echo "‚ö†Ô∏è Ruff check skipped"
	@echo ""
	@echo "üìä 2/2: Django Check (NO DB)..."
	@$(PYTHON_PORTAL_MANAGE) check
	@echo "‚úÖ Portal linting complete!"

lint:
	@echo "üîÑ [All Services] Comprehensive linting..."
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@echo "üìã Phase 1: Platform service"
	@$(MAKE) lint-platform
	@echo "üìã Phase 2: Portal service"  
	@$(MAKE) lint-portal
	@echo "üéâ All services linting complete!"

lint-credentials:
	@echo "üîë [Credentials] Hardcoded credentials security check..."
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@echo "üèóÔ∏è  Platform service:"
	@cd services/platform && $(PWD)/.venv/bin/ruff check . --select=S105,S106,S107,S108 --output-format=concise || echo "‚ö†Ô∏è Credentials check skipped"
	@echo ""
	@echo "üåê Portal service:"
	@cd services/portal && $(PWD)/.venv/bin/ruff check . --select=S105,S106,S107,S108 --output-format=concise || echo "‚ö†Ô∏è Credentials check skipped"
	@echo "‚úÖ Credentials check complete!"

# ===============================================================================
# TYPE CHECKING üè∑Ô∏è
# ===============================================================================

type-check:
	@echo "üè∑Ô∏è [All Services] Comprehensive type checking..."
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@cd services/platform && PYTHONPATH=$(PWD)/services/platform $(PWD)/.venv/bin/mypy apps/ --config-file=../../pyproject.toml || echo "‚ö†Ô∏è MyPy not configured"
	@cd services/portal && $(PWD)/.venv/bin/mypy portal/ --config-file=../../pyproject.toml || echo "‚ö†Ô∏è MyPy not configured"
	@echo "üéâ All services type checking complete!"

# ===============================================================================
# PRE-COMMIT HOOKS üîó
# ===============================================================================

pre-commit:
	@echo "üîó Running pre-commit hooks across services..."
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@if ! command -v .venv/bin/pre-commit >/dev/null 2>&1; then \
		echo "‚ùå pre-commit not found. Installing..."; \
		.venv/bin/pip install pre-commit; \
		.venv/bin/pre-commit install || echo "‚ö†Ô∏è Pre-commit config not found"; \
	fi
	@.venv/bin/pre-commit run --all-files || echo "‚ö†Ô∏è Pre-commit hooks skipped"
	@echo "‚úÖ Pre-commit completed!"

# ===============================================================================
# BUILD & ASSETS üé®
# ===============================================================================

build-css:
	@echo "üé® Building Tailwind CSS assets..."
	npx tailwindcss -i static/src/styles.css -o static/dist/styles.css --watch

# ===============================================================================
# DOCKER SERVICES DEPLOYMENT üê≥
# ===============================================================================

docker-build:
	@echo "üê≥ [Docker] Building services images..."
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@echo "üèóÔ∏è  Building Platform service..."
	@docker build -f deploy/platform/Dockerfile -t praho-platform:latest .
	@echo ""
	@echo "üåê Building Portal service..."
	@docker build -f deploy/portal/Dockerfile -t praho-portal:latest .
	@echo "‚úÖ All service images built successfully!"

docker-dev:
	@echo "üöÄ [Docker] Starting development services (no Redis)..."
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@docker-compose -f deploy/docker-compose.dev.yml up --build

docker-prod:
	@echo "üåê [Docker] Starting production services (no Redis)..."
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@docker-compose -f deploy/docker-compose.services.yml up -d

docker-stop:
	@echo "üõë [Docker] Stopping all services..."
	@docker-compose -f deploy/docker-compose.dev.yml down || true
	@docker-compose -f deploy/docker-compose.services.yml down || true

docker-logs-platform:
	@echo "üìã [Docker] Platform service logs..."
	@docker-compose -f deploy/docker-compose.services.yml logs -f platform

docker-logs-portal:
	@echo "üìã [Docker] Portal service logs..."
	@docker-compose -f deploy/docker-compose.services.yml logs -f portal

docker-clean:
	@echo "üßπ [Docker] Cleaning up containers and images..."
	@docker-compose -f deploy/docker-compose.dev.yml down --volumes --rmi all || true
	@docker-compose -f deploy/docker-compose.services.yml down --volumes --rmi all || true
	@docker system prune -f

docker-test:
	@echo "üß™ [Docker] Testing services isolation (no Redis)..."
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@echo "üöÄ Building and starting services..."
	@docker-compose -f deploy/docker-compose.services.yml up -d --build
	@echo "‚è≥ Waiting for services to be healthy..."
	@sleep 30
	@echo "üß™ Testing platform service..."
	@curl -f http://localhost:8700/users/login/ || (echo "‚ùå Platform health check failed" && exit 1)
	@echo "‚úÖ Platform service healthy!"
	@echo "üß™ Testing portal service..."
	@curl -f http://localhost:8701/ || (echo "‚ùå Portal health check failed" && exit 1)
	@echo "‚úÖ Portal service healthy!"
	@echo "üß™ Testing nginx proxy..."
	@curl -f http://localhost/ || (echo "‚ùå Nginx proxy failed" && exit 1)
	@echo "‚úÖ All services are healthy!"
	@docker-compose -f deploy/docker-compose.services.yml down

clean:
	@echo "üßπ Cleaning build artifacts across services..."
	find . -type d -name "__pycache__" -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	rm -rf services/platform/htmlcov/
	rm -rf services/portal/htmlcov/
	rm -rf .coverage
	rm -rf .pytest_cache/
	rm -rf .mypy_cache/
	rm -rf services/platform/staticfiles/
	rm -rf services/portal/staticfiles/
