#!/bin/bash
# =============================================================================
# PRAHO Database Backup Script (Native PostgreSQL)
# Generated by Ansible - DO NOT EDIT
# =============================================================================

set -euo pipefail

BACKUP_DIR="{{ backup_directory }}"
RETENTION_DAYS={{ backup_retention_days }}
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/praho_backup_${TIMESTAMP}.dump"

echo "[$(date)] Starting native PostgreSQL backup..."

mkdir -p "${BACKUP_DIR}"

# Direct pg_dump (no Docker)
PGPASSWORD="{{ db_password }}" pg_dump \
    -h localhost \
    -U {{ db_user }} \
    -d {{ db_name }} \
    --format=custom \
    --compress=9 \
    -f "${BACKUP_FILE}"

if [ -f "${BACKUP_FILE}" ] && [ -s "${BACKUP_FILE}" ]; then
    echo "[$(date)] Backup created: ${BACKUP_FILE}"
    echo "[$(date)] Size: $(du -h "${BACKUP_FILE}" | cut -f1)"
else
    echo "[$(date)] ERROR: Backup failed!"
    exit 1
fi

# Cleanup old backups
echo "[$(date)] Cleaning up backups older than ${RETENTION_DAYS} days..."
find "${BACKUP_DIR}" -name "praho_backup_*.dump" -mtime +${RETENTION_DAYS} -delete

echo "[$(date)] Current backups:"
ls -lh "${BACKUP_DIR}"/praho_backup_*.dump 2>/dev/null || echo "No backups found"

echo "[$(date)] Backup completed successfully"
