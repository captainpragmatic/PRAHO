#!/bin/bash
# =============================================================================
# PRAHO Health Check Script (Native)
# Generated by Ansible - DO NOT EDIT
# =============================================================================

set -euo pipefail

ERRORS=0

check_service() {
    local name="$1"
    if systemctl is-active --quiet "$name"; then
        echo "  [OK] $name is running"
    else
        echo "  [FAIL] $name is NOT running"
        ERRORS=$((ERRORS + 1))
    fi
}

check_http() {
    local name="$1"
    local url="$2"
    if curl -sf --max-time 5 "$url" > /dev/null 2>&1; then
        echo "  [OK] $name responds at $url"
    else
        echo "  [FAIL] $name not responding at $url"
        ERRORS=$((ERRORS + 1))
    fi
}

echo "========================================"
echo "PRAHO Health Check (Native)"
echo "========================================"
echo ""

echo "Systemd Services:"
check_service postgresql
check_service praho-platform
check_service praho-portal
check_service praho-qcluster
check_service caddy

echo ""
echo "HTTP Endpoints:"
check_http "Platform" "http://localhost:{{ platform_port }}/health/"
check_http "Portal" "http://localhost:{{ portal_port }}/"

echo ""
if [ $ERRORS -eq 0 ]; then
    echo "All checks passed."
    exit 0
else
    echo "${ERRORS} check(s) failed!"
    exit 1
fi
