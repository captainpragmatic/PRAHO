#!/bin/bash
# =============================================================================
# PRAHO Database Restore Script (Native PostgreSQL)
# Generated by Ansible - DO NOT EDIT
# =============================================================================

set -euo pipefail

BACKUP_DIR="{{ backup_directory }}"
DB_NAME="{{ db_name }}"
DB_USER="{{ db_user }}"

usage() {
    echo "Usage: $0 [--latest | <backup_file>]"
    echo ""
    echo "Options:"
    echo "  --latest       Restore from the most recent backup"
    echo "  <backup_file>  Path to a specific .dump file"
    echo ""
    echo "Available backups:"
    ls -lht "${BACKUP_DIR}"/praho_backup_*.dump 2>/dev/null || echo "No backups found"
    exit 1
}

if [ $# -eq 0 ]; then
    usage
fi

if [ "$1" = "--latest" ]; then
    BACKUP_FILE=$(ls -t "${BACKUP_DIR}"/praho_backup_*.dump 2>/dev/null | head -1)
    if [ -z "${BACKUP_FILE}" ]; then
        echo "ERROR: No backups found in ${BACKUP_DIR}"
        exit 1
    fi
else
    BACKUP_FILE="$1"
    if [ ! -f "${BACKUP_FILE}" ]; then
        if [ -f "${BACKUP_DIR}/${BACKUP_FILE}" ]; then
            BACKUP_FILE="${BACKUP_DIR}/${BACKUP_FILE}"
        else
            echo "ERROR: Backup file not found: ${BACKUP_FILE}"
            usage
        fi
    fi
fi

echo "========================================"
echo "PRAHO Database Restore (Native)"
echo "========================================"
echo "Backup file: ${BACKUP_FILE}"
echo ""
echo "WARNING: This will OVERWRITE the current database!"
read -p "Are you sure? (yes/no): " CONFIRM

if [ "${CONFIRM}" != "yes" ]; then
    echo "Restore cancelled."
    exit 0
fi

echo ""
echo "[$(date)] Creating pre-restore backup..."
{{ project_root }}/scripts/backup.sh || echo "Warning: Pre-restore backup failed"

echo "[$(date)] Stopping application services..."
systemctl stop praho-qcluster praho-portal praho-platform 2>/dev/null || true

echo "[$(date)] Dropping and recreating database..."
sudo -u postgres dropdb --if-exists "${DB_NAME}"
sudo -u postgres createdb -O "${DB_USER}" "${DB_NAME}"

echo "[$(date)] Restoring database from backup..."
PGPASSWORD="{{ db_password }}" pg_restore \
    -h localhost \
    -U "${DB_USER}" \
    -d "${DB_NAME}" \
    --no-owner \
    --no-privileges \
    "${BACKUP_FILE}"

echo "[$(date)] Starting application services..."
systemctl start praho-platform praho-portal praho-qcluster

echo "[$(date)] Waiting for services to be healthy..."
sleep 5

echo "[$(date)] Restore completed successfully"
