#!/bin/bash
# =============================================================================
# PRAHO Rollback Script
# Generated by Ansible
# =============================================================================

set -euo pipefail

PROJECT_ROOT="{{ project_root }}"
BACKUP_DIR="{{ backup_directory }}"

usage() {
    echo "Usage: $0 [version|latest-backup]"
    echo ""
    echo "Options:"
    echo "  <version>       Roll back to a specific version (e.g., v1.2.3)"
    echo "  latest-backup   Restore the latest database backup"
    echo ""
    echo "Examples:"
    echo "  $0 v1.2.3        # Roll back to version v1.2.3"
    echo "  $0 latest-backup # Restore latest database backup"
    exit 1
}

if [ $# -eq 0 ]; then
    usage
fi

ACTION="$1"

cd "${PROJECT_ROOT}"

if [ "${ACTION}" == "latest-backup" ]; then
    echo "========================================"
    echo "PRAHO Database Rollback"
    echo "========================================"

    LATEST_BACKUP=$(ls -t "${BACKUP_DIR}"/praho_backup_*.sql.gz 2>/dev/null | head -n1)

    if [ -z "${LATEST_BACKUP}" ]; then
        echo "ERROR: No backups found in ${BACKUP_DIR}"
        exit 1
    fi

    echo "Latest backup: ${LATEST_BACKUP}"
    ./scripts/restore.sh "${LATEST_BACKUP}"
else
    VERSION="${ACTION}"

    echo "========================================"
    echo "PRAHO Version Rollback"
    echo "========================================"
    echo "Rolling back to version: ${VERSION}"
    echo ""

    read -p "Are you sure? (yes/no): " CONFIRM
    if [ "${CONFIRM}" != "yes" ]; then
        echo "Rollback cancelled."
        exit 0
    fi

    echo "[$(date)] Creating pre-rollback backup..."
    ./scripts/backup.sh || echo "Warning: Pre-rollback backup failed"

    echo "[$(date)] Pulling version ${VERSION}..."
    export VERSION="${VERSION}"

    echo "[$(date)] Stopping current services..."
    docker compose down

    echo "[$(date)] Starting version ${VERSION}..."
    docker compose up -d

    echo "[$(date)] Waiting for services..."
    sleep 15

    # Health check
    if curl -sf http://localhost:{{ platform_port }}/health/ > /dev/null; then
        echo "[$(date)] Rollback successful! Services are healthy."
    else
        echo "[$(date)] WARNING: Health check failed. Check logs with: docker compose logs"
    fi
fi
