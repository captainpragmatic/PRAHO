#!/bin/bash
# =============================================================================
# PRAHO Database Backup Script
# Generated by Ansible
# =============================================================================

set -euo pipefail

BACKUP_DIR="{{ backup_directory }}"
RETENTION_DAYS={{ backup_retention_days }}
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/praho_backup_${TIMESTAMP}.sql.gz"

echo "[$(date)] Starting backup..."

# Create backup directory if it doesn't exist
mkdir -p "${BACKUP_DIR}"

# Perform backup
docker exec praho_db pg_dump -U {{ db_user }} {{ db_name }} | gzip > "${BACKUP_FILE}"

# Verify backup
if [ -f "${BACKUP_FILE}" ] && [ -s "${BACKUP_FILE}" ]; then
    echo "[$(date)] Backup created: ${BACKUP_FILE}"
    echo "[$(date)] Size: $(du -h ${BACKUP_FILE} | cut -f1)"
else
    echo "[$(date)] ERROR: Backup failed!"
    exit 1
fi

# Cleanup old backups
echo "[$(date)] Cleaning up backups older than ${RETENTION_DAYS} days..."
find "${BACKUP_DIR}" -name "praho_backup_*.sql.gz" -mtime +${RETENTION_DAYS} -delete

# List current backups
echo "[$(date)] Current backups:"
ls -lh "${BACKUP_DIR}"/praho_backup_*.sql.gz 2>/dev/null || echo "No backups found"

echo "[$(date)] Backup completed successfully"
