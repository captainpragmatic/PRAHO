#!/bin/bash
# =============================================================================
# PRAHO Database Restore Script
# Generated by Ansible
# =============================================================================

set -euo pipefail

BACKUP_DIR="{{ backup_directory }}"

usage() {
    echo "Usage: $0 <backup_file>"
    echo ""
    echo "Available backups:"
    ls -lh "${BACKUP_DIR}"/praho_backup_*.sql.gz 2>/dev/null || echo "No backups found"
    exit 1
}

if [ $# -eq 0 ]; then
    usage
fi

BACKUP_FILE="$1"

# Check if backup file exists
if [ ! -f "${BACKUP_FILE}" ]; then
    # Try with backup directory prefix
    if [ -f "${BACKUP_DIR}/${BACKUP_FILE}" ]; then
        BACKUP_FILE="${BACKUP_DIR}/${BACKUP_FILE}"
    else
        echo "ERROR: Backup file not found: ${BACKUP_FILE}"
        usage
    fi
fi

echo "========================================"
echo "PRAHO Database Restore"
echo "========================================"
echo "Backup file: ${BACKUP_FILE}"
echo ""
echo "WARNING: This will OVERWRITE the current database!"
read -p "Are you sure? (yes/no): " CONFIRM

if [ "${CONFIRM}" != "yes" ]; then
    echo "Restore cancelled."
    exit 0
fi

echo ""
echo "[$(date)] Creating pre-restore backup..."
./backup.sh || echo "Warning: Pre-restore backup failed"

echo "[$(date)] Stopping services..."
cd {{ project_root }}
docker compose stop platform portal 2>/dev/null || true

echo "[$(date)] Restoring database..."
gunzip -c "${BACKUP_FILE}" | docker exec -i praho_db psql -U {{ db_user }} {{ db_name }}

echo "[$(date)] Starting services..."
docker compose up -d

echo "[$(date)] Waiting for services to be healthy..."
sleep 10

echo "[$(date)] Restore completed successfully"
