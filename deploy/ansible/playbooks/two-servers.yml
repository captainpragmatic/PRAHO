# =============================================================================
# PRAHO - Two Server Deployment Playbook
# =============================================================================
# Deploys Platform + DB on primary server, Portal on secondary server
#
# Usage:
#   ansible-playbook -i inventory/two-servers.yml playbooks/two-servers.yml
#
# Required environment variables:
#   PRAHO_PLATFORM_IP, PRAHO_PORTAL_IP, PRAHO_DOMAIN, PRAHO_DB_PASSWORD, PRAHO_SECRET_KEY

---
- name: Deploy PRAHO - Primary Server (Platform + DB)
  hosts: primary
  become: yes
  gather_facts: yes

  vars:
    deploy_platform: true
    deploy_portal: false
    deploy_database: true
    deploy_caddy: true

  pre_tasks:
    - name: Validate required variables
      assert:
        that:
          - domain is defined and domain != 'praho.example.com'
          - db_password is defined and db_password != 'changeme'
          - secret_key is defined and secret_key != 'generate-a-strong-key'
        fail_msg: "Required variables not set. Check environment variables."

  roles:
    - common
    - docker
    - praho

  post_tasks:
    - name: Run database migrations
      command: docker exec praho_platform python manage.py migrate --noinput

    - name: Collect static files
      command: docker exec praho_platform python manage.py collectstatic --noinput

    - name: Get platform API URL for portal
      set_fact:
        platform_api_url: "https://{{ domain }}/api"
      delegate_to: localhost
      delegate_facts: true


- name: Deploy PRAHO - Secondary Server (Portal)
  hosts: secondary
  become: yes
  gather_facts: yes

  vars:
    deploy_platform: false
    deploy_portal: true
    deploy_database: false
    deploy_caddy: true
    platform_api_url: "https://{{ hostvars['platform-server']['domain'] }}/api"

  pre_tasks:
    - name: Validate required variables
      assert:
        that:
          - domain is defined
          - secret_key is defined
          - platform_api_url is defined
        fail_msg: "Required variables not set."

  roles:
    - common
    - docker
    - praho

  post_tasks:
    - name: Verify portal can reach platform
      uri:
        url: "{{ platform_api_url }}"
        status_code: [200, 301, 302, 404]
      register: api_check
      retries: 3
      delay: 5
