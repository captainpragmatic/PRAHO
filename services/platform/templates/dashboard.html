{% extends 'base.html' %}
{% load ui_components %}
{% load i18n %}

{% block title %}{% trans 'Dashboard' %} - PRAHO Platform{% endblock %}

{% block content %}
<div class="py-6">
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-white">
      {% if user.is_staff %}
      ğŸš€ {% trans 'Dashboard PragmaticHost' %}
      {% else %}
      {% if user.first_name %}
        {% blocktrans with first_name=user.first_name %}ğŸ‘‹ Welcome {{ first_name }}{% endblocktrans %}
      {% else %}
        ğŸ‘‹ {% trans 'Welcome' %}
      {% endif %}
      {% endif %}
    </h1>
    <p class="mt-2 text-slate-400">
      {% if user.is_staff %}
      {% blocktrans with first_name=user.first_name|default:user.username %}Hello, {{ first_name }}! Here is an overview of your business activity.{% endblocktrans %}
      {% else %}
      {% trans 'Here is an overview of your hosting services and account.' %}
      {% endif %}
    </p>
  </div>

  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    {% if user.is_staff %}
    <!-- Staff View: Business Metrics -->
    <!-- Total Customers -->
    <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 text-2xl">ğŸ‘¥</div>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-slate-400">{% trans 'Active Customers' %}</p>
          <p class="text-2xl font-semibold text-white">{{ stats.total_customers }}</p>
        </div>
      </div>
    </div>

    <!-- Monthly Revenue -->
    <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 text-2xl">ğŸ’°</div>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-slate-400">{% trans 'Monthly Revenue' %}</p>
          <p class="text-2xl font-semibold text-white">{{ stats.monthly_revenue|floatformat:0 }} RON</p>
        </div>
      </div>
    </div>

    <!-- Open Tickets -->
    <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 text-2xl">ğŸ«</div>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-slate-400">{% trans 'Open Tickets' %}</p>
          <p class="text-2xl font-semibold text-white">{{ stats.open_tickets }}</p>
        </div>
      </div>
    </div>

    <!-- Active Services -->
    <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 text-2xl">ğŸš€</div>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-slate-400">{% trans 'Active Services' %}</p>
          <p class="text-2xl font-semibold text-white">{{ stats.active_services }}</p>
        </div>
      </div>
    </div>
    {% else %}
    <!-- Customer View: Their Account Metrics -->
    <!-- My Services -->
    <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 text-2xl">ğŸš€</div>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-slate-400">{% trans 'My Services' %}</p>
          <p class="text-2xl font-semibold text-white">{{ stats.active_services }}</p>
        </div>
      </div>
    </div>

    <!-- My Tickets -->
    <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 text-2xl">ğŸ«</div>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-slate-400">{% trans 'My Open Tickets' %}</p>
          <p class="text-2xl font-semibold text-white">{{ stats.open_tickets }}</p>
        </div>
      </div>
    </div>

    <!-- Account Status -->
    <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 text-2xl">âœ…</div>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-slate-400">{% trans 'Account Status' %}</p>
          <p class="text-2xl font-semibold text-green-400">{% trans 'Active' %}</p>
        </div>
      </div>
    </div>

    <!-- Next Invoice -->
    <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 text-2xl">ğŸ“‹</div>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-slate-400">{% trans 'Next Billing' %}</p>
          <p class="text-sm font-semibold text-white">{% trans 'End of Month' %}</p>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Main Content Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Recent Documents -->
    <div class="bg-slate-800 rounded-lg border border-slate-700">
      <div class="p-6">
        <h3 class="text-lg font-medium text-white mb-4">
          {% if user.is_staff %}
          ğŸ§¾ {% trans 'Recent Invoices & Proformas' %}
          {% else %}
          ğŸ§¾ {% trans 'My Recent Invoices & Proformas' %}
          {% endif %}
        </h3>

        <div class="space-y-3">
          {% for document in recent_documents %}
          {% if document.document_type == 'invoice' %}
          <a href="{% url 'billing:invoice_detail' document.id %}" class="block group">
          {% else %}
          <a href="{% url 'billing:proforma_detail' document.id %}" class="block group">
          {% endif %}
            <div class="p-3 bg-slate-700 rounded-md hover:bg-slate-600 transition-colors border border-transparent hover:border-slate-500">
              <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                  {% if user.is_staff %}
                  <p class="text-white font-medium group-hover:text-blue-400 transition-colors leading-5">{{ document.customer.company_name }}</p>
                  {% else %}
                  <p class="text-white font-medium group-hover:text-blue-400 transition-colors leading-5">
                    {% if document.document_type == 'invoice' %}
                    {% trans 'Invoice' %} #{{ document.number }}
                    {% else %}
                    {% trans 'Proforma' %} #{{ document.number }}
                    {% endif %}
                  </p>
                  {% endif %}
                </div>
                <div class="ml-2 flex-shrink-0">
                  {% if document.status == 'paid' %}
                    {% badge "Paid" variant="success" icon="âœ…" css_class="w-20 justify-center" %}
                  {% elif document.status == 'overdue' %}
                    {% badge "Overdue" variant="danger" icon="âŒ" css_class="w-20 justify-center" %}
                  {% elif document.document_type == 'proforma' %}
                    {% badge "Draft" variant="info" icon="ğŸ“" css_class="w-20 justify-center" %}
                  {% else %}
                    {% badge "Pending" variant="warning" icon="â³" css_class="w-20 justify-center" %}
                  {% endif %}
                </div>
              </div>
              <div class="flex items-center justify-between mt-1">
                <div class="text-slate-400 text-sm leading-4">
                  {% if user.is_staff %}
                    {% if document.document_type == 'invoice' %}
                    {% trans 'Invoice' %} #{{ document.number }} - {{ document.created_at|date:"d.m.Y" }}
                    {% else %}
                    {% trans 'Proforma' %} #{{ document.number }} - {{ document.created_at|date:"d.m.Y" }}
                    {% endif %}
                  {% else %}
                  {{ document.created_at|date:"d.m.Y" }}
                  {% endif %}
                </div>
                <div class="text-white font-medium text-sm leading-4">
                  {{ document.total|floatformat:2 }} {{ document.currency.code }}
                </div>
              </div>
            </div>
          </a>
          {% empty %}
          <p class="text-slate-400 text-center py-4">
            {% if user.is_staff %}
            {% trans 'No recent documents' %}
            {% else %}
            {% trans 'No recent documents found' %}
            {% endif %}
          </p>
          {% endfor %}
        </div>

        <div class="mt-4 text-center">
          <a href="{% url 'billing:invoice_list' %}" class="inline-flex items-center text-blue-400 hover:text-blue-300">
            {% trans 'View all' %} â†’
          </a>
        </div>
      </div>
    </div>

    <!-- Recent Tickets -->
    <div class="bg-slate-800 rounded-lg border border-slate-700">
      <div class="p-6">
        <h3 class="text-lg font-medium text-white mb-4">
          {% if user.is_staff %}
          ğŸ« {% trans 'Recent Tickets' %}
          {% else %}
          ğŸ« {% trans 'My Recent Tickets' %}
          {% endif %}
        </h3>

        <div class="space-y-3">
          {% for ticket in recent_tickets %}
          <a href="{% url 'tickets:detail' ticket.id %}" class="block group">
            <div class="p-3 bg-slate-700 rounded-md hover:bg-slate-600 transition-colors border border-transparent hover:border-slate-500">
              <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                  {% if user.is_staff %}
                  <p class="text-white font-medium group-hover:text-blue-400 transition-colors leading-5">{{ ticket.customer.company_name }}</p>
                  {% else %}
                  <p class="text-white font-medium group-hover:text-blue-400 transition-colors leading-5 truncate">{{ ticket.title }}</p>
                  {% endif %}
                </div>
                <div class="ml-2 flex-shrink-0">
                  {% if ticket.status == 'open' %}
                    {% badge "Open" variant="info" icon="ğŸ“‚" css_class="w-32 justify-center" %}
                  {% elif ticket.status == 'in_progress' %}
                    {% badge "In Progress" variant="primary" icon="âš¡" css_class="w-32 justify-center" %}
                  {% elif ticket.status == 'waiting_on_customer' %}
                    {% badge "Waiting on Customer" variant="warning" icon="â³" css_class="w-44 justify-center text-xs whitespace-nowrap" %}
                  {% elif ticket.status == 'closed' %}
                    {% badge "Closed" variant="secondary" icon="ğŸ“" css_class="w-32 justify-center" %}
                  {% else %}
                    {% badge ticket.status|capfirst variant="default" css_class="w-32 justify-center" %}
                  {% endif %}
                </div>
              </div>
              <div class="flex items-center justify-between mt-1">
                <div class="text-slate-400 text-sm leading-4">
                  {% if user.is_staff %}
                  {{ ticket.title|truncatechars:40 }}
                  {% else %}
                  {{ ticket.created_at|date:"d.m.Y" }}
                  {% endif %}
                </div>
                <div class="text-slate-400 text-sm leading-4">
                  {% if user.is_staff %}
                  {{ ticket.created_at|date:"d.m.Y" }}
                  {% else %}
                  #{{ ticket.ticket_number }}
                  {% endif %}
                </div>
              </div>
            </div>
          </a>
          {% empty %}
          <p class="text-slate-400 text-center py-4">
            {% if user.is_staff %}
            {% trans 'No recent tickets' %}
            {% else %}
            {% trans 'No recent support tickets' %}
            {% endif %}
          </p>
          {% endfor %}
        </div>

        <div class="mt-4 text-center">
          <a href="{% url 'tickets:list' %}" class="inline-flex items-center text-blue-400 hover:text-blue-300">
            {% trans 'View all' %} â†’
          </a>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-slate-800 rounded-lg border border-slate-700">
      <div class="p-6">
        <h3 class="text-lg font-medium text-white mb-4">
          âš¡ {% trans 'Quick Actions' %}
        </h3>

        {% if user.is_staff %}
        <!-- Staff Actions: Business Management -->
        <div class="grid grid-cols-2 gap-3">
          {% url 'customers:create' as create_customer_url %}
          {% url 'billing:proforma_create' as create_proforma_url %}
          {% url 'tickets:create' as create_ticket_url %}
          {% url 'provisioning:service_create' as create_service_url %}

          <a href="{{ create_customer_url }}" class="inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-red-600 border border-red-600 rounded-lg hover:bg-red-700 focus:ring-4 focus:ring-red-300 transition-all duration-200">
            ğŸ‘¤ {% trans 'New Customer' %}
          </a>
          <a href="{{ create_proforma_url }}" class="inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-green-600 border border-green-600 rounded-lg hover:bg-green-700 focus:ring-4 focus:ring-green-300 transition-all duration-200">
            ğŸ“„ {% trans 'New Proforma' %}
          </a>
          <a href="{{ create_ticket_url }}" class="inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-slate-600 border border-slate-600 rounded-lg hover:bg-slate-700 focus:ring-4 focus:ring-slate-300 transition-all duration-200">
            ğŸ« {% trans 'New Ticket' %}
          </a>
          <a href="{{ create_service_url }}" class="inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-yellow-500 border border-yellow-500 rounded-lg hover:bg-yellow-600 focus:ring-4 focus:ring-yellow-300 transition-all duration-200">
            ğŸš€ {% trans 'New Service' %}
          </a>
        </div>
        {% else %}
        <!-- Customer Actions: Self-Service -->
        <div class="grid grid-cols-2 gap-3">
          {% url 'tickets:create' as create_ticket_url %}
          {% url 'billing:invoice_list' as invoice_list_url %}
          {% url 'provisioning:services' as services_url %}
          {% url 'users:user_profile' as profile_url %}

          <a href="{{ create_ticket_url }}" class="inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-red-600 border border-red-600 rounded-lg hover:bg-red-700 focus:ring-4 focus:ring-red-300 transition-all duration-200">
            ğŸ« {% trans 'New Ticket' %}
          </a>
          <a href="{{ invoice_list_url }}" class="inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-green-600 border border-green-600 rounded-lg hover:bg-green-700 focus:ring-4 focus:ring-green-300 transition-all duration-200">
            ğŸ“„ {% trans 'View Invoices' %}
          </a>
          <a href="{{ services_url }}" class="inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-slate-600 border border-slate-600 rounded-lg hover:bg-slate-700 focus:ring-4 focus:ring-slate-300 transition-all duration-200">
            ğŸš€ {% trans 'My Services' %}
          </a>
          <a href="{{ profile_url }}" class="inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-yellow-500 border border-yellow-500 rounded-lg hover:bg-yellow-600 focus:ring-4 focus:ring-yellow-300 transition-all duration-200">
            ğŸ‘¤ {% trans 'My Profile' %}
          </a>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- System Status / Account Information -->
    <div class="bg-slate-800 rounded-lg border border-slate-700">
      <div class="p-6">
        <h3 class="text-lg font-medium text-white mb-4">
          {% if user.is_staff %}
          ğŸ“Š {% trans 'System Status' %}
          {% else %}
          ğŸ¢ {% trans 'Account Information' %}
          {% endif %}
        </h3>

        {% if user.is_staff %}
        <!-- Staff: System Status -->
        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <span class="text-slate-300">{% trans 'Server Status' %}</span>
            <span class="inline-flex items-center text-green-400">
              âœ… {% trans 'Online' %}
            </span>
          </div>

          <div class="flex items-center justify-between">
            <span class="text-slate-300">{% trans 'Backup Status' %}</span>
            <span class="inline-flex items-center text-green-400">
              âœ… {% trans 'Up-to-date' %}
            </span>
          </div>

          <div class="flex items-center justify-between">
            <span class="text-slate-300">e-Factura API</span>
            <span class="inline-flex items-center text-green-400">
              âœ… {% trans 'Connected' %}
            </span>
          </div>

          <div class="flex items-center justify-between">
            <span class="text-slate-300">{% trans 'Payment Gateway' %}</span>
            <span class="inline-flex items-center text-green-400">
              âœ… {% trans 'Functional' %}
            </span>
          </div>
        </div>

        <div class="mt-4 pt-4 border-t border-slate-700">
          <p class="text-slate-400 text-xs">
            {% trans 'Last update' %}: {{ current_time|date:"d.m.Y H:i" }}
          </p>
        </div>
        {% else %}
        <!-- Customer: Account Information -->
        <div class="space-y-3">
          {% if user.primary_customer %}
          <div class="flex items-center justify-between">
            <span class="text-slate-300">{% trans 'Customer name' %}</span>
            <span class="text-white font-medium">{{ user.primary_customer.company_name }}</span>
          </div>

          {% if user.primary_customer.tax_profile.vat_number %}
          <div class="flex items-center justify-between">
            <span class="text-slate-300">{% trans 'VAT Number (CNP if Individual)' %}</span>
            <span class="text-white">{{ user.primary_customer.tax_profile.vat_number }}</span>
          </div>
          {% endif %}

          <div class="flex items-center justify-between">
            <span class="text-slate-300">{% trans 'Customer Since' %}</span>
            <span class="text-white">{{ user.primary_customer.created_at|date:"M Y" }}</span>
          </div>
          {% endif %}
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  </div>

</div>
</div>
{% endblock %}
