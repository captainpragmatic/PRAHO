{% load i18n %}
{% load ui_components %}

<!-- Header with dynamic count -->
<div class="px-6 py-4 border-b border-slate-700">
  <h3 class="text-lg font-medium text-white">
    üì¶ {% trans 'Products' %}
    <span class="text-slate-400">
      {% if products %}
        {% with start=products.start_index end=products.end_index total=products.paginator.count %}
          ({{ start }}-{{ end }} of {{ total }})
        {% endwith %}
      {% else %}
        (0)
      {% endif %}
    </span>
  </h3>
</div>

<!-- Products Content -->
{% if products %}
  <!-- Desktop Table (hidden on mobile) -->
  <div class="hidden lg:block overflow-x-auto">
    <table class="min-w-full divide-y divide-slate-700">
      <thead class="bg-slate-750">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
            {% trans 'Product' %}
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
            {% trans 'Type' %}
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
            {% trans 'Status' %}
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
            {% trans 'Pricing' %}
          </th>
          <th class="px-6 py-3 text-right text-xs font-medium text-slate-300 uppercase tracking-wider">
            {% trans 'Actions' %}
          </th>
        </tr>
      </thead>
      <tbody class="bg-slate-800 divide-y divide-slate-700">
        {% for product in products %}
          <tr class="hover:bg-slate-750 transition-colors">
            <!-- Product Info -->
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div>
                  <div class="text-sm font-medium text-white">
                    <a href="{% url 'products:product_detail' slug=product.slug %}"
                       class="hover:text-blue-400 transition-colors">
                      {{ product.name }}
                    </a>
                    {% if product.is_featured %}
                      <span class="ml-2 text-yellow-400" title="{% trans 'Featured Product' %}">‚≠ê</span>
                    {% endif %}
                  </div>
                  <div class="text-sm text-slate-400">
                    {{ product.slug }}
                    {% if product.short_description %}
                      - {{ product.short_description|truncatechars:50 }}
                    {% endif %}
                  </div>
                </div>
              </div>
            </td>

            <!-- Product Type -->
            <td class="px-6 py-4 whitespace-nowrap">
              {% badge product.get_product_type_display variant="secondary" %}
            </td>

            <!-- Status Badges -->
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex flex-wrap gap-1">
                <!-- Active Status Toggle -->
                <button class="toggle-switch"
                        hx-post="{% url 'products:product_toggle_active' slug=product.slug %}"
                        hx-target="this"
                        hx-swap="outerHTML"
                        title="{% trans 'Toggle Active Status' %}">
                  {% if product.is_active %}
                    {% trans "Active" as bt1 %}{% badge bt1 variant="success" %}
                  {% else %}
                    {% trans "Inactive" as bt2 %}{% badge bt2 variant="danger" %}
                  {% endif %}
                </button>

                <!-- Public Status Toggle -->
                <button class="toggle-switch"
                        hx-post="{% url 'products:product_toggle_public' slug=product.slug %}"
                        hx-target="this"
                        hx-swap="outerHTML"
                        title="{% trans 'Toggle Public Visibility' %}">
                  {% if product.is_public %}
                    {% trans "Public" as bt3 %}{% badge bt3 variant="info" %}
                  {% else %}
                    {% trans "Private" as bt4 %}{% badge bt4 variant="warning" %}
                  {% endif %}
                </button>
              </div>
            </td>

            <!-- Pricing Info -->
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-300">
              {% with active_prices=product.get_active_prices %}
                {% if active_prices %}
                  <div class="space-y-1">
                    {% for price in active_prices|slice:":2" %}
                      <div class="space-y-1">
                        <div class="flex items-center justify-between">
                          <span class="text-xs text-slate-400">{{ price.currency.code }}</span>
                          <span class="font-medium">{{ price.monthly_price|floatformat:0 }}</span>
                          <span class="text-xs text-slate-400">{% trans 'monthly' %}</span>
                        </div>
                        {% if price.semiannual_discount_percent > 0 or price.annual_discount_percent > 0 %}
                          <div class="text-xs text-green-400">
                            {% if price.semiannual_discount_percent > 0 %}
                              {{ price.semiannual_discount_percent }}% {% trans 'off 6mo' %}
                            {% endif %}
                            {% if price.annual_discount_percent > 0 %}
                              {{ price.annual_discount_percent }}% {% trans 'off annual' %}
                            {% endif %}
                          </div>
                        {% endif %}
                      </div>
                    {% endfor %}
                    {% if active_prices|length > 1 %}
                      <div class="text-xs text-slate-500">
                        +{{ active_prices|length|add:"-1" }} {% trans 'more currencies' %}
                      </div>
                    {% endif %}
                  </div>
                {% else %}
                  <span class="text-slate-500 italic">{% trans 'No pricing set' %}</span>
                {% endif %}
              {% endwith %}
            </td>

            <!-- Actions -->
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <div class="flex items-center justify-end space-x-2">
                <!-- View Detail -->
                <a href="{% url 'products:product_detail' slug=product.slug %}"
                   class="text-blue-400 hover:text-blue-300 transition-colors"
                   title="{% trans 'View Details' %}">
                  üîç
                </a>

                <!-- Edit Product -->
                <a href="{% url 'products:product_edit' slug=product.slug %}"
                   class="text-green-400 hover:text-green-300 transition-colors"
                   title="{% trans 'Edit Product' %}">
                  ‚úèÔ∏è
                </a>

                <!-- Manage Pricing -->
                <a href="{% url 'products:product_prices' slug=product.slug %}"
                   class="text-yellow-400 hover:text-yellow-300 transition-colors"
                   title="{% trans 'Manage Pricing' %}">
                  üí∞
                </a>
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Mobile Card Layout (visible on mobile/tablet) -->
  <div class="lg:hidden space-y-4 p-4">
    {% for product in products %}
      <div class="bg-slate-750 rounded-lg border border-slate-600 p-4 hover:bg-slate-700 transition-colors">
        <!-- Product Header -->
        <div class="mb-3">
          <div class="flex items-start justify-between mb-2">
            <a href="{% url 'products:product_detail' slug=product.slug %}"
               class="text-lg font-medium text-white hover:text-blue-400 transition-colors block">
              {{ product.name }}
              {% if product.is_featured %}
                <span class="text-yellow-400 ml-2" title="{% trans 'Featured Product' %}">‚≠ê</span>
              {% endif %}
            </a>
          </div>
          <p class="text-sm text-slate-400 mb-2">{{ product.slug }}</p>
          {% if product.short_description %}
            <p class="text-sm text-slate-300 mb-3 line-clamp-2">{{ product.short_description }}</p>
          {% endif %}
        </div>

        <!-- Badges Row -->
        <div class="flex flex-wrap gap-2 mb-3">
          {% badge product.get_product_type_display variant="secondary" %}

          <!-- Active Status Toggle -->
          <button class="toggle-switch"
                  hx-post="{% url 'products:product_toggle_active' slug=product.slug %}"
                  hx-target="this"
                  hx-swap="outerHTML"
                  title="{% trans 'Toggle Active Status' %}">
            {% if product.is_active %}
              {% trans "Active" as bt5 %}{% badge bt5 variant="success" %}
            {% else %}
              {% trans "Inactive" as bt6 %}{% badge bt6 variant="danger" %}
            {% endif %}
          </button>

          <!-- Public Status Toggle -->
          <button class="toggle-switch"
                  hx-post="{% url 'products:product_toggle_public' slug=product.slug %}"
                  hx-target="this"
                  hx-swap="outerHTML"
                  title="{% trans 'Toggle Public Visibility' %}">
            {% if product.is_public %}
              {% trans "Public" as bt7 %}{% badge bt7 variant="info" %}
            {% else %}
              {% trans "Private" as bt8 %}{% badge bt8 variant="warning" %}
            {% endif %}
          </button>
        </div>

        <!-- Pricing Section -->
        <div class="bg-slate-800 rounded-md p-3 mb-3">
          <h4 class="text-sm font-medium text-slate-300 mb-2">{% trans 'Pricing' %}</h4>
          {% with active_prices=product.get_active_prices %}
            {% if active_prices %}
              <div class="space-y-3">
                {% for price in active_prices|slice:":2" %}
                  <div class="bg-slate-700 rounded p-3">
                    <div class="flex items-center justify-between mb-1">
                      <span class="text-sm font-medium text-slate-300">{{ price.currency.code }}</span>
                      <div class="text-right">
                        <span class="font-semibold text-white text-lg">{{ price.monthly_price|floatformat:0 }}</span>
                        <span class="text-xs text-slate-400">/{% trans 'month' %}</span>
                      </div>
                    </div>
                    {% if price.semiannual_discount_percent > 0 or price.annual_discount_percent > 0 %}
                      <div class="flex flex-wrap gap-2 mt-2">
                        {% if price.semiannual_discount_percent > 0 %}
                          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-900 text-green-300">
                            {{ price.semiannual_discount_percent }}% {% trans 'off 6mo' %}
                          </span>
                        {% endif %}
                        {% if price.annual_discount_percent > 0 %}
                          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-900 text-green-300">
                            {{ price.annual_discount_percent }}% {% trans 'off annual' %}
                          </span>
                        {% endif %}
                      </div>
                    {% endif %}
                  </div>
                {% endfor %}
                {% if active_prices|length > 2 %}
                  <div class="text-center">
                    <span class="text-xs text-slate-500">
                      +{{ active_prices|length|add:"-2" }} {% trans 'more currencies' %} ‚Üí
                    </span>
                  </div>
                {% endif %}
              </div>
            {% else %}
              <div class="text-center py-3">
                <span class="text-slate-500 italic text-sm">{% trans 'No pricing set' %}</span>
              </div>
            {% endif %}
          {% endwith %}
        </div>

        <!-- Actions -->
        <div class="flex items-center justify-center space-x-4 pt-2 border-t border-slate-600">
          <!-- View Detail -->
          <a href="{% url 'products:product_detail' slug=product.slug %}"
             class="flex items-center space-x-2 text-blue-400 hover:text-blue-300 transition-colors py-2 px-3 rounded-md hover:bg-slate-600"
             title="{% trans 'View Details' %}">
            <span class="text-lg">üîç</span>
            <span class="text-sm">{% trans 'View' %}</span>
          </a>

          <!-- Edit Product -->
          <a href="{% url 'products:product_edit' slug=product.slug %}"
             class="flex items-center space-x-2 text-green-400 hover:text-green-300 transition-colors py-2 px-3 rounded-md hover:bg-slate-600"
             title="{% trans 'Edit Product' %}">
            <span class="text-lg">‚úèÔ∏è</span>
            <span class="text-sm">{% trans 'Edit' %}</span>
          </a>

          <!-- Manage Pricing -->
          <a href="{% url 'products:product_prices' slug=product.slug %}"
             class="flex items-center space-x-2 text-yellow-400 hover:text-yellow-300 transition-colors py-2 px-3 rounded-md hover:bg-slate-600"
             title="{% trans 'Manage Pricing' %}">
            <span class="text-lg">üí∞</span>
            <span class="text-sm">{% trans 'Price' %}</span>
          </a>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- Pagination -->
  {% if products.has_other_pages %}
    <div class="bg-slate-800 px-4 sm:px-6 py-4 border-t border-slate-700">
      <div class="flex flex-col sm:flex-row items-center justify-between space-y-3 sm:space-y-0">
        <div class="text-sm text-slate-400 text-center sm:text-left">
          {% with start=products.start_index end=products.end_index total=products.paginator.count %}
            {% blocktrans %}Showing {{ start }} to {{ end }} of {{ total }} products{% endblocktrans %}
          {% endwith %}
        </div>

        <div class="flex items-center space-x-2">
          {% if products.has_previous %}
            <a href="?page={{ products.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.product_type %}&product_type={{ request.GET.product_type }}{% endif %}{% if request.GET.is_active %}&is_active={{ request.GET.is_active }}{% endif %}{% if request.GET.is_public %}&is_public={{ request.GET.is_public }}{% endif %}"
               hx-get="{% url 'products:product_list_htmx' %}?page={{ products.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.product_type %}&product_type={{ request.GET.product_type }}{% endif %}{% if request.GET.is_active %}&is_active={{ request.GET.is_active }}{% endif %}{% if request.GET.is_public %}&is_public={{ request.GET.is_public }}{% endif %}"
               hx-target="#product-results"
               hx-swap="innerHTML"
               class="px-3 py-2 bg-slate-700 text-white rounded-md hover:bg-slate-600 transition-colors">
              ‚Üê {% trans 'Previous' %}
            </a>
          {% endif %}

          <span class="px-3 py-2 text-slate-400">
            {% trans 'Page' %} {{ products.number }} {% trans 'of' %} {{ products.paginator.num_pages }}
          </span>

          {% if products.has_next %}
            <a href="?page={{ products.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.product_type %}&product_type={{ request.GET.product_type }}{% endif %}{% if request.GET.is_active %}&is_active={{ request.GET.is_active }}{% endif %}{% if request.GET.is_public %}&is_public={{ request.GET.is_public }}{% endif %}"
               hx-get="{% url 'products:product_list_htmx' %}?page={{ products.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.product_type %}&product_type={{ request.GET.product_type }}{% endif %}{% if request.GET.is_active %}&is_active={{ request.GET.is_active }}{% endif %}{% if request.GET.is_public %}&is_public={{ request.GET.is_public }}{% endif %}"
               hx-target="#product-results"
               hx-swap="innerHTML"
               class="px-3 py-2 bg-slate-700 text-white rounded-md hover:bg-slate-600 transition-colors">
              {% trans 'Next' %} ‚Üí
            </a>
          {% endif %}
        </div>
      </div>
    </div>
  {% endif %}

{% else %}
  <!-- Empty State -->
  <div class="text-center py-12">
    <div class="text-6xl mb-4">üì¶</div>
    <h3 class="text-lg font-medium text-slate-300 mb-2">
      {% if search_query %}
        {% trans 'No products found' %}
      {% else %}
        {% trans 'No products yet' %}
      {% endif %}
    </h3>
    <p class="text-slate-400 mb-6">
      {% if search_query %}
        {% blocktrans %}No products match your search criteria. Try adjusting your filters.{% endblocktrans %}
      {% else %}
        {% trans 'Start building your product catalog by creating your first product.' %}
      {% endif %}
    </p>
    {% if not search_query %}
      {% url 'products:product_create' as create_product_url %}
      {% trans "‚ú® Create First Product" as bt9 %}{% button bt9 variant="primary" href=create_product_url %}
    {% endif %}
  </div>
{% endif %}
