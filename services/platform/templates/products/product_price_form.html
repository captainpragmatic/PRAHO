{% extends "base.html" %}
{% load i18n %}
{% load ui_components %}

{% block title %}{% trans "Add Price" %}: {{ product.name }} - PRAHO Platform{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8 max-w-4xl mx-auto">
  <!-- Header -->
  <div class="mb-6">
    <div class="flex items-center space-x-2 text-sm text-slate-400 mb-2">
      <a href="{% url 'products:product_list' %}" class="hover:text-blue-400">{% trans 'Products' %}</a>
      <span>‚Ä¢</span>
      <a href="{% url 'products:product_detail' slug=product.slug %}" class="hover:text-blue-400">{{ product.name }}</a>
      <span>‚Ä¢</span>
      <a href="{% url 'products:product_prices' slug=product.slug %}" class="hover:text-blue-400">{% trans 'Pricing' %}</a>
      <span>‚Ä¢</span>
      <span>{% trans 'Add Price' %}</span>
    </div>
    <h1 class="text-3xl font-bold text-white">
      üí∞ {% trans "Add New Price" %}
    </h1>
    <p class="mt-2 text-slate-400">
      {% trans "Configure simplified pricing for" %} {{ product.name }}
    </p>
  </div>

  <!-- Simplified Pricing Notice -->
  <div class="bg-green-900 border border-green-700 rounded-lg p-4 mb-6">
    <div class="flex items-start">
      <div class="flex-shrink-0">
        <span class="text-green-300 text-xl">‚ú®</span>
      </div>
      <div class="ml-3">
        <h3 class="text-sm font-medium text-green-200">{% trans 'Simplified Pricing Model' %}</h3>
        <div class="mt-1 text-sm text-green-300">
          <p>{% trans 'Set one monthly price and optional discounts:' %}</p>
          <ul class="mt-2 space-y-1">
            <li>‚Ä¢ {% trans 'Monthly: Base price (what you enter)' %}</li>
            <li>‚Ä¢ {% trans 'Semi-annual: Monthly √ó 6 (with optional discount)' %}</li>
            <li>‚Ä¢ {% trans 'Annual: Monthly √ó 12 (with optional discount)' %}</li>
          </ul>
        </div>
      </div>
    </div>
  </div>


  <!-- Form -->
  <form method="POST" class="space-y-6">
    {% csrf_token %}

    <!-- Basic Pricing -->
    <div class="bg-slate-800 rounded-lg border border-slate-700 p-6">
      <h2 class="text-xl font-semibold text-white mb-6">üí∞ {% trans 'Basic Pricing' %}</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Currency -->
        <div>
          {% input_field "currency" input_type="select" label="Currency" html_id="id_currency" placeholder="Select currency" required=True options=currency_options value=form.currency.value help_text="RON recommended for Romanian customers" error=form.currency.errors.0 %}
        </div>

        <!-- Monthly Price (in cents) -->
        <div>
          {% input_field "monthly_price_cents" input_type="number" label="Monthly Price (in cents)" html_id="id_monthly_price_cents" placeholder="2999" required=True value=form.monthly_price_cents.value help_text="Enter monthly price in cents (e.g., 2999 for 29.99). Longer periods calculated automatically." error=form.monthly_price_cents.errors.0 %}
          <div id="monthly_price_helper" class="text-xs text-slate-400 mt-1"></div>
        </div>

        <!-- Setup Fee (in cents) -->
        <div class="md:col-span-2">
          {% input_field "setup_cents" input_type="number" label="Setup Fee (in cents)" html_id="id_setup_cents" placeholder="0" value=form.setup_cents.value|default:"0" help_text="One-time setup fee (0 for none)" error=form.setup_cents.errors.0 %}
          <div id="setup_price_helper" class="text-xs text-slate-400 mt-1"></div>
        </div>
      </div>
    </div>

    <!-- Billing Period Discounts -->
    <div class="bg-slate-800 rounded-lg border border-slate-700 p-6">
      <h2 class="text-xl font-semibold text-white mb-6">üéØ {% trans 'Billing Period Discounts' %}</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Semi-annual Discount -->
        <div>
          {% input_field "semiannual_discount_percent" input_type="number" label="Semi-Annual Discount %" html_id="id_semiannual_discount_percent" placeholder="0" min=0 max=100 value=form.semiannual_discount_percent.value|default:"0" help_text="Discount for 6-month billing (0 = no discount)" error=form.semiannual_discount_percent.errors.0 %}
          <div id="semiannual_calculation" class="text-xs text-slate-400 mt-1">{% trans 'Semi-annual will be: Monthly √ó 6' %}</div>
        </div>

        <!-- Annual Discount -->
        <div>
          {% input_field "annual_discount_percent" input_type="number" label="Annual Discount %" html_id="id_annual_discount_percent" placeholder="0" min=0 max=100 value=form.annual_discount_percent.value|default:"0" help_text="Discount for 12-month billing (0 = no discount)" error=form.annual_discount_percent.errors.0 %}
          <div id="annual_calculation" class="text-xs text-slate-400 mt-1">{% trans 'Annual will be: Monthly √ó 12' %}</div>
        </div>
      </div>

      <div class="mt-4 p-3 bg-yellow-900 border border-yellow-700 rounded-lg">
        <div class="flex items-start">
          <span class="text-yellow-300 mr-2">üí°</span>
          <div class="text-sm text-yellow-200">
            {% trans 'When discount is 0%, longer billing periods show calculated prices as read-only. When discount > 0%, they become active pricing options with reduced rates.' %}
          </div>
        </div>
      </div>
    </div>

    <!-- Quantity Limits -->
    <div class="bg-slate-800 rounded-lg border border-slate-700 p-6">
      <h2 class="text-xl font-semibold text-white mb-6">üìä {% trans 'Quantity Limits' %}</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Minimum Quantity -->
        <div>
          {% input_field "minimum_quantity" input_type="number" label="Minimum Quantity" html_id="id_minimum_quantity" placeholder="1" value=form.minimum_quantity.value|default:"1" help_text="Minimum quantity that can be ordered" error=form.minimum_quantity.errors.0 %}
        </div>

        <!-- Maximum Quantity -->
        <div>
          {% input_field "maximum_quantity" input_type="number" label="Maximum Quantity" html_id="id_maximum_quantity" placeholder="" value=form.maximum_quantity.value help_text="Maximum quantity (blank for unlimited)" error=form.maximum_quantity.errors.0 %}
        </div>
      </div>
    </div>

    <!-- Promotional Pricing -->
    <div class="bg-slate-800 rounded-lg border border-slate-700 p-6">
      <h2 class="text-xl font-semibold text-white mb-6">üéâ {% trans 'Promotional Pricing' %}</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Promo Price -->
        <div>
          {% input_field "promo_price_cents" input_type="number" label="Promotional Monthly Price (in cents)" html_id="id_promo_price_cents" placeholder="1999" value=form.promo_price_cents.value help_text="Special promotional monthly price (leave blank for none)" error=form.promo_price_cents.errors.0 %}
          <div id="promo_price_helper" class="text-xs text-slate-400 mt-1"></div>
        </div>

        <!-- Promo Valid Until -->
        <div>
          {% input_field "promo_valid_until" input_type="date" label="Promotion Valid Until" html_id="id_promo_valid_until" value=form.promo_valid_until.value help_text="When the promotional pricing expires" error=form.promo_valid_until.errors.0 %}
        </div>
      </div>

      <div class="mt-4 p-3 bg-yellow-900 border border-yellow-700 rounded-lg">
        <div class="flex items-start">
          <span class="text-yellow-300 mr-2">‚ö†Ô∏è</span>
          <div class="text-sm text-yellow-200">
            {% trans 'Promotional pricing affects the monthly base price. Longer billing periods will be calculated from the promotional monthly price.' %}
          </div>
        </div>
      </div>
    </div>

    <!-- Status -->
    <div class="bg-slate-800 rounded-lg border border-slate-700 p-6">
      <h2 class="text-xl font-semibold text-white mb-6">‚öôÔ∏è {% trans 'Status' %}</h2>

      {% checkbox_field "is_active" label="Active (available for ordering)" html_id="id_is_active" checked=form.is_active.value help_text="Inactive prices are not shown to customers" %}
    </div>

    <!-- Form Actions -->
    <div class="flex justify-end space-x-3">
      <a href="{% url 'products:product_prices' slug=product.slug %}"
         class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-md font-medium transition-colors">
        ‚ùå {% trans 'Cancel' %}
      </a>
      {% button "üí∞ Add Price" variant="primary" type="submit" %}
    </div>
  </form>
</div>

<script>
// Price calculator helper for the simplified model
document.addEventListener('DOMContentLoaded', function() {
    const monthlyInput = document.getElementById('id_monthly_price_cents');
    const setupInput = document.getElementById('id_setup_cents');
    const promoInput = document.getElementById('id_promo_price_cents');
    const semiannualDiscountInput = document.getElementById('id_semiannual_discount_percent');
    const annualDiscountInput = document.getElementById('id_annual_discount_percent');

    function updateCalculations() {
        const monthlyCents = parseInt(monthlyInput.value) || 0;
        const monthlyPrice = monthlyCents / 100;
        const semiannualDiscount = parseFloat(semiannualDiscountInput.value) || 0;
        const annualDiscount = parseFloat(annualDiscountInput.value) || 0;

        // Update monthly price helper
        document.getElementById('monthly_price_helper').textContent =
            `‚âà ${monthlyPrice.toFixed(2)} per month`;

        // Update setup fee helper
        const setupCents = parseInt(setupInput.value) || 0;
        document.getElementById('setup_price_helper').textContent =
            `‚âà ${(setupCents / 100).toFixed(2)} one-time fee`;

        // Update promotional price helper
        if (promoInput.value) {
            const promoCents = parseInt(promoInput.value) || 0;
            document.getElementById('promo_price_helper').textContent =
                `‚âà ${(promoCents / 100).toFixed(2)} promotional monthly price`;
        }

        // Calculate semi-annual price
        const semiannualBase = monthlyPrice * 6;
        const semiannualFinal = semiannualBase * (1 - semiannualDiscount / 100);
        document.getElementById('semiannual_calculation').textContent =
            semiannualDiscount > 0
                ? `Semi-annual: ${semiannualBase.toFixed(2)} - ${semiannualDiscount}% = ${semiannualFinal.toFixed(2)}`
                : `Semi-annual will be: ${semiannualBase.toFixed(2)} (no discount)`;

        // Calculate annual price
        const annualBase = monthlyPrice * 12;
        const annualFinal = annualBase * (1 - annualDiscount / 100);
        document.getElementById('annual_calculation').textContent =
            annualDiscount > 0
                ? `Annual: ${annualBase.toFixed(2)} - ${annualDiscount}% = ${annualFinal.toFixed(2)}`
                : `Annual will be: ${annualBase.toFixed(2)} (no discount)`;
    }

    // Add event listeners
    monthlyInput.addEventListener('input', updateCalculations);
    setupInput.addEventListener('input', updateCalculations);
    promoInput.addEventListener('input', updateCalculations);
    semiannualDiscountInput.addEventListener('input', updateCalculations);
    annualDiscountInput.addEventListener('input', updateCalculations);

    // Initial calculation
    updateCalculations();
});
</script>
{% endblock %}