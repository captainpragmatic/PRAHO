{% extends "base.html" %}
{% load i18n %}
{% load ui_components %}

{% block title %}{% trans "Pricing" %}: {{ product.name }} - PRAHO Platform{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
  <!-- Header -->
  <div class="flex flex-col lg:flex-row lg:justify-between lg:items-start gap-4 mb-6">
    <div class="flex-1">
      <div class="flex flex-wrap items-center gap-1 text-sm text-slate-400 mb-2">
        <a href="{% url 'products:product_list' %}" class="hover:text-blue-400">{% trans 'Products' %}</a>
        <span class="hidden sm:inline">‚Ä¢</span>
        <a href="{% url 'products:product_detail' slug=product.slug %}" class="hover:text-blue-400 truncate">{{ product.name }}</a>
        <span class="hidden sm:inline">‚Ä¢</span>
        <span>{% trans 'Pricing' %}</span>
      </div>
      <h1 class="text-2xl sm:text-3xl font-bold text-white mb-2">
        üí∞ {% trans "Pricing Management" %}
      </h1>
      <p class="text-sm sm:text-base text-slate-400">{{ product.name }} - {% trans "Manage multi-currency pricing for Romanian business" %}</p>
    </div>

    <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 lg:flex-shrink-0">
      {% url 'products:product_detail' slug=product.slug as detail_url %}
      {% button "‚Üê Back to Product" variant="secondary" href=detail_url %}
      {% url 'products:product_price_create' slug=product.slug as create_price_url %}
      {% button "üí∞ Add Price" variant="primary" href=create_price_url %}
    </div>
  </div>


  {% if prices %}
  <!-- Pricing Tables by Currency -->
  {% regroup prices by currency as currency_groups %}
  
  <div class="space-y-8">
    {% for currency_group in currency_groups %}
    <div class="bg-slate-800 rounded-lg border border-slate-700">
      <!-- Currency Header -->
      <div class="px-4 sm:px-6 py-4 border-b border-slate-700">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div class="flex flex-col sm:flex-row sm:items-center gap-2 min-w-0">
            <h2 class="text-lg sm:text-xl font-semibold text-white flex items-center flex-wrap gap-2">
              <span class="flex-shrink-0">üí±</span>
              <span class="truncate">{{ currency_group.grouper.name }} ({{ currency_group.grouper.code }})</span>
              {% if currency_group.grouper.code == 'RON' %}
                <span class="flex-shrink-0 px-2 py-1 bg-green-800 text-green-200 text-xs rounded whitespace-nowrap">{% trans 'Romanian Lei' %}</span>
              {% endif %}
            </h2>
            <span class="text-slate-400 text-sm sm:text-base">{{ currency_group.grouper.symbol }}</span>
          </div>

          <div class="flex items-center space-x-2 flex-shrink-0">
            {% badge "Active Currency" variant="success" %}
          </div>
        </div>
      </div>

      <!-- Simplified Pricing Display -->
      <div class="p-6">
        {% for price in currency_group.list %}
        <div class="bg-slate-700 rounded-lg border border-slate-600 p-4 sm:p-6 mb-4">
          <!-- Base Monthly Price -->
          <div class="mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-3">
              <h3 class="text-lg font-semibold text-white">üí∞ {% trans 'Base Monthly Price' %}</h3>
              {% if price.is_active %}
                {% badge "Active" variant="success" size="sm" %}
              {% else %}
                {% badge "Inactive" variant="danger" size="sm" %}
              {% endif %}
            </div>
            <div class="text-2xl sm:text-3xl font-bold text-white break-all">
              {{ price.monthly_price|floatformat:2 }} {{ currency_group.grouper.symbol }}<span class="text-sm font-normal text-slate-400">/{% trans 'month' %}</span>
            </div>
          </div>

          <!-- Billing Period Pricing -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
            <!-- Monthly -->
            <div class="bg-slate-800 rounded-lg p-3 sm:p-4 border border-slate-600">
              <div class="text-center">
                <div class="text-sm font-medium text-slate-300 mb-2">üìÖ {% trans 'Monthly' %}</div>
                <div class="text-lg sm:text-xl font-bold text-white break-all">{{ price.monthly_price|floatformat:2 }} {{ currency_group.grouper.symbol }}</div>
                <div class="text-xs text-slate-400 mt-1">{% trans 'Standard rate' %}</div>
              </div>
            </div>

            <!-- Semiannual -->
            <div class="bg-slate-800 rounded-lg p-3 sm:p-4 border border-slate-600 {% if price.semiannual_discount_percent > 0 %}ring-2 ring-green-500{% endif %}">
              <div class="text-center">
                <div class="text-sm font-medium text-slate-300 mb-2">üìÖ {% trans '6 Months' %}</div>
                <div class="text-lg sm:text-xl font-bold text-white break-all">{{ price.semiannual_price|floatformat:2 }} {{ currency_group.grouper.symbol }}</div>
                {% if price.semiannual_discount_percent > 0 %}
                  <div class="text-xs text-green-400 mt-1">
                    {{ price.semiannual_discount_percent }}% {% trans 'discount' %}
                  </div>
                {% else %}
                  <div class="text-xs text-slate-400 mt-1 break-all">{{ price.monthly_price|floatformat:2 }} √ó 6</div>
                {% endif %}
              </div>
            </div>

            <!-- Annual -->
            <div class="bg-slate-800 rounded-lg p-3 sm:p-4 border border-slate-600 {% if price.annual_discount_percent > 0 %}ring-2 ring-green-500{% endif %}">
              <div class="text-center">
                <div class="text-sm font-medium text-slate-300 mb-2">üìÖ {% trans 'Annual' %}</div>
                <div class="text-lg sm:text-xl font-bold text-white break-all">{{ price.annual_price|floatformat:2 }} {{ currency_group.grouper.symbol }}</div>
                {% if price.annual_discount_percent > 0 %}
                  <div class="text-xs text-green-400 mt-1">
                    {{ price.annual_discount_percent }}% {% trans 'discount' %}
                  </div>
                {% else %}
                  <div class="text-xs text-slate-400 mt-1 break-all">{{ price.monthly_price|floatformat:2 }} √ó 12</div>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Setup Fee -->
          {% if price.setup_cents > 0 %}
          <div class="bg-slate-800 rounded-lg p-3 sm:p-4 border border-slate-600 mb-4">
            <div class="text-sm text-slate-400 mb-1">‚ö° {% trans 'One-time Setup Fee' %}</div>
            <div class="text-lg font-semibold text-yellow-400 break-all">
              + {{ price.setup_fee|floatformat:2 }} {{ currency_group.grouper.symbol }}
            </div>
          </div>
          {% endif %}

          <!-- Promotional Pricing -->
          {% if price.promo_price_cents and price.promo_valid_until %}
          <div class="bg-red-900 border border-red-700 rounded-lg p-3 sm:p-4 mb-4">
            <div class="flex items-start sm:items-center gap-2">
              <span class="text-red-300 text-lg flex-shrink-0">üéØ</span>
              <div class="min-w-0 flex-1">
                <div class="text-sm font-medium text-red-200">{% trans 'Special Promotion' %}</div>
                <div class="text-red-300 text-sm break-all">
                  <span class="line-through">{{ price.monthly_price|floatformat:2 }} {{ currency_group.grouper.symbol }}</span>
                  ‚Üí <span class="font-bold">{{ price.promo_price|floatformat:2 }} {{ currency_group.grouper.symbol }}</span>
                </div>
                <div class="text-xs text-red-400 mt-1">
                  {% trans 'Valid until' %} {{ price.promo_valid_until|date:"j M Y" }}
                </div>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- Quantity Limits -->
          {% if price.minimum_quantity > 1 or price.maximum_quantity %}
          <div class="bg-slate-800 rounded-lg p-3 sm:p-4 border border-slate-600 mb-4">
            <div class="text-sm font-medium text-slate-300 mb-2">üì¶ {% trans 'Quantity Limits' %}</div>
            <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 text-sm text-slate-400">
              {% if price.minimum_quantity > 1 %}
                <div>{% trans 'Minimum:' %} <span class="text-white font-medium">{{ price.minimum_quantity }}</span></div>
              {% endif %}
              {% if price.maximum_quantity %}
                <div>{% trans 'Maximum:' %} <span class="text-white font-medium">{{ price.maximum_quantity }}</span></div>
              {% endif %}
            </div>
          </div>
          {% endif %}

          <!-- Actions -->
          <div class="flex flex-col sm:flex-row justify-end gap-2 sm:gap-3 pt-4 border-t border-slate-600">
            <a href="{% url 'products:product_price_edit' slug=product.slug price_id=price.id %}"
               class="flex items-center justify-center px-3 py-2 bg-yellow-600 hover:bg-yellow-700 text-white text-sm rounded-lg transition-colors"
               title="{% trans 'Edit Pricing' %}">
              <span class="mr-1">‚úèÔ∏è</span>
              {% trans 'Edit' %}
            </a>
            <a href="{% url 'products:product_price_delete' slug=product.slug price_id=price.id %}"
               class="flex items-center justify-center px-3 py-2 bg-red-600 hover:bg-red-700 text-white text-sm rounded-lg transition-colors"
               title="{% trans 'Delete Pricing' %}">
              <span class="mr-1">üóëÔ∏è</span>
              {% trans 'Delete' %}
            </a>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  </div>

  {% else %}
  <!-- Empty State -->
  <div class="bg-slate-800 rounded-lg border border-slate-700">
    <div class="text-center py-12">
      <div class="text-6xl mb-4">üí∞</div>
      <h3 class="text-lg font-medium text-slate-300 mb-2">
        {% trans 'No pricing configured' %}
      </h3>
      <p class="text-slate-400 mb-6">
        {% trans 'Start by adding pricing options for this product. Multiple currencies and billing periods are supported.' %}
      </p>
      {% url 'products:product_price_create' slug=product.slug as create_price_url %}
      {% button "üí∞ Add First Price" variant="primary" href=create_price_url %}
    </div>
  </div>
  {% endif %}

  <!-- Pricing Guidelines -->
  <div class="mt-8 bg-slate-800 rounded-lg border border-slate-700 p-6">
    <h3 class="text-lg font-semibold text-white mb-4">üìã {% trans 'Pricing Guidelines' %}</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm text-slate-400">
      <div>
        <h4 class="font-medium text-slate-300 mb-2">{% trans 'Romanian Business' %}</h4>
        <ul class="space-y-1 list-disc list-inside">
          <li>{% trans 'RON pricing is recommended for local customers' %}</li>
          <li>{% trans 'Set VAT inclusion correctly for tax compliance' %}</li>
          <li>{% trans 'Consider e-Factura integration requirements' %}</li>
        </ul>
      </div>
      <div>
        <h4 class="font-medium text-slate-300 mb-2">{% trans 'Best Practices' %}</h4>
        <ul class="space-y-1 list-disc list-inside">
          <li>{% trans 'Offer multiple billing periods (monthly, annual)' %}</li>
          <li>{% trans 'Use promotional pricing for special offers' %}</li>
          <li>{% trans 'Set appropriate minimum/maximum quantities' %}</li>
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}