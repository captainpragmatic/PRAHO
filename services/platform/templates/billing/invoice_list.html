{% extends 'base.html' %}
{% load i18n %}
{% load ui_components %}

{% block title %}{% trans 'Invoices' %} - PRAHO Platform{% endblock %}

{% block content %}
<div class="px-4 py-6">
  <!-- Modern Header Card -->
  <div class="bg-slate-800 rounded-lg border border-slate-700 mb-6">
    <!-- Desktop Layout -->
    <div class="hidden md:block p-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <div class="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-white">{% trans "Invoice Management" %}</h1>
            <p class="text-slate-400">{% trans "Manage invoices and payments with Romanian VAT compliance" %}</p>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <div class="grid grid-cols-3 gap-6">
            <div class="text-center">
              <p class="text-2xl font-bold text-white">{{ total_amount|floatformat:2 }}</p>
              <p class="text-xs text-slate-400">{% trans 'Total Amount' %}</p>
            </div>
            <div class="text-center">
              <p class="text-2xl font-bold text-white">{{ invoices.paginator.count }}</p>
              <p class="text-xs text-slate-400">{% trans 'Total Invoices' %}</p>
            </div>
            <div class="text-center">
              <p class="text-2xl font-bold text-white">19%</p>
              <p class="text-xs text-slate-400">{% trans 'VAT Rate' %}</p>
            </div>
          </div>
          {% url 'billing:invoice_create' as create_url %}
          {% button "New Invoice" variant="primary" href=create_url size="sm" %}
        </div>
      </div>
    </div>

    <!-- Mobile Layout -->
    <div class="md:hidden p-4">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-green-600 rounded-lg flex items-center justify-center">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
          </div>
          <div>
            <h1 class="text-lg font-bold text-white">{% trans "Invoices" %}</h1>
          </div>
        </div>
        {% url 'billing:invoice_create' as create_url %}
        {% button "New" variant="primary" href=create_url size="sm" %}
      </div>
      
      <!-- Mobile Stats -->
      <div class="grid grid-cols-3 gap-3">
        <div class="text-center py-2">
          <p class="text-lg font-bold text-white">{{ total_amount|floatformat:0 }}</p>
          <p class="text-xs text-slate-400">{% trans 'Total' %}</p>
        </div>
        <div class="text-center py-2">
          <p class="text-lg font-bold text-white">{{ invoices.paginator.count }}</p>
          <p class="text-xs text-slate-400">{% trans 'Count' %}</p>
        </div>
        <div class="text-center py-2">
          <p class="text-lg font-bold text-white">19%</p>
          <p class="text-xs text-slate-400">{% trans 'VAT' %}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters and Search -->
  <div class="bg-slate-800 rounded-lg p-4 mb-6 border border-slate-700">
    <form method="get" class="flex gap-4 items-end">
      <!-- Search -->
      <div class="flex-1">
        <label for="search" class="block text-sm font-medium text-slate-300 mb-1">
          üîç {% trans 'Search' %}
        </label>
        {% input_field name="search" value=search_query placeholder="Invoice number, company name..." %}
      </div>

      <!-- Status Filter -->
      <div>
        <label for="status" class="block text-sm font-medium text-slate-300 mb-1">
          üìä {% trans 'Status' %}
        </label>
        <select id="status" name="status"
          class="px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-white focus:ring-2 focus:ring-blue-500">
          <option value="">{% trans 'All' %}</option>
          {% for status in status_choices %}
          <option value="{{ status.code }}" {% if status.selected %}selected{% endif %}>
            {{ status.label }}
          </option>
          {% endfor %}
        </select>
      </div>

      {% button "Filter" variant="primary" type="submit" %}

      {% if search_query or status_filter %}
      {% url 'billing:invoice_list' as list_url %}
      {% button "Reset" variant="secondary" href=list_url %}
      {% endif %}
    </form>
  </div>


  <!-- Invoices Table -->
  <div class="bg-slate-800 rounded-lg border border-slate-700">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-slate-700">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
              {% trans 'Invoice' %}
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
              {% trans 'Customer' %}
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
              {% trans 'Date' %}
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
              {% trans 'Amount' %}
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
              {% trans 'Status' %}
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
              {% trans 'Actions' %}
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-700">
          {% for invoice in invoices %}
          <tr class="hover:bg-slate-700/50 transition-colors">
            <td class="px-6 py-4">
              <div>
                <div class="text-white font-medium font-mono">
                  <a href="{% url 'billing:invoice_detail' invoice.pk %}" class="hover:text-blue-400">
                    #{{ invoice.invoice_number|default:"DRAFT" }}
                  </a>
                </div>
                {% if invoice.due_date %}
                <div class="text-slate-400 text-sm">
                  {% trans 'Due' %}: {{ invoice.due_date|date:"d.m.Y" }}
                </div>
                {% endif %}
              </div>
            </td>

            <td class="px-6 py-4">
              <div>
                <div class="text-white">{{ invoice.customer.company_name }}</div>
                <div class="text-slate-400 text-sm">{{ invoice.customer.cui }}</div>
              </div>
            </td>

            <td class="px-6 py-4">
              <div class="text-white">{{ invoice.created_at|date:"d.m.Y" }}</div>
              <div class="text-slate-400 text-sm">{{ invoice.created_at|time:"H:i" }}</div>
            </td>

            <td class="px-6 py-4">
              <div>
                <div class="text-white font-semibold">{{ invoice.total_amount|floatformat:2 }} RON</div>
                {% if invoice.vat_amount %}
                <div class="text-slate-400 text-sm">
                  {% trans 'VAT' %}: {{ invoice.vat_amount|floatformat:2 }} RON
                </div>
                {% endif %}
              </div>
            </td>

            <td class="px-6 py-4">
              {% if invoice.status == 'paid' %}
                {% badge "Paid" variant="success" icon="‚úÖ" %}
              {% elif invoice.status == 'overdue' %}
                {% badge "Overdue" variant="danger" icon="‚ùå" %}
              {% elif invoice.status == 'sent' %}
                {% badge "Sent" variant="info" icon="üìß" %}
              {% elif invoice.status == 'draft' %}
                {% badge "Draft" variant="secondary" icon="üìù" %}
              {% else %}
                {% badge "Pending" variant="warning" icon="‚è≥" %}
              {% endif %}
            </td>

            <td class="px-6 py-4">
              <div class="flex items-center space-x-2">
                {% url 'billing:invoice_detail' invoice.pk as detail_url %}
                {% url 'billing:invoice_pdf' invoice.pk as pdf_url %}
                {% button "View" variant="info" href=detail_url size="sm" %}
                {% if invoice.status == 'draft' %}
                {% url 'billing:invoice_edit' invoice.pk as edit_url %}
                {% button "Edit" variant="success" href=edit_url size="sm" %}
                {% endif %}
                {% button "PDF" variant="secondary" href=pdf_url size="sm" %}
                {% if invoice.status not in 'draft,paid' %}
                {% url 'billing:process_payment' invoice.pk as pay_url %}
                {% button "Pay" variant="success" hx_post=pay_url hx_confirm="Mark as paid?" size="sm" %}
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="px-6 py-12 text-center">
              <div class="text-slate-400">
                {% if search_query or status_filter %}
                <div class="text-4xl mb-4">üîç</div>
                <p>{% trans 'No invoices found for the selected filters' %}</p>
                {% else %}
                <div class="text-4xl mb-4">üìÑ</div>
                <p>{% trans 'No invoices yet' %}</p>
                <p class="mt-2">
                  <a href="{% url 'billing:invoice_create' %}" class="text-blue-400 hover:text-blue-300">
                    {% trans 'Create the first invoice' %} ‚Üí
                  </a>
                </p>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if invoices.has_other_pages %}
    <div class="bg-slate-700 px-6 py-3 border-t border-slate-600">
      <div class="flex items-center justify-between">
        <div class="text-sm text-slate-400">
          {% blocktrans with invoices.number as page_number and invoices.paginator.num_pages as num_pages %}
          Page {{ page_number }} of {{ num_pages }}
          {% endblocktrans %}
        </div>

        <div class="flex space-x-1">
          {% if invoices.has_previous %}
          <a href="?page={{ invoices.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}"
            class="bg-slate-600 hover:bg-slate-500 text-white px-3 py-1 rounded text-sm">
            {% trans 'Previous' %}
          </a>
          {% endif %}

          {% if invoices.has_next %}
          <a href="?page={{ invoices.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}"
            class="bg-slate-600 hover:bg-slate-500 text-white px-3 py-1 rounded text-sm">
            {% trans 'Next' %}
          </a>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Quick Actions -->
  <div class="mt-6 flex space-x-4">
    <a href="{% url 'billing:reports' %}"
      class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md inline-flex items-center">
      <span class="mr-2">üìä</span>
      {% trans 'Reports' %}
    </a>

    <a href="{% url 'billing:vat_report' %}"
      class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md inline-flex items-center">
      <span class="mr-2">üá∑üá¥</span>
      {% trans 'VAT Report' %}
    </a>
  </div>
</div>
{% endblock %}
