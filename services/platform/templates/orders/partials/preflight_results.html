{% load i18n %}

<div class="bg-slate-800 rounded-lg border {% if preflight_ok %}border-green-700{% else %}border-slate-700{% endif %} p-4">
  <div class="flex items-center justify-between mb-2">
    <div class="text-sm font-medium {% if preflight_ok %}text-green-400{% else %}text-slate-300{% endif %}">
      {% if preflight_ok %}
        âœ… {% trans "Validation passed â€” order can be promoted to Pending." %}
      {% else %}
        ðŸ§ª {% trans "Preflight Validation Results" %}
      {% endif %}
    </div>
    {% if preflight_ok %}
      <span class="text-xs text-green-400">{% trans "OK" %}</span>
    {% endif %}
  </div>

  {% if preflight_errors %}
    <div class="mb-3">
      <div class="text-sm text-red-400 font-semibold mb-1">{% trans "Blocking issues" %}</div>
      <ul class="list-disc pl-5 text-sm text-red-300 space-y-1">
        {% for err in preflight_errors %}
          <li>{{ err }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if preflight_warnings %}
    <div>
      <div class="text-sm text-yellow-400 font-semibold mb-1">{% trans "Warnings" %}</div>
      <ul class="list-disc pl-5 text-sm text-yellow-300 space-y-1">
        {% for warn in preflight_warnings %}
          <li>{{ warn }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
</div>

<script>
  // Toggle Pending option/button availability based on validation result
  (function(){
    const ok = {{ preflight_ok|yesno:"true,false" }};
    const select = document.getElementById('new_status');
    if (select) {
      const pendingOpt = Array.from(select.options).find(o => o.value === 'pending');
      if (pendingOpt) pendingOpt.disabled = !ok;
    }
  })();

  // Toast helper (lightweight)
  function showToast(message, variant) {
    const bg = variant === 'success' ? 'bg-green-600' : (variant === 'warning' ? 'bg-yellow-600' : 'bg-red-600');
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 z-50 ${bg} text-white px-4 py-2 rounded-lg shadow-lg`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s'; }, 2000);
    setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 2400);
  }

  // Show success toast when validation passes
  (function(){
    const ok = {{ preflight_ok|yesno:"true,false" }};
    if (ok) {
      showToast("{% trans 'Validation passed â€” you may promote to Pending' %}", 'success');
    }
  })();
</script>

<!-- Out-of-band update for modal summary -->
<div id="modal-preflight" hx-swap-oob="true">
  {% if preflight_ok %}
    <div class="bg-green-900/30 border border-green-700/50 text-green-300 text-sm rounded-lg p-3 mb-3">
      âœ… {% trans "Validation passed â€” you may promote to Pending" %}
    </div>
  {% else %}
    {% if preflight_errors %}
    <div class="bg-red-900/30 border border-red-700/50 text-red-300 text-sm rounded-lg p-3 mb-3">
      <div class="font-semibold mb-1">{% trans "Blocking issues" %}</div>
      <ul class="list-disc pl-5 space-y-1">
        {% for err in preflight_errors %}
        <li>{{ err }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
    {% if preflight_warnings %}
    <div class="bg-yellow-900/30 border border-yellow-700/50 text-yellow-300 text-sm rounded-lg p-3">
      <div class="font-semibold mb-1">{% trans "Warnings" %}</div>
      <ul class="list-disc pl-5 space-y-1">
        {% for warn in preflight_warnings %}
        <li>{{ warn }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  {% endif %}
</div>
