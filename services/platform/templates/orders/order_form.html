{% extends "base.html" %}
{% load i18n %}
{% load ui_components %}

{% block title %}
  {% if order %}
    {% trans "Edit Order" %} {{ order.order_number }}
  {% else %}
    {% trans "Create New Order" %}
  {% endif %} - PRAHO Platform
{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8 max-w-4xl mx-auto">
  <!-- Header -->
  <div class="sm:flex sm:items-center mb-6">
    <div class="sm:flex-auto">
      <h1 class="text-3xl font-bold text-white">
        {% if order %}
          âœï¸ {% trans "Edit Order" %} {{ order.order_number }}
        {% else %}
          ğŸ“¦ {% trans "Create New Order" %}
        {% endif %}
      </h1>
      <p class="mt-2 text-slate-400">
        {% if order %}
          {% trans "Update order details and items" %}
        {% else %}
          {% trans "Create a new order for customer services" %}
        {% endif %}
      </p>
    </div>
    <div class="mt-4 sm:mt-0 sm:ml-16 sm:flex-none">
      {% if order %}
        {% url 'orders:order_detail' pk=order.id as back_url %}
      {% else %}
        {% url 'orders:order_list' as back_url %}
      {% endif %}
      {% button "â† Back" variant="outline" href=back_url %}
    </div>
  </div>

  <!-- Form Content -->
  <div class="bg-slate-800 rounded-lg border border-slate-700">
    <div class="px-6 py-4 border-b border-slate-700">
      <h3 class="text-lg font-semibold text-white">
        {% if order %}
          ğŸ“ {% trans "Order Details" %}
        {% else %}
          ğŸ“‹ {% trans "New Order Information" %}
        {% endif %}
      </h3>
    </div>
    
    <div class="p-6">
      <!-- Order Form -->
      <form method="post" class="space-y-6">
        {% csrf_token %}
        
        <!-- Customer Selection (New Orders) -->
        {% if not order %}
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
          <div class="sm:col-span-2">
            <label for="id_customer" class="block text-sm font-medium text-slate-400 mb-2">
              {% trans "Customer" %} <span class="text-red-400">*</span>
            </label>
            <select id="id_customer" name="customer" required
                    class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">{% trans "Select a customer..." %}</option>
              {% for option in customer_options %}
                <option value="{{ option.value }}">{{ option.label }}</option>
              {% endfor %}
            </select>
            <p class="mt-1 text-xs text-slate-500">{% trans "Select customer for this order" %}</p>
          </div>
        </div>
        {% endif %}

        <!-- Order Details -->
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
          <div>
            <label for="id_currency" class="block text-sm font-medium text-slate-400 mb-2">
              {% trans "Currency" %}
            </label>
            <select id="id_currency" name="currency"
                    class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              {% for option in currency_options %}
                <option value="{{ option.value }}" {% if order and order.currency.code == option.value %}selected{% elif not order and option.value == "RON" %}selected{% endif %}>
                  {{ option.label }}
                </option>
              {% endfor %}
            </select>
            <p class="mt-1 text-xs text-slate-500">{% trans "Order currency" %}</p>
          </div>

          <div>
            {% if order %}
              {% input_field name="status" input_type="text" label=_("Status") value=order.get_status_display readonly=True help_text=_("Use 'Change Status' button on order detail page to update status") %}
            {% else %}
              {% input_field name="status" input_type="text" label=_("Status") value=_("Draft") readonly=True help_text=_("Status will be set after order creation") %}
            {% endif %}
          </div>
        </div>

        <!-- Payment Method -->
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
          <div>
            <label for="id_payment_method" class="block text-sm font-medium text-slate-400 mb-2">
              {% trans "Payment Method" %}
            </label>
            <select id="id_payment_method" name="payment_method"
                    class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">{% trans "Select payment method..." %}</option>
              {% for option in payment_method_options %}
                <option value="{{ option.value }}" {% if order and order.payment_method == option.value %}selected{% endif %}>
                  {{ option.label }}
                </option>
              {% endfor %}
            </select>
            <p class="mt-1 text-xs text-slate-500">{% trans "How customer will pay for this order" %}</p>
          </div>
        </div>

        <!-- Notes -->
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
          <div>
            <label for="id_notes" class="block text-sm font-medium text-slate-400 mb-2">
              {% trans "Internal Notes" %}
            </label>
            <textarea id="id_notes" name="notes" rows="4"
                      class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      placeholder="{% trans 'Internal order notes (visible to staff only)' %}">{% if order %}{{ order.notes }}{% endif %}</textarea>
            <p class="mt-1 text-xs text-slate-500">{% trans "Internal order notes (visible to staff only)" %}</p>
          </div>
          <div>
            <label for="id_customer_notes" class="block text-sm font-medium text-slate-400 mb-2">
              {% trans "Customer Notes" %}
            </label>
            <textarea id="id_customer_notes" name="customer_notes" rows="4"
                      class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      placeholder="{% trans 'Notes from customer or special instructions' %}">{% if order %}{{ order.customer_notes }}{% endif %}</textarea>
            <p class="mt-1 text-xs text-slate-500">{% trans "Notes from customer or special instructions" %}</p>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end space-x-4 pt-6 border-t border-slate-700">
          {% if order %}
            {% url 'orders:order_detail' pk=order.id as cancel_url %}
          {% else %}
            {% url 'orders:order_list' as cancel_url %}
          {% endif %}
          {% button "Cancel" variant="outline" href=cancel_url %}
          
          {% if order %}
            {% button "ğŸ’¾ Update Order" type="submit" variant="primary" %}
          {% else %}
            {% button "ğŸ“¦ Create Order" type="submit" variant="outline" %}
            {% url 'orders:order_create_with_item' as create_with_item_url %}
            <button type="submit" formaction="{{ create_with_item_url }}"
                    class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg border border-green-600 bg-green-700 text-white hover:bg-green-600 focus:ring-2 focus:ring-green-500">
              ğŸš€ {% trans "Create Order with Item" %}
            </button>
          {% endif %}
        </div>
      </form>
    </div>
  </div>

  <!-- Order Items Section - Direct Management -->
  {% if order %}
  <div class="mt-6">
    <!-- Order Items Management with HTMX for real-time updates -->
    {% include 'orders/partials/order_items_list.html' %}
  </div>
  
  <!-- Financial Summary Sidebar -->
  <div class="mt-6">
    {% include 'orders/partials/financial_summary.html' %}
  </div>
  {% endif %}

  <!-- Romanian Business Context -->
  {% if not order %}
  <div class="mt-6 bg-slate-800 rounded-lg border border-slate-700">
    <div class="px-6 py-4 border-b border-slate-700">
      <h3 class="text-lg font-semibold text-white">ğŸ‡·ğŸ‡´ {% trans "Romanian Business Compliance" %}</h3>
    </div>
    <div class="p-6">
      <!-- First Item (Optional) -->
      <div class="mb-8">
        <h4 class="text-md font-semibold text-white mb-3">ğŸ§© {% trans "First Item (optional)" %}</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-400 mb-2">{% trans "Product" %}</label>
            <select name="first_product" id="first_product"
                    class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                    hx-post="{% url 'orders:order_create_preview' %}"
                    hx-include="#id_customer, #id_currency, #first_product, #first_billing_period, #first_quantity, #first_domain_name"
                    hx-target="#create-preview"
                    hx-swap="innerHTML">
              <option value="">{% trans "Select product..." %}</option>
              {% for p in products %}
              <option value="{{ p.id }}">{{ p.name }} ({{ p.get_product_type_display }})</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-400 mb-2">{% trans "Billing Period" %}</label>
            <select name="first_billing_period" id="first_billing_period"
                    class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                    hx-post="{% url 'orders:order_create_preview' %}"
                    hx-include="#id_customer, #id_currency, #first_product, #first_billing_period, #first_quantity, #first_domain_name"
                    hx-target="#create-preview"
                    hx-swap="innerHTML">
              <option value="monthly">{% trans "Monthly" %}</option>
              <option value="quarterly">{% trans "Quarterly" %}</option>
              <option value="semiannual">{% trans "Semi-Annual" %}</option>
              <option value="annual">{% trans "Annual" %}</option>
              <option value="biennial">{% trans "Biennial" %}</option>
              <option value="triennial">{% trans "Triennial" %}</option>
              <option value="once">{% trans "One Time" %}</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-400 mb-2">{% trans "Quantity" %}</label>
            <input type="number" min="1" value="1" name="first_quantity" id="first_quantity"
                   class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                   hx-post="{% url 'orders:order_create_preview' %}"
                   hx-include="#id_customer, #id_currency, #first_product, #first_billing_period, #first_quantity, #first_domain_name"
                   hx-target="#create-preview"
                   hx-swap="innerHTML">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-400 mb-2">{% trans "Domain (if required)" %}</label>
            <input type="text" name="first_domain_name" id="first_domain_name" placeholder="exemplu.ro"
                   class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                   hx-post="{% url 'orders:order_create_preview' %}"
                   hx-include="#id_customer, #id_currency, #first_product, #first_billing_period, #first_quantity, #first_domain_name"
                   hx-target="#create-preview"
                   hx-swap="innerHTML">
          </div>
        </div>

        <!-- Totals Preview (HTMX) -->
        <div id="create-preview" class="mt-4">
          <div class="text-sm text-slate-400">{% trans "Select a product and period to preview totals." %}</div>
        </div>
      </div>
      <p class="text-slate-400 mb-4">
        {% trans "Orders are automatically configured for Romanian business compliance:" %}
      </p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="space-y-2">
          <div class="flex items-center text-sm">
            <span class="mr-2">âœ…</span>
            <span class="text-slate-300">{% trans "Customer billing address snapshot" %}</span>
          </div>
          <div class="flex items-center text-sm">
            <span class="mr-2">âœ…</span>
            <span class="text-slate-300">{% trans "VAT ID (CUI) validation and storage" %}</span>
          </div>
          <div class="flex items-center text-sm">
            <span class="mr-2">âœ…</span>
            <span class="text-slate-300">{% trans "Sequential order numbering" %}</span>
          </div>
        </div>
        <div class="space-y-2">
          <div class="flex items-center text-sm">
            <span class="mr-2">âœ…</span>
            <span class="text-slate-300">{% trans "Multi-currency support (RON, EUR, USD)" %}</span>
          </div>
          <div class="flex items-center text-sm">
            <span class="mr-2">âœ…</span>
            <span class="text-slate-300">{% trans "Automatic conversion to proforma/invoice" %}</span>
          </div>
          <div class="flex items-center text-sm">
            <span class="mr-2">âœ…</span>
            <span class="text-slate-300">{% trans "Complete audit trail for GDPR" %}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
