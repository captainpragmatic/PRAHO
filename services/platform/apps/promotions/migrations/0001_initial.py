# Generated by Django 5.2.11 on 2026-02-09 12:12

import django.core.validators
import django.db.models.deletion
import django.utils.timezone
import uuid
from decimal import Decimal
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('billing', '0014_rename_billing_efa_cui_0c6e9a_idx_billing_efa_cui_70660c_idx_and_more'),
        ('customers', '0002_initial'),
        ('orders', '0005_add_payment_intent_id'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='Coupon',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('code', models.CharField(db_index=True, help_text='Unique coupon code (case-insensitive)', max_length=50, unique=True)),
                ('name', models.CharField(help_text='Internal name for this coupon', max_length=200)),
                ('description', models.TextField(blank=True, help_text='Description shown to customers')),
                ('internal_notes', models.TextField(blank=True, help_text='Internal notes for staff')),
                ('discount_type', models.CharField(choices=[('percent', 'Percentage Discount'), ('fixed', 'Fixed Amount Discount'), ('free_shipping', 'Free Shipping'), ('free_setup', 'Free Setup Fee'), ('bogo', 'Buy One Get One'), ('tiered', 'Tiered Discount'), ('free_months', 'Free Months')], default='percent', max_length=20)),
                ('discount_percent', models.DecimalField(blank=True, decimal_places=2, help_text='Percentage discount (0-100)', max_digits=5, null=True, validators=[django.core.validators.MinValueValidator(0), django.core.validators.MaxValueValidator(100)])),
                ('discount_amount_cents', models.BigIntegerField(blank=True, help_text='Fixed discount amount in cents', null=True, validators=[django.core.validators.MinValueValidator(0)])),
                ('free_months', models.PositiveIntegerField(blank=True, help_text='Number of free months for subscription discounts', null=True, validators=[django.core.validators.MinValueValidator(1), django.core.validators.MaxValueValidator(36)])),
                ('max_discount_cents', models.BigIntegerField(blank=True, help_text='Maximum discount amount in cents (caps percentage discounts)', null=True, validators=[django.core.validators.MinValueValidator(0)])),
                ('min_order_cents', models.BigIntegerField(blank=True, help_text='Minimum order amount in cents to qualify', null=True, validators=[django.core.validators.MinValueValidator(0)])),
                ('min_order_items', models.PositiveIntegerField(blank=True, help_text='Minimum number of items in order', null=True)),
                ('valid_from', models.DateTimeField(default=django.utils.timezone.now, help_text='When coupon becomes valid')),
                ('valid_until', models.DateTimeField(blank=True, help_text='When coupon expires (null = never)', null=True)),
                ('usage_limit_type', models.CharField(choices=[('unlimited', 'Unlimited'), ('single_use', 'Single Use (One Time)'), ('limited', 'Limited Total Uses'), ('per_customer', 'Limited Per Customer')], default='unlimited', max_length=20)),
                ('max_total_uses', models.PositiveIntegerField(blank=True, help_text='Maximum total redemptions', null=True, validators=[django.core.validators.MaxValueValidator(1000000)])),
                ('max_uses_per_customer', models.PositiveIntegerField(blank=True, help_text='Maximum uses per customer', null=True, validators=[django.core.validators.MaxValueValidator(1000)])),
                ('total_uses', models.PositiveIntegerField(default=0, help_text='Current total redemption count')),
                ('total_discount_cents', models.BigIntegerField(default=0, help_text='Total discount amount given')),
                ('customer_target', models.CharField(choices=[('all', 'All Customers'), ('new', 'New Customers Only'), ('existing', 'Existing Customers Only'), ('specific', 'Specific Customers'), ('segment', 'Customer Segment')], default='all', max_length=20)),
                ('first_order_only', models.BooleanField(default=False, help_text="Only valid for customer's first order")),
                ('applies_to_all_products', models.BooleanField(default=True, help_text='Applies to all products')),
                ('product_restrictions', models.JSONField(blank=True, default=dict, help_text='Product/category restrictions as JSON')),
                ('is_stackable', models.BooleanField(default=False, help_text='Can be combined with other coupons')),
                ('is_exclusive', models.BooleanField(default=False, help_text='Cannot be combined with any other discounts')),
                ('stacking_priority', models.PositiveIntegerField(default=100, help_text='Priority when stacking (lower = applied first). Reserved for future use.')),
                ('stacking_config', models.JSONField(blank=True, default=dict, help_text='Advanced stacking rules. Reserved for future use.')),
                ('status', models.CharField(choices=[('active', 'Active'), ('inactive', 'Inactive'), ('expired', 'Expired'), ('depleted', 'Depleted (Usage Limit Reached)'), ('cancelled', 'Cancelled')], default='active', max_length=20)),
                ('is_active', models.BooleanField(default=True, help_text='Master switch for coupon')),
                ('is_public', models.BooleanField(default=False, help_text='Show on public promotions page')),
                ('metadata', models.JSONField(blank=True, default=dict)),
                ('tags', models.JSONField(blank=True, default=list, help_text='Tags for filtering and reporting')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('assigned_customer', models.ForeignKey(blank=True, help_text='Customer this coupon is assigned to (for personal codes)', null=True, on_delete=django.db.models.deletion.CASCADE, related_name='assigned_coupons', to='customers.customer')),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_coupons', to=settings.AUTH_USER_MODEL)),
                ('currency', models.ForeignKey(blank=True, help_text='Currency for fixed amount discounts', null=True, on_delete=django.db.models.deletion.PROTECT, to='billing.currency')),
            ],
            options={
                'verbose_name': 'Coupon',
                'verbose_name_plural': 'Coupons',
                'db_table': 'promotion_coupons',
                'ordering': ('-created_at',),
            },
        ),
        migrations.CreateModel(
            name='CouponRedemption',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('status', models.CharField(choices=[('pending', 'Pending Application'), ('applied', 'Applied'), ('failed', 'Failed to Apply'), ('reversed', 'Reversed (Order Cancelled)'), ('expired', 'Expired Before Application')], default='pending', max_length=20)),
                ('discount_type', models.CharField(help_text='Discount type at time of redemption', max_length=20)),
                ('discount_value', models.DecimalField(decimal_places=2, help_text='Discount value (percent or amount) at time of redemption', max_digits=10)),
                ('discount_cents', models.BigIntegerField(default=0, help_text='Actual discount amount applied in cents')),
                ('currency_code', models.CharField(default='RON', help_text='Currency of discount', max_length=3)),
                ('order_subtotal_cents', models.BigIntegerField(help_text='Order subtotal before discount')),
                ('order_total_cents', models.BigIntegerField(help_text='Order total after discount')),
                ('applied_to_items', models.JSONField(blank=True, default=list, help_text='List of order item IDs this discount was applied to')),
                ('source_ip', models.GenericIPAddressField(blank=True, null=True)),
                ('user_agent', models.TextField(blank=True)),
                ('referrer', models.URLField(blank=True)),
                ('failure_reason', models.TextField(blank=True, help_text='Reason if redemption failed')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('applied_at', models.DateTimeField(blank=True, help_text='When discount was applied', null=True)),
                ('reversed_at', models.DateTimeField(blank=True, help_text='When redemption was reversed', null=True)),
                ('coupon', models.ForeignKey(help_text='The coupon that was redeemed', on_delete=django.db.models.deletion.PROTECT, related_name='redemptions', to='promotions.coupon')),
                ('customer', models.ForeignKey(blank=True, help_text='Customer who redeemed the coupon', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='coupon_redemptions', to='customers.customer')),
                ('order', models.ForeignKey(help_text='The order this redemption applies to', on_delete=django.db.models.deletion.CASCADE, related_name='coupon_redemptions', to='orders.order')),
            ],
            options={
                'verbose_name': 'Coupon Redemption',
                'verbose_name_plural': 'Coupon Redemptions',
                'db_table': 'promotion_coupon_redemptions',
                'ordering': ('-created_at',),
            },
        ),
        migrations.CreateModel(
            name='GiftCard',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('code', models.CharField(db_index=True, help_text='Unique gift card code', max_length=50, unique=True)),
                ('initial_value_cents', models.BigIntegerField(help_text='Original value in cents', validators=[django.core.validators.MinValueValidator(100)])),
                ('current_balance_cents', models.BigIntegerField(help_text='Current remaining balance in cents', validators=[django.core.validators.MinValueValidator(0)])),
                ('card_type', models.CharField(choices=[('digital', 'Digital'), ('physical', 'Physical')], default='digital', max_length=20)),
                ('recipient_email', models.EmailField(blank=True, max_length=254)),
                ('recipient_name', models.CharField(blank=True, max_length=200)),
                ('personal_message', models.TextField(blank=True)),
                ('delivery_date', models.DateTimeField(blank=True, null=True)),
                ('valid_from', models.DateTimeField(default=django.utils.timezone.now)),
                ('valid_until', models.DateTimeField(blank=True, null=True)),
                ('status', models.CharField(choices=[('pending', 'Pending Payment'), ('active', 'Active'), ('partially_used', 'Partially Used'), ('depleted', 'Depleted'), ('expired', 'Expired'), ('cancelled', 'Cancelled')], default='pending', max_length=20)),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('activated_at', models.DateTimeField(blank=True, null=True)),
                ('currency', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, to='billing.currency')),
                ('purchase_order', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='gift_cards_purchased', to='orders.order')),
                ('purchased_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='purchased_gift_cards', to='customers.customer')),
                ('redeemed_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='redeemed_gift_cards', to='customers.customer')),
            ],
            options={
                'verbose_name': 'Gift Card',
                'verbose_name_plural': 'Gift Cards',
                'db_table': 'promotion_gift_cards',
                'ordering': ('-created_at',),
            },
        ),
        migrations.CreateModel(
            name='GiftCardTransaction',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('transaction_type', models.CharField(choices=[('activation', 'Activation'), ('redemption', 'Redemption'), ('refund', 'Refund'), ('adjustment', 'Manual Adjustment'), ('expiration', 'Expiration')], max_length=20)),
                ('amount_cents', models.BigIntegerField(help_text='Transaction amount in cents')),
                ('balance_after_cents', models.BigIntegerField(help_text='Balance after transaction')),
                ('description', models.TextField(blank=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
                ('customer', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='customers.customer')),
                ('gift_card', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='transactions', to='promotions.giftcard')),
                ('order', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='gift_card_transactions', to='orders.order')),
            ],
            options={
                'verbose_name': 'Gift Card Transaction',
                'verbose_name_plural': 'Gift Card Transactions',
                'db_table': 'promotion_gift_card_transactions',
                'ordering': ('-created_at',),
            },
        ),
        migrations.CreateModel(
            name='LoyaltyProgram',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('name', models.CharField(max_length=200)),
                ('description', models.TextField(blank=True)),
                ('points_per_currency_unit', models.DecimalField(decimal_places=2, default=Decimal('1.00'), help_text='Points earned per currency unit spent', max_digits=10)),
                ('bonus_multiplier_new_customer', models.DecimalField(decimal_places=2, default=Decimal('1.00'), help_text='Point multiplier for new customers', max_digits=5)),
                ('points_per_discount_unit', models.PositiveIntegerField(default=100, help_text='Points needed for 1 currency unit discount')),
                ('min_points_to_redeem', models.PositiveIntegerField(default=100, help_text='Minimum points needed to redeem')),
                ('max_discount_percent', models.DecimalField(decimal_places=2, default=Decimal('50.00'), help_text='Maximum discount percentage from points', max_digits=5)),
                ('points_expire_months', models.PositiveIntegerField(blank=True, help_text='Months until points expire (null = never)', null=True)),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('currency', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, to='billing.currency')),
            ],
            options={
                'verbose_name': 'Loyalty Program',
                'verbose_name_plural': 'Loyalty Programs',
                'db_table': 'promotion_loyalty_programs',
            },
        ),
        migrations.CreateModel(
            name='LoyaltyTier',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('name', models.CharField(max_length=100)),
                ('slug', models.SlugField()),
                ('description', models.TextField(blank=True)),
                ('min_points_lifetime', models.PositiveIntegerField(default=0, help_text='Minimum lifetime points to reach this tier')),
                ('min_spend_cents', models.BigIntegerField(default=0, help_text='Minimum lifetime spend in cents')),
                ('points_multiplier', models.DecimalField(decimal_places=2, default=Decimal('1.00'), help_text='Point earning multiplier', max_digits=5)),
                ('discount_percent', models.DecimalField(decimal_places=2, default=Decimal('0.00'), help_text='Automatic discount for tier members', max_digits=5)),
                ('free_shipping', models.BooleanField(default=False)),
                ('priority_support', models.BooleanField(default=False)),
                ('benefits', models.JSONField(blank=True, default=dict, help_text='Additional tier benefits as JSON')),
                ('badge_color', models.CharField(default='gray', max_length=20)),
                ('sort_order', models.PositiveIntegerField(default=0)),
                ('program', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='tiers', to='promotions.loyaltyprogram')),
            ],
            options={
                'verbose_name': 'Loyalty Tier',
                'verbose_name_plural': 'Loyalty Tiers',
                'db_table': 'promotion_loyalty_tiers',
                'ordering': ('sort_order',),
            },
        ),
        migrations.CreateModel(
            name='CustomerLoyalty',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('points_balance', models.PositiveIntegerField(default=0)),
                ('points_lifetime', models.PositiveIntegerField(default=0)),
                ('points_redeemed', models.PositiveIntegerField(default=0)),
                ('points_expired', models.PositiveIntegerField(default=0)),
                ('total_spend_cents', models.BigIntegerField(default=0)),
                ('total_orders', models.PositiveIntegerField(default=0)),
                ('is_active', models.BooleanField(default=True)),
                ('enrolled_at', models.DateTimeField(auto_now_add=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('customer', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='loyalty_memberships', to='customers.customer')),
                ('program', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='memberships', to='promotions.loyaltyprogram')),
                ('current_tier', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='members', to='promotions.loyaltytier')),
            ],
            options={
                'verbose_name': 'Customer Loyalty',
                'verbose_name_plural': 'Customer Loyalties',
                'db_table': 'promotion_customer_loyalty',
            },
        ),
        migrations.CreateModel(
            name='LoyaltyTransaction',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('transaction_type', models.CharField(choices=[('earn', 'Points Earned'), ('redeem', 'Points Redeemed'), ('expire', 'Points Expired'), ('adjust', 'Manual Adjustment'), ('bonus', 'Bonus Points'), ('refund', 'Points Refunded'), ('tier_bonus', 'Tier Bonus')], max_length=20)),
                ('points', models.IntegerField(help_text='Points change (positive or negative)')),
                ('balance_after', models.PositiveIntegerField(help_text='Balance after transaction')),
                ('description', models.TextField(blank=True)),
                ('expires_at', models.DateTimeField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('coupon_redemption', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='promotions.couponredemption')),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
                ('customer_loyalty', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='transactions', to='promotions.customerloyalty')),
                ('order', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='loyalty_transactions', to='orders.order')),
            ],
            options={
                'verbose_name': 'Loyalty Transaction',
                'verbose_name_plural': 'Loyalty Transactions',
                'db_table': 'promotion_loyalty_transactions',
                'ordering': ('-created_at',),
            },
        ),
        migrations.CreateModel(
            name='PromotionCampaign',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('name', models.CharField(help_text='Internal campaign name', max_length=200)),
                ('slug', models.SlugField(help_text='URL-friendly identifier', max_length=100, unique=True)),
                ('description', models.TextField(blank=True, help_text='Campaign description and goals')),
                ('campaign_type', models.CharField(choices=[('seasonal', 'Seasonal Sale'), ('holiday', 'Holiday Promotion'), ('flash_sale', 'Flash Sale'), ('loyalty', 'Loyalty Reward'), ('referral', 'Referral Program'), ('new_customer', 'New Customer'), ('win_back', 'Win-Back Campaign'), ('partner', 'Partner/Affiliate'), ('influencer', 'Influencer'), ('email', 'Email Campaign'), ('social', 'Social Media'), ('other', 'Other')], default='other', max_length=20)),
                ('start_date', models.DateTimeField(help_text='When campaign becomes active')),
                ('end_date', models.DateTimeField(blank=True, help_text='When campaign ends (null = no end)', null=True)),
                ('budget_cents', models.BigIntegerField(blank=True, help_text='Maximum total discount budget in cents', null=True, validators=[django.core.validators.MinValueValidator(0)])),
                ('spent_cents', models.BigIntegerField(default=0, help_text='Total discounts given so far', validators=[django.core.validators.MinValueValidator(0)])),
                ('status', models.CharField(choices=[('draft', 'Draft'), ('scheduled', 'Scheduled'), ('active', 'Active'), ('paused', 'Paused'), ('completed', 'Completed'), ('cancelled', 'Cancelled')], default='draft', max_length=20)),
                ('is_active', models.BooleanField(default=True, help_text='Master switch for campaign')),
                ('utm_source', models.CharField(blank=True, max_length=100)),
                ('utm_medium', models.CharField(blank=True, max_length=100)),
                ('utm_campaign', models.CharField(blank=True, max_length=100)),
                ('metadata', models.JSONField(blank=True, default=dict)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_promotion_campaigns', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Promotion Campaign',
                'verbose_name_plural': 'Promotion Campaigns',
                'db_table': 'promotion_campaigns',
                'ordering': ('-created_at',),
            },
        ),
        migrations.AddField(
            model_name='coupon',
            name='campaign',
            field=models.ForeignKey(blank=True, help_text='Associated marketing campaign', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='coupons', to='promotions.promotioncampaign'),
        ),
        migrations.CreateModel(
            name='PromotionRule',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('name', models.CharField(help_text='Internal rule name', max_length=200)),
                ('description', models.TextField(blank=True, help_text='Rule description')),
                ('rule_type', models.CharField(choices=[('automatic', 'Automatic (always applies)'), ('threshold', 'Order Threshold'), ('quantity', 'Quantity Based'), ('bundle', 'Bundle Discount'), ('tiered', 'Tiered Pricing'), ('time_based', 'Time-Based'), ('customer_segment', 'Customer Segment'), ('product_combination', 'Product Combination')], default='automatic', max_length=30)),
                ('discount_type', models.CharField(choices=[('percent', 'Percentage Discount'), ('fixed', 'Fixed Amount Discount'), ('free_shipping', 'Free Shipping'), ('free_setup', 'Free Setup Fee'), ('tiered_percent', 'Tiered Percentage'), ('tiered_fixed', 'Tiered Fixed Amount')], default='percent', max_length=20)),
                ('discount_percent', models.DecimalField(blank=True, decimal_places=2, max_digits=5, null=True, validators=[django.core.validators.MinValueValidator(0), django.core.validators.MaxValueValidator(100)])),
                ('discount_amount_cents', models.BigIntegerField(blank=True, null=True, validators=[django.core.validators.MinValueValidator(0)])),
                ('max_discount_cents', models.BigIntegerField(blank=True, null=True, validators=[django.core.validators.MinValueValidator(0)])),
                ('conditions', models.JSONField(blank=True, default=dict, help_text='Rule conditions as JSON')),
                ('tiers', models.JSONField(blank=True, default=list, help_text='Tier thresholds and discounts as JSON array')),
                ('applies_to_all_products', models.BooleanField(default=True)),
                ('product_restrictions', models.JSONField(blank=True, default=dict)),
                ('valid_from', models.DateTimeField(default=django.utils.timezone.now)),
                ('valid_until', models.DateTimeField(blank=True, null=True)),
                ('is_stackable', models.BooleanField(default=True)),
                ('priority', models.PositiveIntegerField(default=100)),
                ('is_active', models.BooleanField(default=True)),
                ('display_name', models.CharField(blank=True, help_text='Name shown to customers', max_length=200)),
                ('display_badge', models.CharField(blank=True, help_text="Badge text (e.g., 'SALE', '-20%')", max_length=50)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('campaign', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='rules', to='promotions.promotioncampaign')),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_promotion_rules', to=settings.AUTH_USER_MODEL)),
                ('currency', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, to='billing.currency')),
            ],
            options={
                'verbose_name': 'Promotion Rule',
                'verbose_name_plural': 'Promotion Rules',
                'db_table': 'promotion_rules',
                'ordering': ('priority', '-created_at'),
            },
        ),
        migrations.CreateModel(
            name='ReferralCode',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('code', models.CharField(db_index=True, help_text='Unique referral code', max_length=50, unique=True)),
                ('referrer_discount_percent', models.DecimalField(decimal_places=2, default=Decimal('10.00'), help_text='Discount for referrer on next order', max_digits=5)),
                ('referrer_credit_cents', models.BigIntegerField(blank=True, help_text='Account credit for referrer in cents', null=True)),
                ('referee_discount_percent', models.DecimalField(decimal_places=2, default=Decimal('10.00'), help_text='Discount for new customer on first order', max_digits=5)),
                ('referee_credit_cents', models.BigIntegerField(blank=True, help_text='Account credit for new customer in cents', null=True)),
                ('total_referrals', models.PositiveIntegerField(default=0)),
                ('successful_referrals', models.PositiveIntegerField(default=0)),
                ('total_rewards_cents', models.BigIntegerField(default=0)),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('owner', models.OneToOneField(help_text='Customer who owns this referral code', on_delete=django.db.models.deletion.CASCADE, related_name='referral_code', to='customers.customer')),
                ('referee_coupon', models.OneToOneField(blank=True, help_text='Coupon used by referees', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='referral_code', to='promotions.coupon')),
            ],
            options={
                'verbose_name': 'Referral Code',
                'verbose_name_plural': 'Referral Codes',
                'db_table': 'promotion_referral_codes',
                'ordering': ('-created_at',),
            },
        ),
        migrations.CreateModel(
            name='Referral',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('status', models.CharField(choices=[('pending', 'Pending First Order'), ('qualified', 'Qualified (Order Placed)'), ('rewarded', 'Rewarded'), ('expired', 'Expired'), ('cancelled', 'Cancelled')], default='pending', max_length=20)),
                ('referrer_reward_cents', models.BigIntegerField(default=0)),
                ('referee_reward_cents', models.BigIntegerField(default=0)),
                ('referrer_reward_given_at', models.DateTimeField(blank=True, null=True)),
                ('referee_reward_given_at', models.DateTimeField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('qualified_at', models.DateTimeField(blank=True, null=True)),
                ('rewarded_at', models.DateTimeField(blank=True, null=True)),
                ('qualifying_order', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='referral_qualifications', to='orders.order')),
                ('referred_customer', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='referred_by', to='customers.customer')),
                ('referral_code', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='referrals', to='promotions.referralcode')),
            ],
            options={
                'verbose_name': 'Referral',
                'verbose_name_plural': 'Referrals',
                'db_table': 'promotion_referrals',
                'ordering': ('-created_at',),
            },
        ),
        migrations.AddIndex(
            model_name='couponredemption',
            index=models.Index(fields=['coupon', '-created_at'], name='promotion_c_coupon__2b231b_idx'),
        ),
        migrations.AddIndex(
            model_name='couponredemption',
            index=models.Index(fields=['order'], name='promotion_c_order_i_977858_idx'),
        ),
        migrations.AddIndex(
            model_name='couponredemption',
            index=models.Index(fields=['customer', '-created_at'], name='promotion_c_custome_d50eb0_idx'),
        ),
        migrations.AddIndex(
            model_name='couponredemption',
            index=models.Index(fields=['status', '-created_at'], name='promotion_c_status_221a84_idx'),
        ),
        migrations.AddIndex(
            model_name='couponredemption',
            index=models.Index(fields=['applied_at'], name='promotion_c_applied_9017cd_idx'),
        ),
        migrations.AddIndex(
            model_name='couponredemption',
            index=models.Index(fields=['coupon', 'status', '-applied_at'], name='idx_redemption_analytics'),
        ),
        migrations.AddIndex(
            model_name='couponredemption',
            index=models.Index(fields=['customer', 'status'], name='idx_redemption_customer'),
        ),
        migrations.AddConstraint(
            model_name='couponredemption',
            constraint=models.UniqueConstraint(fields=('coupon', 'order'), name='unique_coupon_per_order'),
        ),
        migrations.AddIndex(
            model_name='giftcard',
            index=models.Index(fields=['code'], name='promotion_g_code_0e7148_idx'),
        ),
        migrations.AddIndex(
            model_name='giftcard',
            index=models.Index(fields=['status', 'is_active'], name='promotion_g_status_085e2b_idx'),
        ),
        migrations.AddIndex(
            model_name='giftcard',
            index=models.Index(fields=['redeemed_by'], name='promotion_g_redeeme_b5d418_idx'),
        ),
        migrations.AddIndex(
            model_name='giftcard',
            index=models.Index(fields=['purchased_by'], name='promotion_g_purchas_eab431_idx'),
        ),
        migrations.AddIndex(
            model_name='giftcard',
            index=models.Index(fields=['valid_until'], name='promotion_g_valid_u_050323_idx'),
        ),
        migrations.AddIndex(
            model_name='giftcardtransaction',
            index=models.Index(fields=['gift_card', '-created_at'], name='promotion_g_gift_ca_469da0_idx'),
        ),
        migrations.AddIndex(
            model_name='giftcardtransaction',
            index=models.Index(fields=['transaction_type', '-created_at'], name='promotion_g_transac_4d0bbc_idx'),
        ),
        migrations.AddIndex(
            model_name='giftcardtransaction',
            index=models.Index(fields=['order'], name='promotion_g_order_i_dec716_idx'),
        ),
        migrations.AlterUniqueTogether(
            name='loyaltytier',
            unique_together={('program', 'slug')},
        ),
        migrations.AddIndex(
            model_name='customerloyalty',
            index=models.Index(fields=['customer', 'program'], name='promotion_c_custome_5199c7_idx'),
        ),
        migrations.AddIndex(
            model_name='customerloyalty',
            index=models.Index(fields=['current_tier'], name='promotion_c_current_477ff3_idx'),
        ),
        migrations.AddIndex(
            model_name='customerloyalty',
            index=models.Index(fields=['points_balance'], name='promotion_c_points__6f6e84_idx'),
        ),
        migrations.AlterUniqueTogether(
            name='customerloyalty',
            unique_together={('customer', 'program')},
        ),
        migrations.AddIndex(
            model_name='loyaltytransaction',
            index=models.Index(fields=['customer_loyalty', '-created_at'], name='promotion_l_custome_cfd2d4_idx'),
        ),
        migrations.AddIndex(
            model_name='loyaltytransaction',
            index=models.Index(fields=['transaction_type', '-created_at'], name='promotion_l_transac_d7b90a_idx'),
        ),
        migrations.AddIndex(
            model_name='loyaltytransaction',
            index=models.Index(fields=['order'], name='promotion_l_order_i_7e64a6_idx'),
        ),
        migrations.AddIndex(
            model_name='loyaltytransaction',
            index=models.Index(fields=['expires_at'], name='promotion_l_expires_e0740c_idx'),
        ),
        migrations.AddIndex(
            model_name='promotioncampaign',
            index=models.Index(fields=['slug'], name='promotion_c_slug_ca4364_idx'),
        ),
        migrations.AddIndex(
            model_name='promotioncampaign',
            index=models.Index(fields=['status', 'is_active'], name='promotion_c_status_0f0ff4_idx'),
        ),
        migrations.AddIndex(
            model_name='promotioncampaign',
            index=models.Index(fields=['start_date', 'end_date'], name='promotion_c_start_d_c6ed6d_idx'),
        ),
        migrations.AddIndex(
            model_name='promotioncampaign',
            index=models.Index(fields=['campaign_type', 'status'], name='promotion_c_campaig_57b9f2_idx'),
        ),
        migrations.AddIndex(
            model_name='coupon',
            index=models.Index(fields=['code'], name='promotion_c_code_53e22b_idx'),
        ),
        migrations.AddIndex(
            model_name='coupon',
            index=models.Index(fields=['status', 'is_active'], name='promotion_c_status_cbc397_idx'),
        ),
        migrations.AddIndex(
            model_name='coupon',
            index=models.Index(fields=['valid_from', 'valid_until'], name='promotion_c_valid_f_5a9b92_idx'),
        ),
        migrations.AddIndex(
            model_name='coupon',
            index=models.Index(fields=['discount_type'], name='promotion_c_discoun_328c8c_idx'),
        ),
        migrations.AddIndex(
            model_name='coupon',
            index=models.Index(fields=['campaign'], name='promotion_c_campaig_24b46f_idx'),
        ),
        migrations.AddIndex(
            model_name='coupon',
            index=models.Index(fields=['customer_target'], name='promotion_c_custome_f64143_idx'),
        ),
        migrations.AddIndex(
            model_name='coupon',
            index=models.Index(fields=['assigned_customer'], name='promotion_c_assigne_d0261c_idx'),
        ),
        migrations.AddIndex(
            model_name='coupon',
            index=models.Index(fields=['created_at'], name='promotion_c_created_f5ad2d_idx'),
        ),
        migrations.AddIndex(
            model_name='coupon',
            index=models.Index(fields=['is_active', 'status', 'valid_from', 'valid_until'], name='idx_coupon_validity'),
        ),
        migrations.AddIndex(
            model_name='coupon',
            index=models.Index(fields=['is_public', 'is_active', 'status'], name='idx_coupon_public'),
        ),
        migrations.AddIndex(
            model_name='promotionrule',
            index=models.Index(fields=['rule_type', 'is_active'], name='promotion_r_rule_ty_a4d8d1_idx'),
        ),
        migrations.AddIndex(
            model_name='promotionrule',
            index=models.Index(fields=['valid_from', 'valid_until'], name='promotion_r_valid_f_ee4667_idx'),
        ),
        migrations.AddIndex(
            model_name='promotionrule',
            index=models.Index(fields=['priority'], name='promotion_r_priorit_1826ce_idx'),
        ),
        migrations.AddIndex(
            model_name='promotionrule',
            index=models.Index(fields=['campaign'], name='promotion_r_campaig_e2ae2d_idx'),
        ),
        migrations.AddIndex(
            model_name='referralcode',
            index=models.Index(fields=['code'], name='promotion_r_code_a8ce92_idx'),
        ),
        migrations.AddIndex(
            model_name='referralcode',
            index=models.Index(fields=['owner'], name='promotion_r_owner_i_a3f4f3_idx'),
        ),
        migrations.AddIndex(
            model_name='referralcode',
            index=models.Index(fields=['is_active'], name='promotion_r_is_acti_41b2f7_idx'),
        ),
        migrations.AddIndex(
            model_name='referral',
            index=models.Index(fields=['referral_code', 'status'], name='promotion_r_referra_769925_idx'),
        ),
        migrations.AddIndex(
            model_name='referral',
            index=models.Index(fields=['referred_customer'], name='promotion_r_referre_d6cab6_idx'),
        ),
        migrations.AddIndex(
            model_name='referral',
            index=models.Index(fields=['status', '-created_at'], name='promotion_r_status_5345b2_idx'),
        ),
    ]
