#!/bin/bash
# PRAHO S3 Backup Sync Script
# Syncs local Virtualmin backups to S3 for offsite storage
# Generated by PRAHO Ansible deployment

set -euo pipefail

S3_BUCKET="{{ backup_s3_bucket }}"
S3_PREFIX="{{ backup_s3_prefix }}{{ inventory_hostname }}"
LOCAL_BACKUP_DIR="{{ backup_local_path | default('/var/backups/virtualmin') }}"
RETENTION_DAYS="{{ backup_retention_days | default(7) }}"
LOG_TAG="PRAHO-S3-BACKUP"

log() {
    echo "[$LOG_TAG] $(date '+%Y-%m-%d %H:%M:%S') $1"
}

log "Starting S3 backup sync"

if [ ! -d "$LOCAL_BACKUP_DIR" ]; then
    log "ERROR: Local backup directory does not exist: $LOCAL_BACKUP_DIR"
    exit 1
fi

# Sync local backups to S3
log "Syncing $LOCAL_BACKUP_DIR to s3://$S3_BUCKET/$S3_PREFIX/"
aws s3 sync "$LOCAL_BACKUP_DIR" "s3://$S3_BUCKET/$S3_PREFIX/" \
    --storage-class STANDARD_IA \
    --no-progress \
    --only-show-errors

# Clean old S3 objects beyond retention period
log "Cleaning S3 objects older than $RETENTION_DAYS days"
aws s3 ls "s3://$S3_BUCKET/$S3_PREFIX/" --recursive | \
    awk -v date="$(date -d "-${RETENTION_DAYS} days" +%Y-%m-%d 2>/dev/null || date -v-${RETENTION_DAYS}d +%Y-%m-%d)" \
    '$1 < date {print $4}' | \
    while IFS= read -r key; do
        if [ -n "$key" ]; then
            aws s3 rm "s3://$S3_BUCKET/$key" --only-show-errors
        fi
    done

log "S3 backup sync completed successfully"
