{% extends "base.html" %}
{% load i18n ui_components formatting %}

{% block title %}{% trans "Checkout" %}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  
  <!-- Breadcrumbs -->
  {% include "orders/partials/order_breadcrumbs.html" with current_step="checkout" %}
  
  <!-- Page Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-white mb-2">üí≥ {% trans "Checkout" %}</h1>
    <p class="text-slate-400">{% trans "Final step - validate and create order ready for payment" %}</p>
  </div>
  
  <!-- Trust Signals -->
  {% include "orders/partials/trust_signals.html" %}
  
  <div class="grid lg:grid-cols-3 gap-8">
    
    <!-- Order Form -->
    <div class="lg:col-span-2">
      <div class="bg-slate-800 rounded-lg border border-slate-700">
        
        <!-- Form Header -->
        <div class="px-6 py-4 border-b border-slate-700">
          <h2 class="text-lg font-medium text-white">{% trans "Order Details" %}</h2>
          <p class="text-sm text-slate-400 mt-1">
            {% trans "Order will be validated and created ready for payment" %}
          </p>
        </div>
        
        <!-- Order Creation Form -->
        <form method="post" action="{% url 'orders:create_order' %}" class="p-6">
          {% csrf_token %}
          <input type="hidden" name="cart_version" value="{{ cart.get_cart_version }}">
          
          <!-- MVP Info Box -->
          <!-- Preflight Status -->
          {% if preflight %}
            {% if preflight.valid %}
              <div class="bg-green-900/30 border border-green-700/50 rounded-lg p-4 mb-6">
                <div class="flex items-start">
                  <span class="text-green-400 mr-3 mt-0.5">‚úÖ</span>
                  <div>
                    <h3 class="text-green-400 font-medium mb-1">{% trans "Order Validated" %}</h3>
                    <p class="text-green-300 text-sm leading-relaxed">
                      {% trans "Order has been validated and can be created. It will be ready for payment immediately after confirmation." %}
                    </p>
                  </div>
                </div>
              </div>
            {% else %}
              <div class="bg-red-900/30 border border-red-700/50 rounded-lg p-4 mb-6">
                <div class="flex items-start">
                  <span class="text-red-400 mr-3 mt-0.5">‚ùå</span>
                  <div>
                    <h3 class="text-red-400 font-medium mb-1">{% trans "Validation Errors" %}</h3>
                    <p class="text-red-300 text-sm leading-relaxed mb-3">
                      {% trans "Order cannot be processed for the following reasons:" %}
                    </p>
                    <ul class="text-red-300 text-sm space-y-1">
                      {% for error in preflight.errors %}
                      <li class="flex items-start">
                        <span class="mr-2 mt-0.5">‚Ä¢</span>
                        {{ error }}
                      </li>
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              </div>
            {% endif %}
          {% else %}
            <div class="bg-yellow-900/30 border border-yellow-700/50 rounded-lg p-4 mb-6">
              <div class="flex items-start">
                <span class="text-yellow-400 mr-3 mt-0.5">‚ö†Ô∏è</span>
                <div>
                  <h3 class="text-yellow-400 font-medium mb-1">{% trans "Validation in Progress" %}</h3>
                  <p class="text-yellow-300 text-sm leading-relaxed">
                    {% trans "Order validation is currently in progress..." %}
                  </p>
                </div>
              </div>
            </div>
          {% endif %}
          
          <!-- Order Notes -->
          <div class="mb-6">
            <label for="notes" class="block text-sm font-medium text-white mb-2">
              {% trans "Note pentru comandƒÉ" %}
              <span class="text-slate-400 font-normal">({% trans "op»õional" %})</span>
            </label>
            <textarea id="notes" 
                      name="notes" 
                      rows="4"
                      maxlength="500"
                      placeholder="{% trans 'Orice informa»õii suplimentare despre comandƒÉ...' %}"
                      class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"></textarea>
            <p class="text-xs text-slate-400 mt-1">
              {% trans "Maxim 500 de caractere" %}
            </p>
          </div>
          
          <!-- Order Items Summary -->
          <div class="mb-6">
            <h3 class="text-sm font-medium text-white mb-3">{% trans "Produse comandate" %}</h3>
            <div class="bg-slate-700/30 rounded-lg p-4 space-y-3">
              {% for item in cart_items %}
              <div class="flex items-center justify-between text-sm">
                <div class="flex-1">
                  <span class="text-white">{{ item.product_name }}</span>
                  <div class="text-slate-400 text-xs mt-1">
                    {{ item.quantity }}x ‚Ä¢ {{ item.billing_period|title }}
                    {% if item.domain_name %}‚Ä¢ {{ item.domain_name }}{% endif %}
                  </div>
                </div>
                {% badge item.product_type|title variant="secondary" size="xs" %}
              </div>
              {% endfor %}
            </div>
          </div>
          
          <!-- Warnings Display -->
          {% if warnings %}
          <div class="mb-6">
            {% for warning in warnings %}
            {% if warning.type == 'price_change' %}
            {% alert warning.message variant="warning" title="Aten»õie - Pre»õ actualizat" %}
            {% endif %}
            {% endfor %}
          </div>
          {% endif %}
          
          <!-- Terms and Conditions -->
          <div class="mb-6">
            <div class="flex items-start">
              {% checkbox_field "agree_terms" label="Sunt de acord cu termenii »ôi condi»õiile de utilizare" required=True %}
            </div>
            <p class="text-xs text-slate-400 mt-2 ml-8">
              {% trans "Prin continuare, confirma»õi cƒÉ accepta»õi" %}
              <a href="/terms/" class="text-blue-400 hover:text-blue-300 underline">{% trans "termenii »ôi condi»õiile" %}</a>
              {% trans "serviciilor noastre de hosting." %}
            </p>
          </div>
          
          <!-- Submit Button -->
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <a href="{% url 'orders:cart_review' %}" 
               class="text-slate-400 hover:text-slate-300 text-sm transition-colors">
              ‚Üê {% trans "√énapoi la co»ô" %}
            </a>
            
            {% if can_submit %}
              {% button "üöÄ CreeazƒÉ comanda" variant="success" size="lg" type="submit" class="sm:w-auto w-full" %}
            {% else %}
              <button type="button" 
                      disabled 
                      class="sm:w-auto w-full inline-flex items-center justify-center px-6 py-3 text-lg font-medium text-slate-300 bg-slate-700 border border-slate-600 rounded-lg cursor-not-allowed opacity-50">
                üöÄ {% trans "CreeazƒÉ comanda" %}
              </button>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
    
    <!-- Order Summary -->
    <div class="lg:col-span-1">
      <div class="bg-slate-800 rounded-lg border border-slate-700 sticky top-8">
        
        <!-- Include calculated totals -->
        {% if calculation %}
        <div class="p-6">
          <h3 class="text-lg font-medium text-white mb-4">{% trans "Rezumat final" %}</h3>
          
          <!-- Order Totals -->
          <div class="space-y-3 mb-6">
            <div class="flex justify-between items-center">
              <span class="text-slate-400">{% trans "Subtotal" %}</span>
              <span class="text-white font-mono">
                {{ calculation.subtotal_cents|cents_to_currency|romanian_currency:calculation.currency }}
              </span>
            </div>
            
            <div class="flex justify-between items-center">
              <span class="text-slate-400">{% trans "TVA (21%)" %}</span>
              <span class="text-white font-mono">
                {{ calculation.tax_cents|cents_to_currency|romanian_currency:calculation.currency }}
              </span>
            </div>
            
            <div class="border-t border-slate-600 pt-3">
              <div class="flex justify-between items-center">
                <span class="text-lg font-medium text-white">{% trans "Total" %}</span>
                <span class="text-lg font-bold text-green-400 font-mono">
                  {{ calculation.total_cents|cents_to_currency|romanian_currency:calculation.currency }}
                </span>
              </div>
            </div>
          </div>
          
          <!-- Next Steps Info -->
          <div class="bg-green-900/20 border border-green-700/30 rounded-lg p-3">
            <h4 class="text-green-400 font-medium text-sm mb-2">{% trans "Pa»ôii urmƒÉtori" %}</h4>
            <ol class="text-green-300 text-xs space-y-1 list-decimal list-inside">
              <li>{% trans "Comanda va fi validatƒÉ »ôi creatƒÉ" %}</li>
              <li>{% trans "Ve»õi primi confirmarea pe email" %}</li>
              <li>{% trans "Comanda va fi gata pentru platƒÉ" %}</li>
              <li>{% trans "Serviciile vor fi activate dupƒÉ platƒÉ" %}</li>
            </ol>
          </div>
        </div>
        {% else %}
        <!-- Error loading totals -->
        <div class="p-6 text-center">
          <div class="text-red-400 mb-3">‚ö†Ô∏è</div>
          <p class="text-red-400 text-sm">
            {% trans "Eroare la √ÆncƒÉrcarea totalurilor" %}
          </p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
