{% extends 'base.html' %}
{% load i18n %}
{% load ui_components %}

{% block title %}{% trans 'Two-Factor Authentication' %} - PragmaticHost{% endblock %}

{% block content %}
<div class="px-4 py-6 max-w-4xl mx-auto">
  <!-- Header -->
  <div class="mb-6">
    <h1 class="text-2xl font-bold text-white romanian-flag">
      ğŸ” {% trans 'Two-Factor Authentication' %}
    </h1>
    <p class="mt-2 text-sm text-slate-400">
      {% trans 'Manage your account security and two-factor authentication settings' %}
    </p>
  </div>

  <!-- Current MFA Status -->
  <div class="bg-slate-800 shadow-sm ring-1 ring-slate-700 rounded-lg mb-6">
    <div class="p-6">
      <h3 class="text-lg font-medium text-white mb-6">
        ğŸ›¡ï¸ {% trans 'Current Security Status' %}
      </h3>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- MFA Status -->
        <div class="space-y-4">
          <div>
            <dt class="text-sm font-medium text-slate-400">{% trans 'Two-Factor Authentication' %}</dt>
            <dd class="mt-1 text-sm">
              {% if mfa_enabled %}
                {% badge "Enabled" variant="success" icon="ğŸ”’" %}
                <p class="mt-2 text-xs text-green-400">
                  {% trans 'Your account is protected with MFA' %}
                </p>
              {% else %}
                {% badge "Disabled" variant="warning" icon="âš ï¸" %}
                <p class="mt-2 text-xs text-yellow-400">
                  {% trans 'Your account is not protected with MFA' %}
                </p>
              {% endif %}
            </dd>
          </div>

          {% if mfa_enabled %}
          <div>
            <dt class="text-sm font-medium text-slate-400">{% trans 'Active Methods' %}</dt>
            <dd class="mt-1 text-sm">
              <div class="space-y-2">
                {% if profile.totp_enabled %}
                <div class="flex items-center text-green-400">
                  <span class="mr-2">ğŸ“±</span>
                  {% trans 'Authenticator App' %}
                </div>
                {% endif %}
                {% if profile.webauthn_enabled %}
                <div class="flex items-center text-green-400">
                  <span class="mr-2">ğŸ”‘</span>
                  {% trans 'Passkeys/Hardware Keys' %}
                </div>
                {% endif %}
              </div>
            </dd>
          </div>
          {% endif %}
        </div>

        <!-- Last Activity -->
        <div class="space-y-4">
          <div>
            <dt class="text-sm font-medium text-slate-400">{% trans 'Last Login' %}</dt>
            <dd class="mt-1 text-sm text-white">
              {% if profile.last_login %}
                {{ profile.last_login|date:"d.m.Y H:i" }}
              {% else %}
                <span class="text-slate-500">{% trans 'Never' %}</span>
              {% endif %}
            </dd>
          </div>

          {% if mfa_enabled %}
          <div>
            <dt class="text-sm font-medium text-slate-400">{% trans 'Backup Codes Available' %}</dt>
            <dd class="mt-1 text-sm">
              {% if profile.backup_codes_count|default:0 > 0 %}
                {% badge profile.backup_codes_count|default:"0" variant="info" icon="ğŸ”¢" %}
                <p class="mt-1 text-xs text-slate-400">
                  {% trans 'codes remaining' %}
                </p>
              {% else %}
                {% badge "None" variant="warning" icon="âš ï¸" %}
                <p class="mt-1 text-xs text-yellow-400">
                  {% trans 'Generate backup codes for account recovery' %}
                </p>
              {% endif %}
            </dd>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- MFA Management Actions -->
  <div class="bg-slate-800 shadow-sm ring-1 ring-slate-700 rounded-lg">
    <div class="p-6">
      <h3 class="text-lg font-medium text-white mb-6">
        âš™ï¸ {% trans 'Manage MFA Settings' %}
      </h3>

      {% if not mfa_enabled %}
      <!-- Enable MFA Section -->
      <div class="space-y-6">
        <div class="bg-blue-900/20 border border-blue-700/50 rounded-lg p-6">
          <div class="flex items-center mb-4">
            <span class="text-blue-400 text-2xl mr-3">ğŸ›¡ï¸</span>
            <div>
              <h4 class="text-lg font-medium text-white">{% trans 'Enable Two-Factor Authentication' %}</h4>
              <p class="text-sm text-slate-300">{% trans 'Protect your account with an additional security layer' %}</p>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
            <!-- TOTP Method -->
            <div class="bg-slate-700 rounded-lg p-4 border border-slate-600 hover:border-blue-500 transition-colors">
              <div class="text-center">
                <div class="text-3xl mb-3">ğŸ“±</div>
                <h5 class="font-medium text-white mb-2">{% trans 'Authenticator App' %}</h5>
                <p class="text-xs text-slate-400 mb-4">{% trans 'Google Authenticator, Authy, Microsoft Authenticator' %}</p>

                <div class="text-left mb-4 space-y-1">
                  <div class="flex items-center text-green-400 text-xs">
                    <span class="mr-1">âœ…</span>
                    {% trans 'Works offline' %}
                  </div>
                  <div class="flex items-center text-green-400 text-xs">
                    <span class="mr-1">âœ…</span>
                    {% trans 'Very secure' %}
                  </div>
                </div>

                <p class="text-center text-xs text-slate-400 mb-4">
                  {% trans 'Set up time-based codes with your favorite authenticator app.' %}
                </p>

                <a href="{% url 'users:mfa_setup_totp' %}"
                   class="inline-block w-full bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-4 rounded transition-colors text-center">
                  {% trans 'Set Up Authenticator App' %}
                </a>
              </div>
            </div>

            <!-- WebAuthn Method -->
            <div class="bg-slate-700 rounded-lg p-4 border border-slate-600 hover:border-green-500 transition-colors relative">
              <!-- Recommended Badge -->
              <div class="absolute -top-2 left-1/2 transform -translate-x-1/2">
                <span class="bg-green-600 text-white text-xs font-bold px-2 py-1 rounded-full">
                  {% trans 'RECOMMENDED' %}
                </span>
              </div>

              <div class="text-center">
                <div class="text-3xl mb-3">ğŸ”‘</div>
                <h5 class="font-medium text-white mb-2">{% trans 'Passkeys' %}</h5>
                <p class="text-xs text-slate-400 mb-4">{% trans 'Face ID, Touch ID, fingerprint, hardware keys' %}</p>

                <div class="text-left mb-4 space-y-1">
                  <div class="flex items-center text-green-400 text-xs">
                    <span class="mr-1">âœ…</span>
                    {% trans 'Most secure' %}
                  </div>
                  <div class="flex items-center text-green-400 text-xs">
                    <span class="mr-1">âœ…</span>
                    {% trans 'Fastest login' %}
                  </div>
                </div>

                <p class="text-center text-xs text-slate-400 mb-4">
                  {% trans 'Contact support to enable passkey MFA for your account.' %}
                </p>

                <button disabled
                   class="inline-block w-full bg-slate-600 text-slate-400 text-sm font-medium py-2 px-4 rounded cursor-not-allowed">
                  {% trans 'Contact Support to Enable' %}
                </button>
              </div>
            </div>
          </div>

          <!-- Security Benefits -->
          <div class="mt-6 p-4 bg-slate-900 rounded-lg border border-slate-600">
            <h5 class="text-sm font-medium text-white mb-3">{% trans 'Why enable MFA?' %}</h5>
            <ul class="list-disc list-inside text-xs text-slate-300 space-y-1">
              <li>{% trans 'Protects against password breaches' %}</li>
              <li>{% trans 'Prevents unauthorized access' %}</li>
              <li>{% trans 'Required for admin and billing access' %}</li>
              <li>{% trans 'Industry standard security practice' %}</li>
            </ul>
          </div>
        </div>
      </div>

      {% else %}
      <!-- Manage Existing MFA Section -->
      <div class="space-y-6">
        <!-- Current Methods -->
        <div class="bg-green-900/20 border border-green-700/50 rounded-lg p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center">
              <span class="text-green-400 text-2xl mr-3">âœ…</span>
              <div>
                <h4 class="text-lg font-medium text-white">{% trans 'MFA is Active' %}</h4>
                <p class="text-sm text-slate-300">{% trans 'Your account is protected' %}</p>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
            <!-- Backup Codes -->
            <a href="{% url 'users:mfa_backup_codes' %}"
               class="flex flex-col items-center p-4 bg-slate-700 hover:bg-slate-600 rounded-lg border border-slate-600 hover:border-blue-500 transition-colors">
              <span class="text-2xl mb-2">ğŸ”¢</span>
              <span class="text-sm font-medium text-white">{% trans 'Backup Codes' %}</span>
              <span class="text-xs text-slate-400 text-center">{% trans 'View or regenerate recovery codes' %}</span>
            </a>

            <!-- Add Method -->
            <a href="{% url 'users:mfa_setup_totp' %}"
               class="flex flex-col items-center p-4 bg-slate-700 hover:bg-slate-600 rounded-lg border border-slate-600 hover:border-green-500 transition-colors">
              <span class="text-2xl mb-2">â•</span>
              <span class="text-sm font-medium text-white">{% trans 'Add Method' %}</span>
              <span class="text-xs text-slate-400 text-center">{% trans 'Set up additional MFA methods' %}</span>
            </a>

            <!-- Disable MFA -->
            <form method="post" action="{% url 'users:mfa_disable' %}"
                  onsubmit="return confirm('{% trans 'Are you sure you want to disable two-factor authentication? This will make your account less secure.' %}')"
                  class="flex flex-col items-center p-4 bg-red-900/30 hover:bg-red-900/50 rounded-lg border border-red-700 hover:border-red-500 transition-colors cursor-pointer">
              {% csrf_token %}
              <button type="submit" class="flex flex-col items-center w-full text-center bg-transparent border-none p-0 cursor-pointer">
                <span class="text-2xl mb-2">ğŸš«</span>
                <span class="text-sm font-medium text-red-300">{% trans 'Disable MFA' %}</span>
                <span class="text-xs text-red-400 text-center">{% trans 'Turn off two-factor authentication' %}</span>
              </button>
            </form>
          </div>
        </div>

        <!-- Important Security Notice -->
        <div class="bg-blue-900/20 border border-blue-700/50 rounded-lg p-4">
          <div class="flex items-start">
            <span class="text-blue-400 text-lg mr-3">â„¹ï¸</span>
            <div>
              <h5 class="text-sm font-medium text-blue-300">{% trans 'Need Help with MFA?' %}</h5>
              <p class="text-xs text-blue-200 mt-1">
                {% trans 'Contact our support team to enable, disable, or manage your two-factor authentication settings. We\'ll help you secure your account safely.' %}
              </p>
              <div class="mt-2">
                <a href="mailto:support@pragmatichost.com" class="text-blue-400 hover:text-blue-300 text-xs font-medium">
                  ğŸ“§ support@pragmatichost.com
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Back Navigation -->
  <div class="mt-6 text-center">
    <a href="{% url 'users:profile' %}"
       class="text-blue-400 hover:text-blue-300 text-sm">
      â† {% trans 'Back to Profile' %}
    </a>
  </div>
</div>
{% endblock %}
