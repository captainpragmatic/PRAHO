# ===============================================================================
# PRAHO PLATFORM - PRE-COMMIT CONFIGURATION
# ===============================================================================
# Purpose: Maintain type safety and code quality during development
# Strategy: Fast feedback with gradual typing support

repos:
  # ===============================================================================
  # CORE PYTHON QUALITY - FAST CHECKS ‚ö°
  # ===============================================================================

  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
        exclude: ^migrations/.*\.py$
      - id: end-of-file-fixer
        exclude: ^migrations/.*\.py$
      - id: check-yaml
      - id: check-added-large-files
        args: ['--maxkb=1000']
      - id: check-merge-conflict
      - id: debug-statements
        exclude: ^(scripts/.*\.py|.*/management/commands/.*\.py)$
      - id: check-executables-have-shebangs
        # NOTE: Disabled in Docker (macOS VirtioFS bind mounts mark all files +x).
        # Runs correctly on host macOS where file permissions are real.
        stages: [manual]
      - id: check-shebang-scripts-are-executable
        exclude: \.j2$

  # ===============================================================================
  # RUFF - STRATEGIC LINTING ‚ö°üîí
  # ===============================================================================
  # Uses the strategic configuration from pyproject.toml
  # Focus: Performance, Security, Type Hints

  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.1.8
    hooks:
      # Auto-formatting (safe fixes only)
      - id: ruff-format
        name: "Auto-format Python Code"
        args: [--config=pyproject.toml]
        exclude: ^migrations/.*\.py$

  # ===============================================================================
  # TYPE SAFETY - GRADUAL IMPLEMENTATION üè∑Ô∏è
  # ===============================================================================

  - repo: local
    hooks:
      # Block only newly-introduced Ruff issues; tolerate historical debt.
      - id: ruff-new-violations
        name: "Ruff: Block New Violations Only"
        entry: uv run python
        args: [scripts/ruff_new_violations.py, --staged]
        language: system
        files: \.py$
        exclude: ^migrations/.*\.py$
        pass_filenames: true
        require_serial: true

      # Only check modified Python files for performance
      - id: type-check-modified
        name: "Type Check Modified Files"
        entry: uv run python
        args: [services/platform/scripts/check_types_modified.py, --staged]
        language: system
        files: \.py$
        exclude: ^(migrations/.*\.py|services/platform/scripts/backup\.py|services/platform/scripts/deploy\.py)$
        pass_filenames: false
        require_serial: false

      # Prevent new # type: ignore comments to avoid regression
      - id: prevent-type-ignore
        name: "Block New Type Ignore Comments"
        entry: uv run python
        args: [services/platform/scripts/prevent_type_ignore.py, --staged-only]
        language: system
        files: \.py$
        exclude: ^(migrations/.*\.py|tests/.*\.py)$
        pass_filenames: true
        stages: [pre-commit]

  # ===============================================================================
  # DJANGO TEMPLATE SAFETY üé®
  # ===============================================================================
  # Prevent the template comparison operator spacing issue

  - repo: local
    hooks:
      - id: django-template-check
        name: "Django Template Syntax Check"
        entry: uv run python
        args: [services/platform/scripts/fix_template_comparisons.py, --check]
        language: system
        files: \.html$
        exclude: ^(services/platform/static/|services/portal/static/|htmlcov/)

  # ===============================================================================
  # SECURITY CHECKS üîí
  # ===============================================================================

  - repo: local
    hooks:
      # Check portal doesn't import platform code
      - id: portal-isolation-check
        name: "Security: Portal Isolation Check"
        entry: bash
        args:
          - -c
          - |
            # Validate runtime import isolation from portal context.
            cd services/portal || exit 1
            if PYTHONPATH= PYTHONNOUSERSITE=1 ${UV_PROJECT_ENVIRONMENT}/bin/python -c "import apps.customers.customer_models" 2>/dev/null; then
              echo "‚ùå SECURITY BREACH: Portal can import apps.customers.customer_models"
              exit 1
            fi
            if PYTHONPATH= PYTHONNOUSERSITE=1 ${UV_PROJECT_ENVIRONMENT}/bin/python -c "import apps.billing.invoice_models" 2>/dev/null; then
              echo "‚ùå SECURITY BREACH: Portal can import apps.billing.invoice_models"
              exit 1
            fi
            if PYTHONPATH= PYTHONNOUSERSITE=1 ${UV_PROJECT_ENVIRONMENT}/bin/python -c "import apps.orders.signals_extended" 2>/dev/null; then
              echo "‚ùå SECURITY BREACH: Portal can import apps.orders.signals_extended"
              exit 1
            fi
            exit 0
        language: system
        files: ^services/portal/.*\.py$
        pass_filenames: false

      # Audit coverage regression check
      - id: audit-coverage-check
        name: "Security: Audit Coverage Check"
        entry: uv run python
        args: [scripts/audit_coverage_scan.py, --min-severity=high, --exclude-tests, services/platform/apps]
        language: system
        files: ^services/platform/apps/.*\.py$
        pass_filenames: false
        stages: [pre-commit]

      # Check for hardcoded credentials (warning only)
      - id: security-credentials-check
        name: "Security: Check for Hardcoded Credentials"
        entry: bash
        args:
          - -c
          - |
            # Use ruff to check for hardcoded credentials
            ${UV_PROJECT_ENVIRONMENT}/bin/ruff check --select=S105,S106,S107,S108 --output-format=concise --quiet $@ || true
            # Always pass - this is informational only
            exit 0
        language: system
        files: \.py$
        exclude: ^(tests/.*\.py|.*/management/commands/.*\.py|.*settings.*\.py)$
        pass_filenames: true
        verbose: true

  # ===============================================================================
  # i18n COVERAGE CHECK üåç
  # ===============================================================================

  - repo: local
    hooks:
      - id: i18n-coverage-check
        name: "i18n: Check for Unwrapped Strings"
        entry: uv run python
        args: [scripts/lint_i18n_coverage.py, --fail-on, high, --allowlist, scripts/i18n_coverage_allowlist.txt]
        language: system
        files: \.(py|html)$
        exclude: (migrations/|/tests/|^tests/|^scripts/|/scripts/)
        pass_filenames: true

  # ===============================================================================
  # PERFORMANCE ANALYSIS ‚ö°
  # ===============================================================================

  - repo: local
    hooks:
      # Check for performance anti-patterns in modified files
      - id: performance-check
        name: "Performance: Check for Anti-patterns"
        entry: bash
        args:
          - -c
          - |
            # Check for performance issues in modified files
            ${UV_PROJECT_ENVIRONMENT}/bin/ruff check --select=PERF,C90,PIE,SIM --output-format=concise --quiet $@ || true
            # Always pass - this is informational only
            exit 0
        language: system
        files: \.py$
        exclude: ^(migrations/.*\.py|tests/.*\.py)$
        pass_filenames: true
        verbose: true

# ===============================================================================
# CONFIGURATION OPTIONS ‚öôÔ∏è
# ===============================================================================

# Global settings
default_language_version:
  python: python3.11

# Hook execution settings
default_stages: [pre-commit]
fail_fast: false  # Run all hooks even if one fails
minimum_pre_commit_version: "3.0.0"

# CI/CD integration settings
ci:
  autofix_commit_msg: |
    [pre-commit.ci] auto fixes from pre-commit hooks

    for more information, see https://pre-commit.ci
  autofix_prs: true
  autoupdate_branch: ''
  autoupdate_commit_msg: '[pre-commit.ci] pre-commit autoupdate'
  autoupdate_schedule: weekly
  skip: []
  submodules: false
