{% extends 'base.html' %}
{% load ui_components %}
{% load settings_tags %}
{% load i18n %}

{% block title %}{% trans "Settings Management" %} - PRAHO Platform{% endblock %}

{% block content %}
<div class="px-4 py-6">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-white">⚙️ {% trans "Settings Management" %}</h1>
        <p class="mt-2 text-slate-400">
            {% trans "Configure and manage platform settings across different categories" %}
        </p>
    </div>

    {% if error %}
    <div class="bg-slate-800 rounded-lg border border-slate-700 mb-8">
        <div class="p-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <div class="text-xl">⚠️</div>
                </div>
                <div class="ml-3">
                    <h3 class="text-lg font-medium text-red-400">{% trans "Error Loading Settings" %}</h3>
                    <div class="mt-2 text-sm text-slate-400">{{ error }}</div>
                </div>
            </div>
        </div>
    </div>
    {% else %}

    <!-- Tab Navigation -->
    <div class="bg-slate-800 rounded-lg border border-slate-700 mb-8">
        <div class="border-b border-slate-700">
            <nav class="flex space-x-8 px-6" aria-label="Tabs">
                {% for category in categories %}
                <button
                    class="tab-button py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap transition-colors
                           {% if category.key == active_category %}
                           border-blue-500 text-blue-400
                           {% else %}
                           border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-300
                           {% endif %}"
                    data-category="{{ category.key }}"
                    hx-get="{% url 'settings:category_management_partial' category.key %}"
                    hx-target="#settings-content"
                    hx-indicator="#loading-indicator"
                    hx-swap="innerHTML"
                    hx-push-url="?category={{ category.key }}"
                >
                    <div class="flex items-center">
                        <div class="text-lg mr-2">
                            {% if category.key == 'billing' %}💰
                            {% elif category.key == 'users' %}👥
                            {% elif category.key == 'domains' %}🌐
                            {% elif category.key == 'provisioning' %}🚀
                            {% elif category.key == 'security' %}🔒
                            {% elif category.key == 'notifications' %}📧
                            {% elif category.key == 'integrations' %}🔗
                            {% elif category.key == 'system' %}⚙️
                            {% else %}📋{% endif %}
                        </div>
                        {{ category.name }}
                    </div>
                </button>
                {% endfor %}
            </nav>
        </div>

        <!-- Settings Content Area -->
        <div class="p-6">
            <!-- Loading Indicator -->
            <div id="loading-indicator" class="htmx-indicator">
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                    <span class="ml-3 text-slate-400">{% trans "Loading settings..." %}</span>
                </div>
            </div>

            <!-- Dynamic Content Container -->
            <div id="settings-content">
                {% if active_category %}
                    <!-- Load initial category content -->
                    <div hx-get="{% url 'settings:category_management_partial' active_category %}"
                         hx-trigger="load"
                         hx-target="this"
                         hx-indicator="#loading-indicator"
                         hx-swap="outerHTML">
                        <div class="flex items-center justify-center py-8">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                            <span class="ml-3 text-slate-400">{% trans "Loading settings..." %}</span>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-12">
                        <div class="text-slate-400 text-6xl mb-4">⚙️</div>
                        <h3 class="text-lg font-medium text-white mb-2">{% trans "Select a Category" %}</h3>
                        <p class="text-slate-400">{% trans "Choose a settings category from the tabs above to begin." %}</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-slate-800 rounded-lg border border-slate-700">
        <div class="p-6">
            <h3 class="text-lg font-medium text-white mb-4">⚡ {% trans "Quick Actions" %}</h3>
            <div class="flex flex-wrap gap-3">
                <button 
                    onclick="refreshCache()" 
                    class="inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 transition-all duration-200"
                >
                    🔄 {% trans "Refresh Cache" %}
                </button>
                <a 
                    href="{% url 'settings:export_settings' %}" 
                    class="inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-green-600 border border-green-600 rounded-lg hover:bg-green-700 focus:ring-4 focus:ring-green-300 transition-all duration-200"
                >
                    📥 {% trans "Export Settings" %}
                </a>
                <a 
                    href="{% url 'settings:dashboard' %}" 
                    class="inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-slate-600 border border-slate-600 rounded-lg hover:bg-slate-700 focus:ring-4 focus:ring-slate-300 transition-all duration-200"
                >
                    📊 {% trans "View Dashboard" %}
                </a>
            </div>
        </div>
    </div>

    {% endif %}
</div>

<script>
async function refreshCache() {
    try {
        const response = await fetch('{% url "settings:refresh_cache" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show success message and reload current tab content
            showToast('✅ Cache refreshed successfully!', 'success');
            // Trigger reload of current category
            const activeTab = document.querySelector('.tab-button.text-blue-400');
            if (activeTab) {
                activeTab.click();
            }
        } else {
            showToast('❌ Error refreshing cache: ' + (data.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showToast('❌ Network error: ' + error.message, 'error');
    }
}

function showToast(message, type = 'info') {
    // Simple toast notification - can be enhanced with PRAHO's toast component
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
        type === 'success' ? 'bg-green-600 text-white' : 
        type === 'error' ? 'bg-red-600 text-white' : 
        'bg-blue-600 text-white'
    }`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        toast.remove();
    }, 5000);
}

// Handle tab switching
document.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.target.id === 'settings-content') {
        // Update active tab styling
        const currentUrl = new URL(event.detail.requestConfig.path, window.location.origin);
        const categoryMatch = currentUrl.pathname.match(/\/manage\/category\/([^\/]+)\//);
        
        if (categoryMatch) {
            const activeCategory = categoryMatch[1];
            
            // Remove active state from all tabs
            document.querySelectorAll('.tab-button').forEach(tab => {
                tab.classList.remove('border-blue-500', 'text-blue-400');
                tab.classList.add('border-transparent', 'text-slate-400');
            });
            
            // Add active state to current tab
            const currentTab = document.querySelector(`[data-category="${activeCategory}"]`);
            if (currentTab) {
                currentTab.classList.remove('border-transparent', 'text-slate-400');
                currentTab.classList.add('border-blue-500', 'text-blue-400');
            }
        }
    }
});
</script>

{% csrf_token %}
{% endblock %}