{% load i18n %}
{% load ui_components %}
{% load formatting %}

<!-- Order Items Section with HTMX for real-time updates -->
<div id="order-items-section" class="bg-slate-800 rounded-lg border border-slate-700">
  <div class="px-6 py-4 border-b border-slate-700 flex items-center justify-between">
    <h3 class="text-lg font-semibold text-white">📦 {% trans "Order Items" %}</h3>
    {% comment %}
    Add Item button removed from order detail view to keep it truly read-only.
    Items should be added from the order edit page for better UX flow.
    {% endcomment %}
  </div>

  <div class="overflow-hidden">
    {% if order.items.all %}
      <!-- Mobile-first responsive table with horizontal scroll -->
      <div class="overflow-x-auto">
        <!-- Mobile scroll hint -->
        <div class="block sm:hidden text-xs text-slate-500 mb-2 px-6">
          <span class="mr-1">👈</span>{% trans "Swipe left to see actions" %}
        </div>
        <table class="min-w-full divide-y divide-slate-700">
        <thead class="bg-slate-900">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">
              {% trans "Product/Service" %}
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">
              {% trans "Quantity" %}
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">
              {% trans "Unit Price" %}
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">
              {% trans "Setup Fee" %}
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">
              {% trans "Total" %}
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">
              {% trans "Status" %}
            </th>
            {% comment %}
            Actions column will be included in each row based on edit_mode context variable
            {% endcomment %}
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider sticky right-0 bg-slate-900 border-l border-slate-700">
              <span class="block sm:hidden">🔧</span>
              <span class="hidden sm:block">{% trans "Actions" %}</span>
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-700">
          {% for item in order.items.all %}
          <tr class="hover:bg-slate-750 transition-colors" id="order-item-{{ item.id }}">
            {% comment %}Standard item row - always visible{% endcomment %}
            <td class="px-6 py-4">
              <div class="text-sm">
                {% if item.product %}
                  <div class="text-white font-medium">{{ item.product.name }}</div>
                  <div class="text-slate-400 text-xs">{{ item.product.product_type|title }}</div>
                {% else %}
                  <div class="text-white font-medium">{% trans "Custom Item" %}</div>
                {% endif %}
                {% if item.description %}
                  <div class="text-slate-500 text-xs mt-1">{{ item.description }}</div>
                {% endif %}
                {% if item.domain_name %}
                  <div class="text-blue-400 text-xs mt-1">
                    🌐 {{ item.domain_name }}
                  </div>
                {% endif %}
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-white">
              {{ item.quantity }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-white">
              {{ item.unit_price_cents|cents_to_currency|romanian_currency:order.currency }}
              {% if item.billing_period and item.billing_period != "one_time" %}
                <div class="text-xs text-slate-400">
                  /{{ item.get_billing_period_display|lower }}
                </div>
              {% endif %}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-white">
              {% if item.setup_cents > 0 %}
                {{ item.setup_cents|cents_to_currency|romanian_currency:order.currency }}
              {% else %}
                <span class="text-slate-500">{% trans "Free" %}</span>
              {% endif %}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-white font-semibold">
              {{ item.line_total_cents|cents_to_currency|romanian_currency:order.currency }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              {% if item.provisioning_status == "pending" %}
                {% badge "⏳ Pending" variant="warning" size="sm" %}
              {% elif item.provisioning_status == "in_progress" %}
                {% badge "⚙️ Provisioning" variant="primary" size="sm" %}
              {% elif item.provisioning_status == "completed" %}
                {% badge "✅ Active" variant="success" size="sm" %}
              {% elif item.provisioning_status == "failed" %}
                {% badge "🔥 Failed" variant="danger" size="sm" %}
              {% elif item.provisioning_status == "cancelled" %}
                {% badge "❌ Cancelled" variant="secondary" size="sm" %}
              {% else %}
                {% badge "📋 Not Started" variant="secondary" size="sm" %}
              {% endif %}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm sticky right-0 bg-slate-800 border-l border-slate-700">
              {% if request.resolver_match.url_name == 'order_edit' and order.status in "draft,pending" %}
                {% comment %}Edit mode - expandable row controls{% endcomment %}
                <div class="flex flex-col sm:flex-row space-y-1 sm:space-y-0 sm:space-x-2">
                  <button type="button"
                          onclick="toggleExpandableEdit('{{ item.id }}')"
                          class="inline-flex items-center justify-center px-2 py-1.5 text-xs font-medium rounded border border-blue-500 text-blue-400 hover:bg-blue-500 hover:text-white transition-colors min-h-[32px] sm:min-h-[28px]"
                          title="{% trans 'Edit item inline' %}"
                          id="edit-btn-{{ item.id }}">
                    <span class="mr-1">✏️</span>
                    <span class="block sm:hidden">{% trans "Edit" %}</span>
                    <span class="hidden sm:block">{% trans "Edit" %}</span>
                  </button>
                  <button type="button"
                          onclick="deleteOrderItem('{{ item.id }}')"
                          class="inline-flex items-center justify-center px-2 py-1.5 text-xs font-medium rounded border border-red-500 text-red-400 hover:bg-red-500 hover:text-white transition-colors min-h-[32px] sm:min-h-[28px]"
                          title="{% trans 'Delete item' %}">
                    <span class="mr-1">🗑️</span>
                    <span class="block sm:hidden">{% trans "Delete" %}</span>
                    <span class="hidden sm:block">{% trans "Delete" %}</span>
                  </button>
                </div>
              {% elif is_staff and order.status in "draft,pending" %}
                {% comment %}Detail view with edit access - show edit link{% endcomment %}
                <div class="text-sm">
                  <a href="{% url 'orders:order_edit' pk=order.id %}" 
                     class="text-blue-400 hover:text-blue-300 text-xs">
                    ✏️ {% trans "Edit Order" %}
                  </a>
                </div>
              {% else %}
                {% comment %}Read-only view{% endcomment %}
                <span class="text-slate-500 text-xs">{% trans "View only" %}</span>
              {% endif %}
            </td>
          </tr>
          
          {% comment %}Expandable edit row - hidden by default, shows when Edit is clicked{% endcomment %}
          {% if request.resolver_match.url_name == 'order_edit' and order.status in "draft,pending" %}
          <tr id="edit-row-{{ item.id }}" class="hidden bg-slate-900 border-l-4 border-blue-500">
            <td colspan="7" class="px-6 py-4">
              <div class="bg-slate-800 rounded-lg border border-slate-600 p-4">
                <div class="flex items-center justify-between mb-4">
                  <h4 class="text-sm font-medium text-white">
                    <span class="mr-2">✏️</span>{% trans "Edit Item" %}: {{ item.product.name|default:"Custom Item" }}
                  </h4>
                  <button type="button"
                          onclick="cancelExpandableEdit('{{ item.id }}')"
                          class="text-slate-400 hover:text-white text-sm">
                    <span class="mr-1">❌</span>{% trans "Cancel" %}
                  </button>
                </div>
                
                {% comment %}Inline edit form container - will be populated via HTMX{% endcomment %}
                <div id="inline-edit-form-{{ item.id }}" class="space-y-4">
                  {% comment %}Form content will be loaded here{% endcomment %}
                  <div class="flex items-center justify-center py-4">
                    <div class="animate-spin rounded-full h-6 w-6 border-2 border-blue-500 border-t-transparent"></div>
                    <span class="ml-2 text-sm text-slate-400">{% trans "Loading edit form..." %}</span>
                  </div>
                </div>
              </div>
            </td>
          </tr>
          {% endif %}
          {% endfor %}
        </tbody>
      </table>
      </div> <!-- Close overflow-x-auto -->

      <!-- Order Totals -->
      <div class="px-6 py-4 bg-slate-900 border-t border-slate-700">
        <div class="flex justify-end">
          <div class="text-right space-y-1">
            <div class="flex items-center justify-between min-w-64">
              <span class="text-sm text-slate-400">{% trans "Subtotal:" %}</span>
              <span class="text-sm text-white" id="order-subtotal">
                {{ order.subtotal_cents|cents_to_currency|romanian_currency:order.currency }}
              </span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm text-slate-400">{% trans "VAT (19%):" %}</span>
              <span class="text-sm text-white" id="order-tax">
                {{ order.tax_cents|cents_to_currency|romanian_currency:order.currency }}
              </span>
            </div>
            <div class="flex items-center justify-between border-t border-slate-700 pt-1">
              <span class="text-base font-semibold text-white">{% trans "Total:" %}</span>
              <span class="text-base font-semibold text-white" id="order-total">
                {{ order.total_cents|cents_to_currency|romanian_currency:order.currency }}
              </span>
            </div>
            <div class="text-xs text-slate-500 flex items-center justify-end">
              <span class="mr-1">🇷🇴</span>
              {% trans "Romanian VAT compliant" %}
            </div>
          </div>
        </div>
      </div>
      
      {% comment %}Add Item Section for Edit Mode{% endcomment %}
      {% if request.resolver_match.url_name == 'order_edit' and order.status in "draft,pending" %}
      <div class="px-6 py-4 bg-slate-900 border-t border-slate-700">
        <div class="flex items-center justify-between">
          <div>
            <h4 class="text-sm font-medium text-white">{% trans "Add New Item" %}</h4>
            <p class="text-xs text-slate-400">{% trans "Add products or services to this order" %}</p>
          </div>
          <div id="add-item-container">
            <button type="button"
                    onclick="toggleAddItemForm()"
                    id="add-item-btn"
                    class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-lg border border-green-600 text-green-400 hover:bg-green-600 hover:text-white transition-colors">
              <span class="mr-1">➕</span> {% trans "Add Item" %}
            </button>
          </div>
        </div>
        
        {% comment %}Expandable Add Item Form{% endcomment %}
        <div id="add-item-form-section" class="hidden mt-4 pt-4 border-t border-slate-700">
          <div class="bg-slate-800 rounded-lg border border-slate-600 p-4">
            <div class="flex items-center justify-between mb-4">
              <h4 class="text-sm font-medium text-white">
                <span class="mr-2">➕</span>{% trans "Add New Item" %}
              </h4>
              <button type="button"
                      onclick="cancelAddItemForm()"
                      class="text-slate-400 hover:text-white text-sm">
                <span class="mr-1">❌</span>{% trans "Cancel" %}
              </button>
            </div>
            
            <div id="add-item-form-container" class="space-y-4">
              {% comment %}Form will be loaded here{% endcomment %}
              <div class="flex items-center justify-center py-4">
                <div class="animate-spin rounded-full h-6 w-6 border-2 border-green-500 border-t-transparent"></div>
                <span class="ml-2 text-sm text-slate-400">{% trans "Loading form..." %}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    {% else %}
      <div class="p-6 text-center text-slate-400">
        <div class="mb-4">
          <span class="text-4xl">📦</span>
        </div>
        <p class="text-lg font-medium mb-2">{% trans "No items in this order yet" %}</p>
        <p class="text-sm">{% trans "Order items will appear here once added" %}</p>
        {% if request.resolver_match.url_name == 'order_edit' and order.status in "draft,pending" %}
          <div class="mt-4">
            <button type="button"
                    onclick="toggleAddItemForm()"
                    class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700 focus:ring-2 focus:ring-blue-500">
              <span class="mr-1">➕</span> {% trans "Add First Item" %}
            </button>
          </div>
        {% endif %}
      </div>
      
      {% comment %}Add Item Form Section for Empty State{% endcomment %}
      {% if request.resolver_match.url_name == 'order_edit' and order.status in "draft,pending" %}
      <div id="add-item-form-section-empty" class="hidden p-6 border-t border-slate-700">
        <div class="bg-slate-800 rounded-lg border border-slate-600 p-4">
          <div class="flex items-center justify-between mb-4">
            <h4 class="text-sm font-medium text-white">
              <span class="mr-2">➕</span>{% trans "Add First Item" %}
            </h4>
            <button type="button"
                    onclick="cancelAddItemForm()"
                    class="text-slate-400 hover:text-white text-sm">
              <span class="mr-1">❌</span>{% trans "Cancel" %}
            </button>
          </div>
          
          <div id="add-item-form-container-empty" class="space-y-4">
            {% comment %}Form will be loaded here{% endcomment %}
            <div class="flex items-center justify-center py-4">
              <div class="animate-spin rounded-full h-6 w-6 border-2 border-green-500 border-t-transparent"></div>
              <span class="ml-2 text-sm text-slate-400">{% trans "Loading form..." %}</span>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    {% endif %}
  </div>
</div>

{% comment %}
Modal templates removed - using expandable row pattern instead for better UX
Modals are now only used for the original order detail view (read-only mode)
Edit mode uses inline expandable forms for better context preservation
{% endcomment %}

<script>
// ===============================================================================
// EXPANDABLE ROW PATTERN FOR ORDER ITEMS - PRAHO Platform
// ===============================================================================

// Global state for tracking open edit forms
let activeEditRowId = null;

// Toggle expandable edit form for order items
function toggleExpandableEdit(itemId) {
    const editRow = document.getElementById(`edit-row-${itemId}`);
    const editBtn = document.getElementById(`edit-btn-${itemId}`);
    const formContainer = document.getElementById(`inline-edit-form-${itemId}`);
    
    if (!editRow || !editBtn || !formContainer) {
        console.error('Required elements not found for item', itemId);
        return;
    }
    
    // If there's already an active edit row, close it first
    if (activeEditRowId && activeEditRowId !== itemId) {
        cancelExpandableEdit(activeEditRowId);
    }
    
    if (editRow.classList.contains('hidden')) {
        // Show the edit row
        editRow.classList.remove('hidden');
        editBtn.innerHTML = '<span class="mr-1">📝</span> {% trans "Editing..." %}';
        editBtn.disabled = true;
        activeEditRowId = itemId;
        
        // Load the edit form via HTMX
        fetch(`/app/orders/{{ order.id }}/items/${itemId}/edit/`, {
            method: 'GET',
            headers: {
                'HX-Request': 'true',
                'X-Requested-With': 'XMLHttpRequest'
            }
        }).then(response => response.text())
        .then(html => {
            formContainer.innerHTML = html;
            // Focus on first input field for better UX
            const firstInput = formContainer.querySelector('input, select, textarea');
            if (firstInput) {
                firstInput.focus();
            }
        }).catch(error => {
            console.error('Error loading edit form:', error);
            formContainer.innerHTML = `
                <div class="text-center text-red-400 py-4">
                    <span class="mr-2">❌</span>{% trans "Error loading edit form. Please try again." %}
                </div>
            `;
            editBtn.innerHTML = '<span class="mr-1">✏️</span> {% trans "Edit" %}';
            editBtn.disabled = false;
        });
    } else {
        // Hide the edit row
        cancelExpandableEdit(itemId);
    }
}

// Cancel expandable edit
function cancelExpandableEdit(itemId) {
    const editRow = document.getElementById(`edit-row-${itemId}`);
    const editBtn = document.getElementById(`edit-btn-${itemId}`);
    
    if (editRow) {
        editRow.classList.add('hidden');
    }
    if (editBtn) {
        editBtn.innerHTML = '<span class="mr-1">✏️</span> {% trans "Edit" %}';
        editBtn.disabled = false;
    }
    
    if (activeEditRowId === itemId) {
        activeEditRowId = null;
    }
}

// Toggle Add Item form
function toggleAddItemForm() {
    const formSection = document.getElementById('add-item-form-section') || document.getElementById('add-item-form-section-empty');
    const addButton = document.getElementById('add-item-btn') || document.querySelector('button[onclick="toggleAddItemForm()"]');
    const formContainer = document.getElementById('add-item-form-container') || document.getElementById('add-item-form-container-empty');
    
    if (!formSection || !formContainer) {
        console.error('Add item form elements not found');
        return;
    }
    
    if (formSection.classList.contains('hidden')) {
        // Show the add form
        formSection.classList.remove('hidden');
        if (addButton) {
            addButton.innerHTML = '<span class="mr-1">⏳</span> {% trans "Loading..." %}';
            addButton.disabled = true;
        }
        
        // Load the add form via HTMX
        fetch(`/app/orders/{{ order.id }}/items/add/`, {
            method: 'GET',
            headers: {
                'HX-Request': 'true',
                'X-Requested-With': 'XMLHttpRequest'
            }
        }).then(response => response.text())
        .then(html => {
            formContainer.innerHTML = html;
            // Focus on first input field
            const firstInput = formContainer.querySelector('input, select, textarea');
            if (firstInput) {
                firstInput.focus();
            }
        }).catch(error => {
            console.error('Error loading add form:', error);
            formContainer.innerHTML = `
                <div class="text-center text-red-400 py-4">
                    <span class="mr-2">❌</span>{% trans "Error loading form. Please try again." %}
                </div>
            `;
            if (addButton) {
                addButton.innerHTML = '<span class="mr-1">➕</span> {% trans "Add Item" %}';
                addButton.disabled = false;
            }
        });
    } else {
        // Hide the add form
        cancelAddItemForm();
    }
}

// Cancel Add Item form
function cancelAddItemForm() {
    const formSection = document.getElementById('add-item-form-section') || document.getElementById('add-item-form-section-empty');
    const addButton = document.getElementById('add-item-btn') || document.querySelector('button[onclick="toggleAddItemForm()"]');
    
    if (formSection) {
        formSection.classList.add('hidden');
    }
    if (addButton) {
        addButton.innerHTML = '<span class="mr-1">➕</span> {% trans "Add Item" %}';
        addButton.disabled = false;
    }
}

// Delete Item with confirmation
function deleteOrderItem(itemId) {
    if (!confirm('{% trans "Are you sure you want to delete this item? This action cannot be undone." %}')) {
        return;
    }
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                     document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    
    if (!csrfToken) {
        console.error('CSRF token not found');
        alert('{% trans "Security token not found. Please refresh the page and try again." %}');
        return;
    }
    
    fetch(`/app/orders/{{ order.id }}/items/${itemId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/x-www-form-urlencoded'
        }
    }).then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove the item row and its edit row
            const itemRow = document.getElementById(`order-item-${itemId}`);
            const editRow = document.getElementById(`edit-row-${itemId}`);
            
            if (itemRow) itemRow.remove();
            if (editRow) editRow.remove();
            
            // Update totals without refreshing entire section
            updateOrderTotals();
            
            // Clean up active edit state if this item was being edited
            if (activeEditRowId === itemId) {
                activeEditRowId = null;
            }
            
            // Show success message
            showNotification('success', `{% trans "Item deleted successfully" %}`);
        } else {
            alert('{% trans "Error:" %} ' + (data.error || '{% trans "Unknown error occurred" %}'));
        }
    }).catch(error => {
        console.error('Error deleting item:', error);
        alert('{% trans "Error deleting item. Please try again." %}');
    });
}

// Refresh the entire order items section
function refreshOrderItemsSection() {
    const orderItemsSection = document.getElementById('order-items-section');
    if (!orderItemsSection) return;
    
    fetch(`/app/orders/{{ order.id }}/items/`, {
        method: 'GET',
        headers: {
            'HX-Request': 'true',
            'X-Requested-With': 'XMLHttpRequest'
        }
    }).then(response => response.text())
    .then(html => {
        orderItemsSection.outerHTML = html;
        // Also refresh financial summary if it exists
        refreshFinancialSummary();
    }).catch(error => {
        console.error('Error refreshing order items:', error);
    });
}

// Smart refresh that preserves JavaScript state by only updating table content
function refreshOrderItemsSmart() {
    const tableBody = document.querySelector('#order-items-section tbody');
    if (!tableBody) {
        // Fallback to full refresh if table structure not found
        refreshOrderItemsSection();
        return;
    }
    
    fetch(`/app/orders/{{ order.id }}/items/`, {
        method: 'GET',
        headers: {
            'HX-Request': 'true',
            'X-Requested-With': 'XMLHttpRequest'
        }
    }).then(response => response.text())
    .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newTableBody = doc.querySelector('#order-items-section tbody');
        
        if (newTableBody) {
            // Replace only the table body content, preserving the outer structure
            tableBody.innerHTML = newTableBody.innerHTML;
        } else {
            // Fallback to full refresh if parsing fails
            refreshOrderItemsSection();
        }
        
        // Update totals
        updateOrderTotals();
    }).catch(error => {
        console.error('Error smart refreshing order items:', error);
        // Fallback to full refresh on error
        refreshOrderItemsSection();
    });
}

// Update order totals without refreshing entire section
function updateOrderTotals() {
    // Fetch updated order totals from server
    fetch(`/app/orders/{{ order.id }}/items/`, {
        method: 'GET',
        headers: {
            'HX-Request': 'true',
            'X-Requested-With': 'XMLHttpRequest'
        }
    }).then(response => response.text())
    .then(html => {
        // Extract just the totals from the response
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Update individual total elements
        const newSubtotal = doc.getElementById('order-subtotal');
        const newTax = doc.getElementById('order-tax');
        const newTotal = doc.getElementById('order-total');
        
        const currentSubtotal = document.getElementById('order-subtotal');
        const currentTax = document.getElementById('order-tax');
        const currentTotal = document.getElementById('order-total');
        
        if (newSubtotal && currentSubtotal) {
            currentSubtotal.textContent = newSubtotal.textContent;
        }
        if (newTax && currentTax) {
            currentTax.textContent = newTax.textContent;
        }
        if (newTotal && currentTotal) {
            currentTotal.textContent = newTotal.textContent;
        }
        
        // Also refresh the financial summary sidebar if it exists
        refreshFinancialSummary();
    }).catch(error => {
        console.error('Error updating order totals:', error);
    });
}

// Refresh financial summary
function refreshFinancialSummary() {
    const financialSummary = document.getElementById('financial-summary');
    if (!financialSummary) return;
    
    // Fetch updated financial summary from server
    fetch(`/app/orders/{{ order.id }}/`, {
        method: 'GET',
        headers: {
            'HX-Request': 'true',
            'HX-Target': 'financial-summary',
            'X-Requested-With': 'XMLHttpRequest'
        }
    }).then(response => response.text())
    .then(html => {
        // Extract just the financial summary from the response
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newFinancialSummary = doc.getElementById('financial-summary');
        if (newFinancialSummary && financialSummary) {
            financialSummary.outerHTML = newFinancialSummary.outerHTML;
        }
    }).catch(error => {
        console.error('Error refreshing financial summary:', error);
    });
}

// Show notification (utility function)
function showNotification(type, message) {
    // Simple notification - could be enhanced with a toast system
    if (type === 'success') {
        // For now, use a simple approach - could be enhanced later
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-opacity';
        notification.innerHTML = `<span class="mr-2">✅</span>${message}`;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
}

// Handle form submissions from expandable rows
document.addEventListener('submit', function(e) {
    const form = e.target;
    
    // Check if this is an order item form (add or edit)
    if (form.action.includes('/items/') && (form.action.includes('/add/') || form.action.includes('/edit/'))) {
        e.preventDefault();
        
        const formData = new FormData(form);
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'HX-Request': 'true',
                'X-Requested-With': 'XMLHttpRequest'
            }
        }).then(response => response.text())
        .then(html => {
            // Check if response contains errors (forms with errors will be returned)
            if (html.includes('error') || html.includes('<form')) {
                // Update the form container with the error form
                const formContainer = form.closest('[id*="form-container"]');
                if (formContainer) {
                    formContainer.innerHTML = html;
                }
            } else {
                // Success - update totals and refresh the specific section
                updateOrderTotals();
                
                // Close any open forms
                cancelAddItemForm();
                if (activeEditRowId) {
                    cancelExpandableEdit(activeEditRowId);
                }
                
                // For new items or edits, we need to refresh to show the updated item
                // But use a targeted approach that preserves JavaScript state
                setTimeout(() => {
                    refreshOrderItemsSmart();
                }, 100);
                
                // Show success message
                showNotification('success', '{% trans "Item saved successfully" %}');
            }
        }).catch(error => {
            console.error('Form submission error:', error);
            alert('{% trans "Error submitting form. Please try again." %}');
        });
    }
});

// Keyboard shortcuts for better UX
document.addEventListener('keydown', function(e) {
    // ESC key closes open forms
    if (e.key === 'Escape') {
        if (activeEditRowId) {
            cancelExpandableEdit(activeEditRowId);
        }
        
        const addFormSection = document.getElementById('add-item-form-section') || document.getElementById('add-item-form-section-empty');
        if (addFormSection && !addFormSection.classList.contains('hidden')) {
            cancelAddItemForm();
        }
    }
});

// Initialize expandable row system when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 [Orders] Expandable row system initialized');
});
</script>