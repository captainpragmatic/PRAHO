{% extends "base.html" %}
{% load i18n %}
{% load ui_components %}

{% block title %}{% trans "Add Price" %}: {{ product.name }} - PRAHO Platform{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8 max-w-4xl mx-auto">
  <!-- Header -->
  <div class="mb-6">
    <div class="flex items-center space-x-2 text-sm text-slate-400 mb-2">
      <a href="{% url 'products:product_list' %}" class="hover:text-blue-400">{% trans 'Products' %}</a>
      <span>‚Ä¢</span>
      <a href="{% url 'products:product_detail' slug=product.slug %}" class="hover:text-blue-400">{{ product.name }}</a>
      <span>‚Ä¢</span>
      <a href="{% url 'products:product_prices' slug=product.slug %}" class="hover:text-blue-400">{% trans 'Pricing' %}</a>
      <span>‚Ä¢</span>
      <span>{% trans 'Add Price' %}</span>
    </div>
    <h1 class="text-3xl font-bold text-white">
      üí∞ {% trans "Add New Price" %}
    </h1>
    <p class="mt-2 text-slate-400">
      {% trans "Configure pricing for" %} {{ product.name }}
    </p>
  </div>

  <!-- Romanian Business Context -->
  <div class="bg-blue-900 border border-blue-700 rounded-lg p-4 mb-6">
    <div class="flex items-start">
      <div class="flex-shrink-0">
        <span class="text-blue-300 text-xl">üá∑üá¥</span>
      </div>
      <div class="ml-3">
        <h3 class="text-sm font-medium text-blue-200">{% trans 'Romanian Business Pricing' %}</h3>
        <div class="mt-1 text-sm text-blue-300">
          <p>{% trans 'Product VAT setting:' %}
            {% if product.includes_vat %}
              <span class="text-green-300 font-medium">{% trans 'Prices include 19% VAT' %}</span>
              <br>{% trans 'Enter the final price including VAT. System will calculate base price for e-Factura.' %}
            {% else %}
              <span class="text-yellow-300 font-medium">{% trans 'Prices exclude VAT' %}</span>
              <br>{% trans 'Enter the base price. 19% VAT will be added for Romanian customers.' %}
            {% endif %}
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Form -->
  <form method="POST" class="space-y-6">
    {% csrf_token %}
    
    <!-- Basic Pricing -->
    <div class="bg-slate-800 rounded-lg border border-slate-700 p-6">
      <h2 class="text-xl font-semibold text-white mb-6">üí∞ {% trans 'Basic Pricing' %}</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Currency -->
        <div>
          {% input_field "currency" input_type="select" label="Currency" html_id="id_currency" placeholder="Select currency" required=True options=currency_options value=form.currency.value help_text="RON recommended for Romanian customers" error=form.currency.errors.0 %}
        </div>

        <!-- Billing Period -->
        <div>
          {% input_field "billing_period" input_type="select" label="Billing Period" html_id="id_billing_period" placeholder="Select billing period" required=True options=billing_period_options value=form.billing_period.value help_text="How often customer is billed" error=form.billing_period.errors.0 %}
        </div>

        <!-- Amount (in cents) -->
        <div>
          {% input_field "amount_cents" input_type="number" label="Price (in cents)" html_id="id_amount_cents" placeholder="2999" required=True value=form.amount_cents.value help_text="Enter price in cents (e.g., 2999 for 29.99). Avoids decimal precision issues." error=form.amount_cents.errors.0 %}
        </div>

        <!-- Setup Fee (in cents) -->
        <div>
          {% input_field "setup_cents" input_type="number" label="Setup Fee (in cents)" html_id="id_setup_cents" placeholder="0" value=form.setup_cents.value|default:"0" help_text="One-time setup fee (0 for none)" error=form.setup_cents.errors.0 %}
        </div>
      </div>
    </div>

    <!-- Quantity Limits -->
    <div class="bg-slate-800 rounded-lg border border-slate-700 p-6">
      <h2 class="text-xl font-semibold text-white mb-6">üìä {% trans 'Quantity Limits' %}</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Minimum Quantity -->
        <div>
          {% input_field "minimum_quantity" input_type="number" label="Minimum Quantity" html_id="id_minimum_quantity" placeholder="1" value=form.minimum_quantity.value|default:"1" help_text="Minimum quantity that can be ordered" error=form.minimum_quantity.errors.0 %}
        </div>

        <!-- Maximum Quantity -->
        <div>
          {% input_field "maximum_quantity" input_type="number" label="Maximum Quantity" html_id="id_maximum_quantity" placeholder="" value=form.maximum_quantity.value help_text="Maximum quantity (blank for unlimited)" error=form.maximum_quantity.errors.0 %}
        </div>

        <!-- Discount Percentage -->
        <div class="md:col-span-2">
          {% input_field "discount_percent" input_type="number" label="Discount Percentage" html_id="id_discount_percent" placeholder="0" min=0 max=100 value=form.discount_percent.value|default:"0" help_text="Optional discount percentage (0-100)" error=form.discount_percent.errors.0 %}
        </div>
      </div>
    </div>

    <!-- Promotional Pricing -->
    <div class="bg-slate-800 rounded-lg border border-slate-700 p-6">
      <h2 class="text-xl font-semibold text-white mb-6">üéâ {% trans 'Promotional Pricing' %}</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Promo Price -->
        <div>
          {% input_field "promo_price_cents" input_type="number" label="Promotional Price (in cents)" html_id="id_promo_price_cents" placeholder="1999" value=form.promo_price_cents.value help_text="Special promotional price (leave blank for none)" error=form.promo_price_cents.errors.0 %}
        </div>

        <!-- Promo Valid Until -->
        <div>
          {% input_field "promo_valid_until" input_type="date" label="Promotion Valid Until" html_id="id_promo_valid_until" value=form.promo_valid_until.value help_text="When the promotional pricing expires" error=form.promo_valid_until.errors.0 %}
        </div>
      </div>
      
      <div class="mt-4 p-3 bg-yellow-900 border border-yellow-700 rounded-lg">
        <div class="flex items-start">
          <span class="text-yellow-300 mr-2">‚ö†Ô∏è</span>
          <div class="text-sm text-yellow-200">
            {% trans 'Promotional pricing will automatically revert to regular pricing after the expiration date.' %}
          </div>
        </div>
      </div>
    </div>

    <!-- Status -->
    <div class="bg-slate-800 rounded-lg border border-slate-700 p-6">
      <h2 class="text-xl font-semibold text-white mb-6">‚öôÔ∏è {% trans 'Status' %}</h2>
      
      {% checkbox_field "is_active" label="Active (available for ordering)" html_id="id_is_active" checked=form.is_active.value help_text="Inactive prices are not shown to customers" %}
    </div>

    <!-- Form Actions -->
    <div class="flex justify-end space-x-3">
      <a href="{% url 'products:product_prices' slug=product.slug %}" 
         class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-md font-medium transition-colors">
        ‚ùå {% trans 'Cancel' %}
      </a>
      {% button "üí∞ Add Price" variant="primary" type="submit" %}
    </div>
  </form>
</div>

<script>
// Price calculator helper
document.addEventListener('DOMContentLoaded', function() {
    const amountInput = document.getElementById('id_amount_cents');
    const setupInput = document.getElementById('id_setup_cents');
    const promoInput = document.getElementById('id_promo_price_cents');
    
    function addCentsHelper(input) {
        if (!input) return;
        
        const helper = document.createElement('div');
        helper.className = 'text-xs text-slate-400 mt-1';
        helper.id = input.id + '_helper';
        
        input.parentNode.insertBefore(helper, input.nextSibling);
        
        input.addEventListener('input', function() {
            const cents = parseInt(this.value) || 0;
            const currency = cents / 100;
            helper.textContent = `‚âà ${currency.toFixed(2)} (${currency} units)`;
        });
        
        // Initial calculation
        input.dispatchEvent(new Event('input'));
    }
    
    addCentsHelper(amountInput);
    addCentsHelper(setupInput);
    addCentsHelper(promoInput);
});
</script>
{% endblock %}