# ===============================================================================
# PLATFORM SERVICE CI/CD - FULL DJANGO WITH DATABASE
# ===============================================================================
# Managed with uv (https://docs.astral.sh/uv/) - See ADR-0013 for details

name: Platform Service CI/CD

on:
  push:
    branches: [ master, develop, 'feat/*', 'fix/*' ]
    paths:
      - 'services/platform/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.github/workflows/platform.yml'
  pull_request:
    branches: [ master, develop ]
    paths:
      - 'services/platform/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.github/workflows/platform.yml'

env:
  DJANGO_SETTINGS_MODULE: config.settings.test
  SECRET_KEY: test-secret-key-for-ci
  UV_PROJECT_ENVIRONMENT: ${{ github.workspace }}/.venv

jobs:
  platform-test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
          POSTGRES_USER: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install uv and sync dependencies
      uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"

    - name: Set up Python and install dependencies
      run: |
        uv python install
        uv sync --group platform --group dev

    - name: Run platform unit tests with coverage
      run: |
        cd services/platform
        echo "Running platform unit tests with coverage..."
        PYTHONPATH=$(pwd) ${{ github.workspace }}/.venv/bin/coverage run manage.py test tests --verbosity=2
        ${{ github.workspace }}/.venv/bin/coverage xml -o coverage-platform.xml
        COVERAGE_PCT=$(${{ github.workspace }}/.venv/bin/coverage report --format=total)
        echo "COVERAGE_PCT=${COVERAGE_PCT}" >> "$GITHUB_ENV"
        ${{ github.workspace }}/.venv/bin/coverage report --show-missing

    - name: Update coverage badge
      if: github.ref == 'refs/heads/master' && github.event_name == 'push'
      uses: schneegans/dynamic-badges-action@v1.7.0
      with:
        auth: ${{ secrets.GIST_TOKEN }}
        gistID: ${{ secrets.COVERAGE_GIST_ID }}
        filename: praho-coverage.json
        label: coverage
        message: "${{ env.COVERAGE_PCT }}%"
        valColorRange: ${{ env.COVERAGE_PCT }}
        minColorRange: 50
        maxColorRange: 90

    - name: Ruff no-new-debt gate (platform)
      run: |
        BASE_REF="${{ github.event.before }}"
        if [ -z "$BASE_REF" ] || [ "$BASE_REF" = "0000000000000000000000000000000000000000" ]; then
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
          else
            BASE_REF="HEAD~1"
          fi
        fi
        if ! git cat-file -e "${BASE_REF}^{commit}" 2>/dev/null; then
          echo "Baseline ref not present locally ($BASE_REF); fetching..."
          git fetch origin "${BASE_REF}" --depth=1 || true
        fi
        echo "Checking for newly introduced Ruff violations vs: $BASE_REF"
        ${{ github.workspace }}/.venv/bin/python scripts/ruff_new_violations.py \
          --baseline-ref "$BASE_REF" \
          --path-prefix services/platform

    - name: Lint platform code
      run: |
        cd services/platform
        echo "Running linting for platform service..."
        PYTHONPATH=$(pwd) ${{ github.workspace }}/.venv/bin/ruff check apps/ || echo "Linting completed with issues"

    - name: Upload platform artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: platform-reports
        path: |
          services/platform/htmlcov/
          services/platform/pytest_report.html
        if-no-files-found: warn

  platform-security:
    runs-on: ubuntu-latest
    needs: platform-test

    steps:
    - uses: actions/checkout@v4

    - name: Install uv and sync dependencies
      uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"

    - name: Set up Python and install dependencies
      run: |
        uv python install
        uv sync --group platform --group dev

    - name: Run Bandit SAST Security Scan
      run: |
        echo "Running Bandit security analysis..."
        cd services/platform
        ${{ github.workspace }}/.venv/bin/bandit -r apps/ -ll -ii --exclude '*/tests/*,*/test_*' -f txt || echo "Bandit scan completed with findings"

    - name: Upload Security Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          services/platform/bandit-report.json
        if-no-files-found: warn
